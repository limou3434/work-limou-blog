<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.140" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><meta property="og:url" content="https://limou3434.github.io/work-blog-website/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/4q3wan58/"><meta property="og:site_name" content="缡墨"><meta property="og:title" content="传输层"><meta property="og:description" content="1.端口号的基础 虽然我们前面的网络编程中，有用过端口号，但是实际上，应用层协议中的请求行中的端口号主要不是给自己使用的，而是传递给下层的传输层。因此再 UDP/TCP 的报头中会出现端口号的相关字段，我之后和您细谈... 不过这里我们还需要稍微补充一下端口号的一些其他基础知识，实际上有一些端口号的作用已经被默认规定好了，程序员在请求一些 IT 公司提..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-04-19T14:21:17.000Z"><meta property="article:modified_time" content="2025-04-19T14:21:17.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"传输层","image":[""],"dateModified":"2025-04-19T14:21:17.000Z","author":[]}</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>传输层 | 缡墨</title><meta name="description" content="1.端口号的基础 虽然我们前面的网络编程中，有用过端口号，但是实际上，应用层协议中的请求行中的端口号主要不是给自己使用的，而是传递给下层的传输层。因此再 UDP/TCP 的报头中会出现端口号的相关字段，我之后和您细谈... 不过这里我们还需要稍微补充一下端口号的一些其他基础知识，实际上有一些端口号的作用已经被默认规定好了，程序员在请求一些 IT 公司提..."><link rel="preload" href="/work-blog-website/assets/style-wRUVlp4M.css" as="style"><link rel="stylesheet" href="/work-blog-website/assets/style-wRUVlp4M.css"><link rel="modulepreload" href="/work-blog-website/assets/app-DcSFSDZX.js"><link rel="modulepreload" href="/work-blog-website/assets/index.html-GdCSYCmp.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-f64889e1><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-9670677b></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-9670677b> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-f64889e1 data-v-10dcbbec><div class="vp-navbar" vp-navbar data-v-10dcbbec data-v-1ff1b6bf><div class="wrapper" data-v-1ff1b6bf><div class="container" data-v-1ff1b6bf><div class="title" data-v-1ff1b6bf><div class="vp-navbar-title has-sidebar" data-v-1ff1b6bf data-v-f47c30ce><a class="vp-link no-icon link title" href="/work-blog-website/" data-v-f47c30ce data-v-a73080b7><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="/work-blog-website/./logo.svg" alt data-v-91c3d102><!--]--><!--[--><img class="vp-image light logo" style="" src="/work-blog-website/./logo.svg" alt data-v-91c3d102><!--]--><!--]--><!--]--><span data-v-f47c30ce>缡墨</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-1ff1b6bf><div class="content-body" data-v-1ff1b6bf><!--[--><!--]--><div class="vp-navbar-search search" data-v-1ff1b6bf><div class="search-wrapper" data-v-8da3ab7d><!----><div id="local-search" data-v-8da3ab7d><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-8da3ab7d><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-1ff1b6bf data-v-fe90eb91><span id="main-nav-aria-label" class="visually-hidden" data-v-fe90eb91>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/blog/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>博客</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/blog/tags/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/blog/archives/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>归档</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/1.%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>编程语言</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/2.%E6%95%B0%E6%9E%84%E7%AE%97%E6%B3%95/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>数构算法</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>系统网络</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-fe90eb91 data-v-69e03988><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-69e03988><span class="text" data-v-69e03988><!----><!----><span data-v-69e03988>存储持久</span><span class="vpi-chevron-down text-icon" data-v-69e03988></span></span></button><div class="menu" data-v-69e03988><div class="vp-menu" data-v-69e03988 data-v-23465237><div class="items" data-v-23465237><!--[--><!--[--><div class="vp-menu-link" data-v-23465237 data-v-d0632adc><a class="vp-link no-icon link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/4.%E6%8C%81%E4%B9%85%E5%AD%98%E5%82%A8/mysql/" data-v-d0632adc data-v-a73080b7><!--[--><!----> MySQL<!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-23465237 data-v-d0632adc><a class="vp-link no-icon link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/4.%E6%8C%81%E4%B9%85%E5%AD%98%E5%82%A8/redis/" data-v-d0632adc data-v-a73080b7><!--[--><!----> Redis<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/2.%E4%B8%9A%E5%8A%A1%E5%BC%80%E5%8F%91/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>业务开发</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/work-blog-website/3.%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" tabindex="0" data-v-fe90eb91 data-v-c87e8060 data-v-a73080b7><!--[--><!----><span data-v-c87e8060>机器学习</span><!--]--><!----></a><!--]--><!--]--></nav><!----><div class="vp-navbar-appearance appearance" data-v-1ff1b6bf data-v-77a749e7><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-77a749e7 data-v-065c5f28 data-v-f6a68fd3><span class="check" data-v-f6a68fd3><span class="icon" data-v-f6a68fd3><!--[--><span class="vpi-sun sun" data-v-065c5f28></span><span class="vpi-moon moon" data-v-065c5f28></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-1ff1b6bf data-v-7adb0edc data-v-ff0b2635><!--[--><a class="vp-social-link no-icon" href="https://github.com/limou3434" aria-label="github" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-github" /></a><a class="vp-social-link no-icon" href="https://x.com/3434Limou97685" aria-label="twitter" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-twitter" /></a><a class="vp-social-link no-icon" href="https://www.youtube.com/@3434limou" aria-label="youtube" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-youtube" /></a><a class="vp-social-link no-icon" href="https://space.bilibili.com/356662607?spm_id_from=333.1007.0.0" aria-label="bilibili" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-bilibili" /></a><a class="vp-social-link no-icon" href="https://www.zhihu.com/people/limou3434" aria-label="zhihu" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-zhihu" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-1ff1b6bf data-v-37498925 data-v-69e03988><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-69e03988><span class="vpi-more-horizontal icon" data-v-69e03988></span></button><div class="menu" data-v-69e03988><div class="vp-menu" data-v-69e03988 data-v-23465237><!----><!--[--><!--[--><!----><div class="group" data-v-37498925><div class="item appearance" data-v-37498925><p class="label" data-v-37498925>外观</p><div class="appearance-action" data-v-37498925><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-37498925 data-v-065c5f28 data-v-f6a68fd3><span class="check" data-v-f6a68fd3><span class="icon" data-v-f6a68fd3><!--[--><span class="vpi-sun sun" data-v-065c5f28></span><span class="vpi-moon moon" data-v-065c5f28></span><!--]--></span></span></button></div></div></div><div class="group" data-v-37498925><div class="item social-links" data-v-37498925><div class="vp-social-links social-links-list" data-v-37498925 data-v-ff0b2635><!--[--><a class="vp-social-link no-icon" href="https://github.com/limou3434" aria-label="github" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-github" /></a><a class="vp-social-link no-icon" href="https://x.com/3434Limou97685" aria-label="twitter" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-twitter" /></a><a class="vp-social-link no-icon" href="https://www.youtube.com/@3434limou" aria-label="youtube" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-youtube" /></a><a class="vp-social-link no-icon" href="https://space.bilibili.com/356662607?spm_id_from=333.1007.0.0" aria-label="bilibili" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-bilibili" /></a><a class="vp-social-link no-icon" href="https://www.zhihu.com/people/limou3434" aria-label="zhihu" target="_blank" rel="noopener" data-v-ff0b2635 data-v-2f8e5abd><span class="vpi-social-zhihu" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-1ff1b6bf data-v-7589b4f7><span class="container" data-v-7589b4f7><span class="top" data-v-7589b4f7></span><span class="middle" data-v-7589b4f7></span><span class="bottom" data-v-7589b4f7></span></span></button></div></div></div></div><div class="divider" data-v-1ff1b6bf><div class="divider-line" data-v-1ff1b6bf></div></div></div><!----></header><div class="vp-local-nav reached-top" data-v-f64889e1 data-v-ccb875be><button class="menu" aria-expanded="false" aria-controls="SidebarNav" data-v-ccb875be><span class="vpi-align-left menu-icon" data-v-ccb875be></span><span class="menu-text" data-v-ccb875be>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-ccb875be data-v-974e314a><button data-v-974e314a>返回顶部</button><!----></div></div><aside class="vp-sidebar" vp-sidebar data-v-f64889e1 data-v-b31792bb><div class="curtain" data-v-b31792bb></div><nav id="SidebarNav" class="nav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b31792bb><span id="sidebar-aria-label" class="visually-hidden" data-v-b31792bb> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-32127bb7><section class="vp-sidebar-item sidebar-item level-0 has-active" data-v-32127bb7 data-v-07605bc3><!----><div data-v-07605bc3 data-v-07605bc3><div class="items" data-v-07605bc3><!--[--><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>系统网络</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/adbi3n98/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>先导课程</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/nhjpj7o1/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>基本指令</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/g4zmcmi0/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>权限管理</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/pp91tz2s/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>编辑器</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/82sbxlhl/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>编译器</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/k1fkvi3c/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>调试器</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/5txmd1gw/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>构建器</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/8ck0qm2i/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>软件管理</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/b1tyyzew/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>进度条程序</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/01ta8n80/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>脚本编程</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/okgrdzg4/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>进程基础</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/cpg60x70/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>环境变量</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/1vogsfkk/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>简易外核</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/spnggbc7/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>磁盘内存</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/4uilxc2v/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>进程通信</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/11ccm048/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>线程开发</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/25ehjxls/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>进程信号</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/z1wywjm1/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>常驻服务</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/2w24bhws/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>网络基础</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/v510ifxo/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>网络编程</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/u9tjrmxs/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>应用层</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/4q3wan58/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>传输层</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/dh22vht2/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>网络层</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/jxzz8513/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>链路层</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/aen10afj/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>物理层</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/7ecvjong/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>其他协议</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/gduhb6so/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>高级 IO</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/l4vcsl0a/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>网络配置</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/v3w6hfe3/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>URL 过程</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/tqi8br7j/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>网络应用演变</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/tgphl3fd/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>版本管理软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/xyzxfhq8/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>远程链接软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/3hoxlbkl/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>内网穿透软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/nl7c2cx1/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>服务管理软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/oqw8t109/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>终端优化软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/n6jvjmt5/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>服务程序软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/tsuvkv27/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>项目部署软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/ukh43e1q/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>容器隔离软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/aj3d1vq7/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>集群管理软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/5567ctbx/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>现代指令软件</p><!--]--><!----></a><!----></div><!----></div><div class="vp-sidebar-item sidebar-item level-1 is-link" data-v-07605bc3 data-v-07605bc3><div class="item" data-v-07605bc3><div class="indicator" data-v-07605bc3></div><!----><a class="vp-link no-icon link link" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/jr06k8rr/" data-v-07605bc3 data-v-a73080b7><!--[--><p class="text" data-v-07605bc3>面板管理管理</p><!--]--><!----></a><!----></div><!----></div><!--]--></div></div></section></div><!--]--><!--[--><!--]--></nav></aside><!--[--><div id="VPContent" vp-content class="vp-content has-sidebar" data-v-f64889e1 data-v-b8e80d86><div class="vp-doc-container has-sidebar has-aside" data-v-b8e80d86 data-v-eccffa44><!--[--><!--]--><div class="container" data-v-eccffa44><div class="aside" vp-outline data-v-eccffa44><div class="aside-curtain" data-v-eccffa44></div><div class="aside-container" data-v-eccffa44><div class="aside-content" data-v-eccffa44><div class="vp-doc-aside" data-v-eccffa44 data-v-55f15f28><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="vp-doc-aside-outline" role="navigation" data-v-55f15f28 data-v-6293d33c><div class="content" data-v-6293d33c><div class="outline-marker" data-v-6293d33c></div><div id="doc-outline-aria-label" aria-level="2" class="outline-title" role="heading" data-v-6293d33c><span data-v-6293d33c>此页内容</span><span class="vpi-print icon" data-v-6293d33c></span></div><ul class="root" data-v-6293d33c data-v-ab5fb2ff><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-55f15f28></div><!--[--><!--]--></div></div></div></div><div class="content" data-v-eccffa44><div class="content-container" data-v-eccffa44><!--[--><!--]--><main class="main" data-v-eccffa44><nav class="vp-breadcrumb" data-v-eccffa44 data-v-7f0052b8><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-7f0052b8><!--[--><li property="itemListElement" typeof="ListItem" data-v-7f0052b8><a class="vp-link no-icon link breadcrumb" href="/work-blog-website/" property="item" typeof="WebPage" data-v-7f0052b8 data-v-a73080b7><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-7f0052b8></span><meta property="name" content="首页" data-v-7f0052b8><meta property="position" content="1" data-v-7f0052b8></li><li property="itemListElement" typeof="ListItem" data-v-7f0052b8><a class="vp-link no-icon link breadcrumb current" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/4q3wan58/" property="item" typeof="WebPage" data-v-7f0052b8 data-v-a73080b7><!--[-->传输层<!--]--><!----></a><!----><meta property="name" content="传输层" data-v-7f0052b8><meta property="position" content="2" data-v-7f0052b8></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-2065b01c>传输层 <!----></h1><div class="vp-doc-meta" data-v-2065b01c><p class="reading-time" data-v-2065b01c><span class="vpi-books icon" data-v-2065b01c></span><span data-v-2065b01c>约 18040 字</span><span data-v-2065b01c>大约 60 分钟</span></p><!----><p class="create-time" data-v-2065b01c><span class="vpi-clock icon" data-v-2065b01c></span><span data-v-2065b01c>2025-04-09</span></p></div><!--]--><div class="_1_%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB_3_%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C_4q3wan58_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-eccffa44><div data-v-eccffa44><h2 id="_1-端口号的基础" tabindex="-1"><a class="header-anchor" href="#_1-端口号的基础"><span>1.端口号的基础</span></a></h2><p>虽然我们前面的网络编程中，有用过端口号，但是实际上，应用层协议中的请求行中的端口号主要不是给自己使用的，而是传递给下层的传输层。因此再 <code>UDP/TCP</code> 的报头中会出现端口号的相关字段，我之后和您细谈...</p><p>不过这里我们还需要稍微补充一下端口号的一些其他基础知识，实际上有一些端口号的作用已经被默认规定好了，程序员在请求一些 <code>IT</code> 公司提供的网络 <code>API</code> 时，也大概能猜出该公司提供域名的不同端口对应的作用，大致如下：</p><ol><li><p><strong>系统端口(Well-Known Ports)</strong>：<code>0</code> 到 <code>1023</code>，这些端口号通常用于一些常见的服务</p><table><thead><tr><th>服务</th><th>端口号</th></tr></thead><tbody><tr><td>SSH</td><td>22</td></tr><tr><td>HTTP</td><td>80</td></tr><tr><td>HTTPS</td><td>443</td></tr><tr><td>ftp</td><td>21</td></tr><tr><td>Telnet</td><td>23</td></tr><tr><td>SMTP</td><td>25</td></tr><tr><td>POP3</td><td>110</td></tr><tr><td>IMAP</td><td>143</td></tr><tr><td>DNS</td><td>53</td></tr><tr><td>SMB</td><td>445</td></tr><tr><td>NFS</td><td>204</td></tr></tbody></table></li><li><p><strong>注册端口(Registered Ports)</strong>：<code>1024</code> 到 <code>49151</code>，这些端口号用于用户定义的服务或应用程序，需要经过 <code>IANA</code> 注册。</p></li><li><p><strong>动态端口/私有端口(Dynamic Ports/Private Ports)</strong>：<code>49152</code> 到 <code>65535</code>，这些端口号用于客户端和服务端之间的动态分配，通常不固定于特定的应用程序或服务。</p></li></ol><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：可以使用 <code>cat /etc/services</code> 查看这些端口号。</p></div><h2 id="_2-传输层两协议" tabindex="-1"><a class="header-anchor" href="#_2-传输层两协议"><span>2.传输层两协议</span></a></h2><p>从应用层往下开始的传输层会更加原生，应用层的用户直接使用接口完成对应的服务（主要的工作就是字符传输），而传输层上下都有协议，因此必须解决两个问题：(1)如何向上分离 (2)如何向下交付。</p><p>另外，也不要忘记我们传输层的目标：<strong>提供端到端的通信服务，确保一定程度上可靠的数据传输，并且解决核心三个问题，要发多少、什么时候发、丢失了怎么办</strong>。</p><div class="hint-container caution"><p class="hint-container-title">警告</p><p>警告：本文的“本端”和“对端”两个用词，仅仅是相对概念，根据上下文来判断是否为服务端或者客户端，亦或者两种角色都有可能...</p></div><h3 id="_2-1-udp-协议" tabindex="-1"><a class="header-anchor" href="#_2-1-udp-协议"><span>2.1.UDP 协议</span></a></h3><h4 id="_2-1-1-协议结构" tabindex="-1"><a class="header-anchor" href="#_2-1-1-协议结构"><span>2.1.1.协议结构</span></a></h4><p><code>udp</code> 协议结构如下。</p><figure><img src="/work-blog-website/assets/1715505336663-BuU17HIi.jpg" alt="1715505336663" tabindex="0" loading="lazy"><figcaption>1715505336663</figcaption></figure><ul><li><code>16</code> 位源端口号和 <code>16</code> 位目的端口号比较容易理解，就是填写应用层中涉及到了服务端和用户端的端口号，正好就是 <code>uint16_t</code> 类型</li><li><code>16</code> 位 <code>udp</code> 长度的就是描述整个 <code>udp</code> 报文的长度，注意不是正文数据的长度，单位是字节</li><li><code>16</code> 位 <code>udp</code> 校验和主要时检查比特位是否被翻转的问题，检查数据是否在传输过程中发生错乱</li><li>正文数据就是应用层传递过来的应用层报文，例如 <code>http/https</code> 报文</li></ul><h4 id="_2-1-2-封装分离" tabindex="-1"><a class="header-anchor" href="#_2-1-2-封装分离"><span>2.1.2.封装分离</span></a></h4><p>我们先来理解 <code>udp</code> 报文的封装和分离过程。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="cpp" style="--vp-collapsed-lines:15;--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 头部和正文的封装过程(32 位下)</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// -- server 端 --</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 头部结构</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> UdpHdr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	uint16_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _srcPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	uint16_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _dstPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	uint16_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _udpLen</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	uint16_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _udpCheck</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">  </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 正文结构</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> UdpCon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 一系列数据, 其实就是应用层报文</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    type _data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// UDP 结构</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> Udp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    UdpHdr hdr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 头部 </span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    UdpCon con</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 正文</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Udp aUdp </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _srcPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">...</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _dstPort</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">...</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _conLen</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">...</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _udpCheck</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">... </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">},</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> _data </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">...</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div></details><p><code>udp</code> 报文包装好后向下交付协议栈，直到发送给对端，对端接受到后，进行如下的解析工作。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 头部和正文的分离过程(32 位下)</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// -- client 端 --</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Udp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> newUdp </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">aUdp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 接受到 aUdp 后如下步骤进行解析</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">uint16_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> len </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> newUdp</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">_udpLen</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 先获取整个 udp 报文的长度</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">UdpCon newCon </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">((</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">char*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">newUdp </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">uint16_t</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // sizeof(uint16_t) * 4 刚好是 8 byte, 此时 newUdp 指针根据 char* 类型跳过 8 个字节时, 正好指向正文内容的开头</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">read</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">newCon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> len </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">uint16_t</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> *</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 这个 read() 只是伪代码, 需要传递指向正文开始的指针和正文的总字节长度, 然后在内部进行读取, 就可以读取到所有的正文信息</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>此时通过 <code>read()</code> 就得到了对端应用层的数据，然后交付给本段的上层应用层进行业务处理。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>注意：所有的协议封装和分离过程都和上述过程类似，包括之前我们使用 <code>http</code> 开发中对 <code>http</code> 做解析的工作，因此后续的相关解析工作我一句带过，不再细讲...</p></div><p><code>udp</code> 固定头部长度为 <code>8 byte</code>，因此可以读取到的 <code>udp</code> 报文 <code>&lt; 8 byte</code> 时，就可以检查出 <code>udp</code> 读取不全，此时就会直接丢弃（具体要看实现）。</p><p>而如果读取到了 <code>&gt;= 8 byte</code> 的头部数据后，就可以读取内部的 <code>udp</code> 报文长度，进而得到一整个报文该有的长度 <code>len</code>。此时就可以检测 <code>udp</code> 报文是否完整。如果此时和读取到的实际报文长度 <code>&lt; len</code>，就可以发现 <code>udp</code> 报文是不完整的，进而采取直接丢弃的策略。</p><p>因此我们可以说 <code>udp</code> 报文是面向整个数据报的，每次传输都可以保证是一个完整的数据报，因此对应上层的套接字编程就会非常的简单。</p><h4 id="_2-1-3-报文管理" tabindex="-1"><a class="header-anchor" href="#_2-1-3-报文管理"><span>2.1.3.报文管理</span></a></h4><p>不过，如果从更加具体实现的角度来看，大量的报文就需要被管理，而管理就需要先做描述，这就会涉及到 <code>sk_buff</code> 结构体，我们简单演示一下一些字段。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// 报文管理</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> skb_buff</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 指向大缓冲区中的某个地址 addr</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    char*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> tail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 指向大缓冲区中的某个地址 addr</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sk_buff</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> next</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>把数据拷贝到缓冲区中，<code>tail</code> 指针根据数据的字节数进行挪动，此时正文数据就被保存在缓冲区中。而需要添加报头时，做 <code>data</code> 指针的减操作，把填充好的头部填充进此时的 <code>data</code> 指针，就是对正文的 <code>udp</code> 封装，和我们上述的过程虽然表述不同，但是原理是类似的（具体要看操作系统的实现）。</p><p>不过这样就可以保存这一个报文进行管理，然后使用 <code>next</code> 做链表，此时就转化为对链表的管理（增删查改）。另外，只要双端支持一样的网络协议栈，分离其实也是移动指针...而这里报文管理的规定，其实也体现了协议的约定。</p><p>由于结构的特点，<code>udp</code> 不会对正文进行拆分，怎么发就必须怎么收。本端调用一次 <code>sendto()</code> 发送数据，对端就必须也只调用一次 <code>recvfrom()</code> 接受全部数据，一旦检测到报文数据缺少，就直接丢弃读取到的残缺数据，不会多次调用 <code>recvfrom() </code> 进行读取，这也就是所谓的 <strong>面向数据报</strong>。</p><p>因此 <code>UDP</code> 其实不太需要发送缓冲区（这是相对 <code>TCP</code> 来说，这是因为 <code>udp</code> 报文发送一次就是完整的数据，无需像 <code>tcp</code> 一样在发送缓冲区中进行积攒后，再发送出去，这些后面讲解 <code>tcp</code> 的时候我会进行详细展开）。调用 <code>sendto()</code> 的时候会直接交给内核，直接通过协议栈，然后通过网路发送出去。</p><p>不过 <code>UDP</code> 在对端具有接受缓冲区（也就是 <code>skb_buff</code> 组成的链表队列），因为对端可能会一次接受到很多的 <code>udp</code> 报文，最好聚集缓冲起来统一管理（也算一种微小的可靠性）。而且，这也可以体现 <code>UDP</code> 是全双工的协议（某一端只管发就行了）。</p><div class="hint-container caution"><p class="hint-container-title">警告</p><p>警告：这里的发送缓冲区只是相对于 <code>TCP</code> 的发送缓冲区而言，并不意味着 <code>UDP</code> 封装的过程不需要用到缓冲区...</p></div><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：我们可以简单看一下 <code>Linux</code> 源代码中的 <code>struct udphdr{/*...*/}</code> 和 <code>struct skb_buff{/*...*/}</code>。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// struct udphdr</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> udphdr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	// ...</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__be16	source</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__be16	dest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__be16	len</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__sum16	check</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	// ...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// struct skb_buff</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> skb_buff</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	// ...</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	/* These elements must be at the end, see alloc_skb() for details.  */</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">	sk_buff_data_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		tail</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">	sk_buff_data_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		end</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	unsigned</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> char</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">		*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">head</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">				*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">	unsigned</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		truesize</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">	refcount_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		users</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">	// ...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></div><h4 id="_2-1-4-协议特点" tabindex="-1"><a class="header-anchor" href="#_2-1-4-协议特点"><span>2.1.4.协议特点</span></a></h4><p>总结起来的话，<code>udp</code> 的不可靠体现在三点：</p><ol><li><strong>如果 udp 报文丢弃了、校验失败了，发送端不关心、不重传，但是优点在代码维护必然简单、开发效率高</strong></li><li><strong>接受缓冲区不保证收到的 udp 报文的顺序和发送 udp 报文的数据一致，有可能导致乱序（这可能需要程序员自己进行维护）</strong></li><li><strong>接受缓冲区满了，就会导致后来 udp 报文直接被接受端丢弃，导致数据丢失</strong></li></ol><p>并且还有一个缺点：<strong>udp 报文能存储的正文的较小，这是由于内部结构和字段限制的原因，只能发送 64 K 大小的数据（包含整个报文），如果实在超过大小，就需要程序员自己对数据进行切分（可以使用 sendto() 的返回值来进行判断）</strong>。</p><p>再补充一个特点：<strong>UDP 的通信过程是全双工的，只要互相不影响接受缓冲区就行</strong>。</p><h4 id="_2-1-5-协议目的" tabindex="-1"><a class="header-anchor" href="#_2-1-5-协议目的"><span>2.1.5.协议目的</span></a></h4><p>而到此，<code>UDP</code> 协议实现了传输层的目标：</p><ul><li>解决了发多少的问题，固定了报文最大长度，发多少时确定的</li><li>解决了什么时候发的问题，封装好就立刻发送</li><li>解决了丢失了怎么办的问题，直接不关心丢失的后续问题</li></ul><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：基于 <code>UDP</code> 协议的应用层协议有很多，以下是其中一些常见的：</p><ul><li><strong>NFS(Network File System)</strong>：是一种网络分布式文件系统</li><li><strong>TFTP(Trivial File Transfer Protocol)</strong>：<code>TFTP</code> 是一个简单的文件传输协议，通常用于在局域网内传输小文件</li><li><strong>DHCP(Dynamic Host Configuration Protocol)</strong>：<code>DHCP</code> 协议用于动态分配 <code>IP</code> 地址和其他网络配置参数</li><li><strong>BOOTP(Bootstrap Protocol)</strong>：是另一个基于 <code>UDP</code> 的应用层协议，它用于在网络启动过程中为计算机分配 <code>IP</code> 地址和其他配置信息</li><li><strong>DNS(Domain Name System)</strong>：<code>DNS</code> 协议用于域名解析，将域名映射到 <code>IP</code> 地址</li><li><strong>SNMP(Simple Network Management Protocol)</strong>：<code>SNMP</code> 协议用于网络设备的监控和管理</li></ul></div><h3 id="_2-2-tcp-协议" tabindex="-1"><a class="header-anchor" href="#_2-2-tcp-协议"><span>2.2.TCP 协议</span></a></h3><h4 id="_2-2-1-协议结构" tabindex="-1"><a class="header-anchor" href="#_2-2-1-协议结构"><span>2.2.1.协议结构</span></a></h4><p><code>TCP</code> 协议结构如下。</p><figure><img src="/work-blog-website/assets/1716626166432-NmDVHw0h.jpg" alt="1716626166432" tabindex="0" loading="lazy"><figcaption>1716626166432</figcaption></figure><ul><li><code>16</code> 位源端口号和 <code>16</code> 位目的端口号比较容易理解，就是填写应用层中涉及到了服务端和用户端的端口号，正好就是 <code>uint16_t</code> 类型，和 <code>UDP</code> 结构内的字段是一样的</li><li><code>32</code> 位序号和 <code>32</code> 位确认序号需要很长的解释，后面展开</li><li><code>4</code> 位首部长度可以让报头部分是变长的，需要较长的解释，后面展开</li><li><code>6</code> 位保留字段留做拓展使用，本文不深入这个内容，略过...</li><li><code>6</code> 位标志位，分别对应 <code>tcp</code> 报文的六种不同类型，需要较长的解释，后面展开</li><li><code>16</code> 位窗口大小，是为了平衡两端的传输压力的字段，需要较长的解释，后面展开</li><li><code>16</code> 位校验和，用来检测报头数据有无发生比特位翻转，有则丢弃报文，然后通过重传机制要求重传</li><li><code>16</code> 位紧急指针，需要较长解释，后面展开</li><li><code>32</code> 位选项，长度和首部长度有关，需要较长的解释，后面展开</li><li>剩下的部分全是正文数据，能存储很大的数据，就是应用层传递过来的应用层报文，例如 <code>http/https</code> 报文</li></ul><div class="hint-container note"><p class="hint-container-title">注</p><p>吐槽：从结构上 <code>TCP</code> 就比 <code>UDP</code> 要复杂许多了，具象化就对应到比 <code>UDP</code> 更为复杂的代码维护...</p></div><p>首先整个 <code>tcp</code> 报头是变长的，变长的数据在选项里。<code>tcp</code> 报头的长度由 <code>4</code> 位首部长度来决定，范围为 <code>[0, 15]</code>，其单位是 <code>4</code> 个字节，也就是说首部的大小在 <code>[0*4=0, 15*4=60]</code> 字节范围内。而由于标准报头的长度就先占用了 <code>20</code> 个字节，选项最多就占用 <code>40</code> 个字节，对应的范围就是 <code>[20=5*4, 60=15*4]</code> 字节。因此，首部内填写的数值就是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>5</mn><mo separator="true">,</mo><mn>15</mn><mo stretchy="false">]</mo><mo>=</mo><mo>=</mo><mo stretchy="false">[</mo><mo stretchy="false">(</mo><mn>0101</mn><msub><mo stretchy="false">)</mo><mn>2</mn></msub><mo separator="true">,</mo><mo stretchy="false">(</mo><mn>1111</mn><msub><mo stretchy="false">)</mo><mn>2</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[5, 15]==[(0101)_2, (1111)_2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">15</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">==</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[(</span><span class="mord">0101</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mopen">(</span><span class="mord">1111</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>注意：这里一定要注意 <code>UDP</code> 是记录整个 <code>udp</code> 报文的长度，但是 <code>TCP</code> 的首部长度只计算了变长报头的长度，而不是整个 <code>tcp</code> 报文长度。</p></div><h4 id="_2-2-2-封装分离" tabindex="-1"><a class="header-anchor" href="#_2-2-2-封装分离"><span>2.2.2.封装分离</span></a></h4><p>而报头的分离，需要先提取 <code>tcp</code> 报文的前 <code>20</code> 个字节，进一步获取到首部长度值 <code>*4-20</code> 查看是否得到 <code>0</code>，是 <code>0</code> 就 <code>done</code>，否则就读取到了选项的长度，直接根据长度读取完毕选项里的数据即可。自此就分离了整个报头，剩下的就是报文数据。</p><p>另外，在内核中也可能找到对应的 <code>tcp</code> 报头数据结构。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="cpp" style="--vp-collapsed-lines:15;--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// struct tcphdr</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> tcphdr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    //...</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__be16	source</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__be16	dest</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__be32	seq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__be32	ack_seq</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">if</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> defined</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">__LITTLE_ENDIAN_BITFIELD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__u16	res1:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		doff:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		fin:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		syn:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		rst:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		psh:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		ack:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		urg:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		ece:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		cwr:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">elif</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> defined</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">__BIG_ENDIAN_BITFIELD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">	__u16	doff:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		res1:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">		cwr:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    //...</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div></details><p>而封装的过程我不再描述，类似 <code>UDP</code> 的过程。</p><h4 id="_2-2-3-报文管理" tabindex="-1"><a class="header-anchor" href="#_2-2-3-报文管理"><span>2.2.3.报文管理</span></a></h4><p>当报文数量多了起来，也需要被先描述再组织，因此必然有对应的结构体进行管理。</p><p>而 <code>TCP</code> 在这里和 <code>UDP</code> 不同的地方在于，<code>TCP</code> 有发送缓冲区，也有接受缓冲区。并且发送接受过程中两端地位是相同的，本端发送缓冲区向对端接受缓冲区发送数据，对端发送缓冲区向本段发送数据，因此 <code>TCP</code> 也是全双工的。</p><p>而 <code>TCP</code> 的接受缓冲区和 <code>UDP</code> 一样可以对大量报文进行缓存（也就是存储在内存中的报文管理结构体）。但 <code>TCP</code> 还有发送缓冲区，也会对报文进行缓存，缓存的大量 <code>tcp</code> 报文不会被立马发送出去，触发发送时机的策略由操作系统决定，这也就是所谓的 <strong>面向数据流</strong>（这种机制很类似生产者消费者模型）。</p><p><code>TCP</code> 传输过程中，数据量太多会被自动拆分为多个 <code>tcp</code> 报文（无需程序员管理），因此可能导致发送的数据不完整，报文发送的顺序混乱的问题。但是这个问题由于 <code>TCP</code> 内部的特殊字段产生的特殊机制来解决。</p><p><code>tcp</code> 报文接受过多时，<code>TCP</code> 协议还有特殊字段产生的特殊机制来避免接受缓冲区承受不住过多的报文而导致报文丢弃。</p><h4 id="_2-2-4-协议特点" tabindex="-1"><a class="header-anchor" href="#_2-2-4-协议特点"><span>2.2.4.协议特点</span></a></h4><p><code>TCP</code> 报文头部复杂，因此不能直接看协议结构来得到具体的用途，需要结合各种保证可靠性和高效率的机制结合理解...</p><h5 id="_2-2-4-1-确认应答机制-可靠" tabindex="-1"><a class="header-anchor" href="#_2-2-4-1-确认应答机制-可靠"><span>2.2.4.1.确认应答机制(可靠)</span></a></h5><p>确认应答机制由 <strong>序号</strong> 和 <strong>确认序号</strong> 来完成，主要保证两种可靠性，一是保证得到接收，二是保证按序接收。</p><h6 id="_2-2-4-1-1-保证对端得到接收" tabindex="-1"><a class="header-anchor" href="#_2-2-4-1-1-保证对端得到接收"><span>2.2.4.1.1.保证对端得到接收</span></a></h6><p>首先，您需要知道一个事实：网络中不存在百分百可靠的传输，最新发送的数据无法保证可靠性（也就是一定被对方受到），但我们只需要保证旧消息被对端接收到即可。因为只要历史消息发送出去后，对端产生匹配的回应，就可以保证旧消息百分百可靠（只要回答了，就可以保证对方一定接受到了）。</p><p>因此 <code>TCP</code> 的可靠性不在于实现了“传输就百分百到达”的可靠性（技术上很难确保百分百，最多是大概率），而是“通过一系列的机制，确保历史消息被对端正确接受”的可靠性。</p><p>而这个机制就是确认应答机制，<code>tcp</code> 报文发送出去后，必须有对应的回应发送回来，这样就保证数据安全到达对端，否则就认为 <code>tcp</code> 报文发生了丢失。而实现这一回应机制的头部字段就是序号和确认序号，可以简单认为带有 <code>序号</code> 字段的 <code>tcp</code> 请求经过对端处理后，返回的是经过带有 <code>确认序号=序号+1</code> 的确认响应。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：为什么需要 <code>+1</code> ，发送的序号和返回的确认序号一样不也能保证可靠性么？为什么需要两个序号，一个序号不行么？这是因为 <code>TCP</code> 是全双工的，本端接收到对端的报文时，将对端的序号 <code>+1</code> 变为自己的确认序号进行回应。但是回应往往是不需要带上正文数据的，对端只需要获取响应报文，并且确认内部的确认序号是否 <code>+1</code>。</p><p>那么为什么需要 <code>+1</code> 呢？对于本端来说，只发送响应的头部是否有些浪费？能不能把下一次需要发送的正文数据也一起发送出去？那把空缺的正文部分填上这个部分吧，这样 <code>tcp</code> 报文就既是响应也是请求了（这其实就是捎带应答机制的部分了，后面我会重新提及）。</p><p>因此对端就有可能是“既想给对方确认消息，又想给对方发送消息”，而如果只有一个序号就无法做到这样的事情。</p><p>如果只有一个序号，且同时承担发送和确认的功能，这就会引起混淆，因为同一个序号无法同时表示用于 <strong>发送</strong> 数据，还是用于 <strong>确认</strong> 数据。</p></div><h6 id="_2-2-4-1-2-保证对端按序接收" tabindex="-1"><a class="header-anchor" href="#_2-2-4-1-2-保证对端按序接收"><span>2.2.4.1.2.保证对端按序接收</span></a></h6><p>而实际上的 <code>TCP</code> 过程不一定是严格一发一收的（这也是大部分的情况），如果正文数据过大，本端可能向对端一次性发送多个被拆分的正文数据 <code>tcp</code> 报文（但保证每一个报文的头部都一样），也有可能干脆直接发送多个正文部分毫不相干的报文。但无论哪一种，理论上可以同时发送出去多个报文，然后回应对应个数的报文即可，在保证可靠性的同时，效率也会变高一些。</p><p>不过，这会带来正文顺序不确确定的问题，本端发送报文的顺序不一定是对端接收报文的顺序（这和中间设备选择有关），对端该如何确定哪一个应答对应哪一个请求呢？该怎么办把被拆分的正文部分的数据进行正确的拼接然后向上传递呢？</p><p>我们有对应的解决方案，每一个被接受的 <code>tcp</code> 报文一定携带了完整的头部（否则这个报文就会被认为无效而被丢弃）。其中就携带了 <code>32</code> 序号，对端发送响应的时候直接在确认序号中 <code>+1</code>，这样请求和应答就可以一一对应。确认序号对应的数字，表示之前收到的报文已经全部收到了，下次发送就应该从此时的序列号开始发送。</p><p>此时如果多个正文的报头是相同的就是不同的报文，交给上层不同的端口号程序做处理；如果是相同的就做按序拼接（但不一定是完整的正文数据）交给上层同一端口号的程序进行处理。</p><p>序号怎么理解？我们一直在说序号，但是序号是怎么编号的？在 <code>TCP</code> 协议中，序号是在 <code>TCP</code> 正文数据被封装之前就确定的。先给要发送的数据按字节进行编号，然后再进行 <code>TCP</code> 封装。</p><figure><img src="/work-blog-website/assets/1715654704003-CWuTIlb8.jpg" alt="1715654704003" tabindex="0" loading="lazy"><figcaption>1715654704003</figcaption></figure><p>而实际上序号还有一个意义 <strong>序号保证之前的历史报文全部收到</strong>，假设本段发送的序号为 <code>1001、1002、1003</code> 的报文（后面的滑动窗口机制可以做到同时发送多个报文而无须等待应答），响应过程中返回的只有 <code>1004=1003+1</code>，那么前面的 <code>1001+1、1002+1</code> 的响应就无所谓了，因为 <code>1003</code> 之前的历史报文已经被确保全部接收到了才能返回 <code>1004</code>。</p><p>实际上，也要求必须返回 <code>1004</code>，因为发送端知道发送了哪些报文，如果响应的序号不符合发送端预期，就说明报文发生了丢失，会导致触发重传（后面的超时重传机制可以在没有接受到预期报文的情况下要求发送端重传）。</p><p>这就意味着，操作系统实现接收多个报文数据按序号排序时，很可能保证前面数据顺序连贯的情况下，把最后一个数据的序号作为应答来响应的，这样可以也减少响应的次数，变相提高了效率。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：在这个多个报文传输过程中，也许多个响应会发生报文丢失，但只要连贯顺序的最后一个报文的确认信号被响应回来，就可以保证 <code>确认序号-1</code> 序号的历史报文都被对端所接收，该序号后续的报文就被判定为丢失，等待后续的超时重传机制进行重传即可...</p></div><p>当发送端接到接收端的确认序号后，就会按照这个序号发送对应序号的数据，因此确认序号成为了新的报文中的序号。需要注意的是，发送时机和接受时机是无序的，只是通过序号来排序，因此这就是一种 <strong>面向字节流</strong> 的特性。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：每个链接都有一对输入输出缓冲区，因此就不必担心序号相同导致冲突的问题。每个链接根据自己的缓冲区来根据需要对正文内容排序，就可以避免这种事情。</p></div><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>tcp</code> 报文的起始序号可能是随机的，后续的序号才是顺序的序号。而这个随机序号可以通过三次握手的时候通过报头互相交给对端。这样也可以防备一些黑客根据有规律的报文实现黑客行为。还可以防止断开链接时，新连接收到旧链接的旧数据尴尬情况。</p></div><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：实际上您也可以认为系统中普通文件的读写也是字节流的，写入倒是无所谓，但是读取数据可能需要一定的分割，而如果对文件自定义协议，就诞生了类似 <code>JSON</code> 的组织数据格式...</p></div><h5 id="_2-2-4-2-连接管理机制-可靠" tabindex="-1"><a class="header-anchor" href="#_2-2-4-2-连接管理机制-可靠"><span>2.2.4.2.连接管理机制(可靠)</span></a></h5><p>连接管理机制由 <code>6</code> 个标志位来完成。</p><h6 id="_2-2-4-2-1-六种标志位" tabindex="-1"><a class="header-anchor" href="#_2-2-4-2-1-六种标志位"><span>2.2.4.2.1.六种标志位</span></a></h6><p><code>6</code> 个标志位（也有可能是 <code>8</code> 位），一个标志位表示某种含义。常规报文、建立连接报文、断开连接报文、确认报文...不同报文对应的处理方式是不一样的。因此该标记为就是用来区分不同报文的类型，这样用来做不同的处理动作会更加方便一些。</p><p>各个标记位也有自己的含义：</p><ul><li><strong>ACK（确认）</strong>：表示确认字段是否有效，若有效则表示确认号字段包含一个有效的确认序列号，通常在用于确认数据的接收</li><li><strong>URG（紧急）</strong>：表示紧急指针字段是否有效，若有效则向接收端指示紧急数据的位置，接收端需立即处理，但不要求立即传递给应用程序</li><li><strong>PSH（推送）</strong>：表示数据是否应该立即交付给应用程序而不用等待填充缓冲区，用于任何指示接收端应该尽快将数据传递给应用程序而不是缓存</li><li><strong>RST（复位）</strong>：表示重置连接，通常在连接出错或异常情况下使用，以强制断开连接并重置连接状态</li><li><strong>SYN（同步）</strong>：表示建立连接，在三次握手过程中，用于发起连接请求，同时指定自己的初始序列号</li><li><strong>FIN（结束）</strong>：表示关闭连接。在连接关闭过程中，用于表明发送端不再发送数据，并请求关闭连接</li></ul><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>ACK</code> 也叫确认帧，非常常用，不仅仅用在传输层。</p></div><h6 id="_2-2-4-2-2-紧急指针和紧急数据" tabindex="-1"><a class="header-anchor" href="#_2-2-4-2-2-紧急指针和紧急数据"><span>2.2.4.2.2.紧急指针和紧急数据</span></a></h6><p>当 <code>URG</code> 字段有效时，紧急指针数据就有效，紧急指针代表紧急数据在正文中的偏移量，因此紧急数据在正文中被包含，发送给对端时，对端会忽略序号问题进行优先处理。另外，比较搞笑的是，紧急数据只有一个字节。因此紧急数据虽然允许被插队，但是却不允许大量的插队。但是紧急指针的应用场景在哪里呢？</p><ol><li><strong>Telnet 和 SSH 会话</strong>：在 <code>Telnet</code> 或 <code>SSH</code> 会话中，用户可能会通过按下紧急字符（通常是 <code>[ctrl+c]</code> 的方式）来请求中断当前操作或者发送一些特殊的命令。紧急指针可以用来指示这些紧急数据的位置，以便及时处理。</li><li><strong>网络流量控制</strong>：在某些情况下，紧急数据可能用于控制网络流量。例如，当网络拥塞或者发生其他紧急情况时，可以发送紧急数据以通知对端立即停止或调整其行为。</li><li><strong>应用层协议</strong>：一些应用层协议可能会使用 <code>TCP</code> 的紧急指针来实现一些特定的功能或者通信需求。在这种情况下，紧急指针可以用来指示需要优先处理的数据或者触发特定的行为。例如终止上传文件的行为。</li><li><strong>紧急检测</strong>：服务器被卡住了，客户端可以用紧急数据询问服务端的机器状态，而服务器也可以通过紧急数据来返回告知机器状态...</li></ol><p>总的来说，紧急指针的应用场景相对较少，并且通常只在特定的网络通信需求或协议中使用。在大多数情况下，正常的 TCP 通信不需要使用紧急指针功能。</p><p>在套接字编程中，要触发 <code>TCP</code> 的紧急指针，需要在发送数据时设置相应的选项。可以查看 <code>recv()</code> 第三个参数 <code>flag</code> 的设置，有一个 <code>MSG_OOB(即 out-of-band)</code> 的选项，也就是所谓的 <strong>带外数据</strong>，意思是处于正常通信之外的数据，因此不能过大。</p><p>而不能仅仅发送紧急数据，还需要对应的紧急处理逻辑...</p><p>对于发送端来说，在发送数据时，紧急数据会与正常数据一起发送，但在 <code>TCP</code> 协议栈的处理过程中，紧急数据与正常数据是分开处理的。因此紧急指针不会和正文数据混淆，会被接收端单独分离除紧急数据，剩下的正文部分会按照 <code>TCP</code> 数据包的序号进行按序处理...</p><h6 id="_2-2-4-2-3-三次握手和四次挥手" tabindex="-1"><a class="header-anchor" href="#_2-2-4-2-3-三次握手和四次挥手"><span>2.2.4.2.3.三次握手和四次挥手</span></a></h6><p><code>TCP</code> 建立和断开连接的过程，什么是链接？怎么理解三次握手和四次挥手？</p><figure><img src="/work-blog-website/assets/6958791f96e06982a3031a1b6f156497-BxokoCUv.png" alt="6958791f96e06982a3031a1b6f156497" tabindex="0" loading="lazy"><figcaption>6958791f96e06982a3031a1b6f156497</figcaption></figure><div class="hint-container warning"><p class="hint-container-title">注意</p><p>注意：图示过于简略，有时会误导人，这里发送什么 <code>ACK、DATA</code> 的都带有完整的头部，只不过内部标志位被设置为对应的类型而已，简称 <code>xx类型</code> 报文，一定不要忽略这只是头部中的一个标志位。并且，斜线代表经过一段时间的传输，因此从上到下有一条时间轴的概念...</p></div><p><strong>建立链接的本质</strong></p><p>客户端发起向服务端的连接请求，大量的客户端连接就需要被服务器管理起来，因此链接连接成功的时候，就是在内核中创建对应的数据结构对象，然后再使用某种数据结构进行链接管理（转化为对链接的增删查改），因此维护链接本身就是有成本的。</p><p>并且链接的过程中，两端存在状态变化，两端根据状态结果来判断新链接是否可以用。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>UDP</code> 无需管理这种链接，没有这种成本，这也是 <code>UDP</code> 比 <code>TCP</code> 简单的另外一个原因</p></div><p><strong>三次握手的内容</strong></p><p>首先一定要意识到，<code>TCP</code> 的三次握手不是确保一定成功的，这和之前确保报文百分百送达的道理是一样的。</p><p><strong>三次握手的具体过程是什么？</strong></p><ol><li>发送端建立链接对象，内部设置为 <code>SYN_SEND(链接请求)</code> 状态，同时发送 <code>SYN</code> 请求报文。</li><li>接收端收到请求后也创建链接对象，内部设置为 <code>SYN_RECV(同步链接)</code> 状态，同时发送 <code>ACK+SYN</code> 响应/请求报文（因为一个报文可以被同时设置为多种类型，并且这里无需使用正文数据，只需要报头就足够了。不过也有些人认为这也是一种捎带应答机制...）</li><li>发送端接收到请求/响应后，把自己的链接对象修改为 <code>ESTABUSHED(建立链接)</code> 状态，同时发送 <code>ACK</code> 响应报文。接收端接受到该报文时，也会把自己的链接对象设置为 <code>ESTABUSHED</code> 状态，此时双端都认为建立好了链接。</li></ol><p><strong>三次握手的过程中报文丢失会怎么样？</strong></p><ul><li><code>SYN</code> 报文丢失了没关系，发送端知道没有回应，自动进行重传，重新发送该报文</li><li><code>ACK+SYN</code> 报文丢失了没关系，接收端知道没有回应，自动进行重传</li><li>前两次是不用担心了，但最后一次报文如果丢失了怎么办呢？我们会发现，对于接收端来说，只有收到第三次的报文才算建立链接成功，但是对于发送端来说，只需要收到第二次的报文就算建立链接成功了。时间节点上，发送端会比接受端更先建立链接。而如果发生丢失，发送端会自顾自的认为链接建立成功（但接受端不这么认为，还在等待响应）。此时就有两种情况，一是接受端认为超过了一定时间没有收到 <code>ACK+SYN</code> 报文的响应，就重新发送该报文；二是发送端认为链接建立成功，开始发送数据。服务器如果收到了该响应，就会认为没有通过链接就发送数据，就会响应 <code>RST</code> 报文重新建立链接，此时发送端释放自己的链接，重新开始三次握手，直到成功为止。</li></ul><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>RST</code> 报文的应用很广泛，任何一段没有建立好链接就进行读写数据，都会被对端返回 <code>RST</code> 报文...</p></div><p><strong>三次握手是必须的么？一次、两次、四次、五次怎么样？</strong></p><ul><li><code>1</code> 次怎么样？如果客户端发送大量的 <code>SYN</code> 类型的 <code>TCP</code> 报文，那服务端只要收到一次就建立连接的话，很快就会把服务端资源吃完（也就是 <code>SYN</code> 洪水），只要客户端够多，哪怕客户端挂掉了，服务端也需要维护大量的连接，当然也并不是全部都是这个原因。</li><li><code>2</code> 次握手呢？只要服务端返回 <code>ACK</code> 就建立连接的话，服务端无法保证自己返回的 <code>ACK</code> 被客户端接受到。而如果客户端不理会这个 <code>ACK</code>，甚至是直接丢弃，只要客户端的连接数量够多，也会导致服务端的连接被挂满。</li><li>那为什么 <code>3</code> 次可以呢？因为服务端有连接时，客户端也会被迫保证有连接，此时双方都需要维护连接资源，就可以一定程度避免普通机器吃服务端资源连接的可能性（一般单机比服务端的资源要少，再还没有吃完服务端之前自己就先挂了），当然这只是避免单机的情况，但总比前面的好一些。不过，实践中的攻击没有这么简单，仅凭这种简单机制还无法杜绝上述的攻击，这些只是三次握手的顺带功能罢了，最多就是防止小白用户攻击接受端。</li><li><code>4</code> 次握手呢？那最后一次一定是 <code>server</code> 发起的，发送端可以任意丢弃，而服务端却不知道报文丢失，认为自己链接建立好了，大量发送端都这么做，也会导致服务器资源耗尽（从这里可以看出，如果是偶数次握手，连接成本都在服务端）。</li><li><code>5</code> 次虽然可以，但是就没必要了，<code>3</code> 本身保证链接资源在两端是对等建立。</li><li><code>6</code> 次呢？不好意思，是偶数次，回到了 <code>4</code> 次握手的问题...</li></ul><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：发送端有可能在第三次建立连接的后续就把数据发送，如果 <code>ACK</code> 丢失，一旦接收端还没有收到 <code>ACK</code> 先收到后续的数据，就会被接收端检测到链接对象中的状态出现异常，接收端此时就会发送带有 <code>RST(连接重置)</code> 的响应，此时发送端接收到就会关闭连接（释放链接对象），重新发起三次握手以重新创建链接（创建链接对象）。但这种第一次就连接不上的情况较少，更多是未来通信中，接收端认为连接出现问题，但是发送端不知道是，就会发送 <code>RST</code> 让发送端重置（不知道的理由是，发送端和接收端使用的链接对象是各自的）。</p></div><p><strong>三次握手的意义是什么？</strong></p><ol><li><p>确认双方的发送和接收能力，最为重要的作用是验证通信的全双工，以最小成本保证两端都可以进行“发/收”。</p><p>如果把第二次握手的过程拆分为两次来理解，我们会发现，发送端先进行 <code>SYN</code> 请求，然后得到 <code>ACK</code> 响应，建立好链接。而接收端再进行 <code>SYN</code> 请求，然后得到 <code>ACK</code> 回应，建立好链接。这个时候会发现，两者做的工作是一样的，都建立了链接。这个时候就会发现，发送端以最小成本保证了和接收方的全双工能力。而接收端也以最小成本保证了和发送端的全双工能力。</p></li><li><p>三次握手可以避免一定程度的网络攻击，但是这不是主要作用</p></li><li><p>三次握手可以让前面提到的确认应答机制中随机产生的序号被双端得知</p></li><li><p>三次握手可以让后面提到的滑动窗口机制中窗口大小的值被发送端得知</p></li></ol><p><strong>四次挥手的内容</strong></p><p>首先一定要意识到，<code>TCP</code> 的四次挥手不是确保一定成功的，这和之前确保报文百分百送达的道理是一样的。</p><p><strong>四次挥手的具体过程是什么？</strong></p><ol><li>发送端发送 <code>FIN</code> 报文，发送端链接对象内部进入 <code>FIN_WAIT_1</code> 状态</li><li>接受端收到请求后立刻返回 <code>ACK</code> 报文，同时接收端链接对象内部进入 <code>CLOSE_WAIT</code> 状态。而发送端接收到响应后，内部链接对象就会进入 <code>FIN_WAIT_2</code> 状态，同时关闭发送端自己的链接</li><li>接受端经过一定的必要时间后，开始发送 <code>FIN</code> 报文，接收端立刻进入 <code>LAST_ACK</code> 状态。发送端接收到请求后，内部链接对象进入 <code>TIME_WAIT</code> 状态</li><li>发送端返回 <code>ACK</code> 报文，发送端链接对象进入需要等待一段时间才能进入 <code>CLOSED</code> 状态。接收端收到后内部链接对象就进入 <code>CLOSED</code> 状态，关闭接收端自己的链接</li></ol><p><strong>四次挥手的过程中报文丢失会怎么样？</strong></p><p>这里有几个状态值得一提...发送提前断开时，接收端处于 <code>CLOSE_WAIT</code> 状态，如果一直没有正确关闭套接字，就会一直占用链接资源，这种情况可以被我们验证到。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="cpp" style="--vp-collapsed-lines:15;--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// test.cpp</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">iostream</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">string</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cstdlib</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cstring</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">arpa/inet.h</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">unistd.h</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> argc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> char*</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[])</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // 创建套接字</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> server_socket </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">AF_INET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> SOCK_STREAM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // 准备地址结构体</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">   struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr_in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   memset</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">   server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_family</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> AF_INET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">   server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">s_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> inet_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]);;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 监听网络接口</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">   server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> htons</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">atoi</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]));</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 监听端口</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // 绑定套接字到地址和端口</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">   if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">bind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cerr </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">bind error...</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">endl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // 开始监听连接</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   listen</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cout </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">服务器启动, 等待连接...</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">   while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       // 接受客户端连接</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr_in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">       socklen_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_address_size </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_socket </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> accept</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_address_size</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       // 打印客户端连接信息</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> client_ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">INET_ADDRSTRLEN</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       inet_ntop</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">AF_INET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> INET_ADDRSTRLEN</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">       std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cout </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">连接来自: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_ip </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ntohs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">endl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">       // 接收和发送数据</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1024</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">       ssize_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> bytes_received</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">       while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ((</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">bytes_received </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> recv</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">),</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cout </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">收到消息: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">string</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> bytes_received</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">endl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">           send</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> bytes_received</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 回复相同的消息</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">       }</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">   }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // 关闭套接字</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">   // close(client_socket);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 故意不关闭和客户端通信用的套接字, 客户端完成链接关闭, 但是服务端没有关闭单向的链接, 最终导致资源泄露</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   close</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">   return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div></details><p>然后使用 <code>telnet</code> 不断使用客户端进行链接，借助 <code>netstat -ntp | grep CLOSE_WAIT </code> 命令查看网络服务状态。</p><details class="hint-container details"><summary>详情</summary><div class="language-shell line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="shell" style="--vp-collapsed-lines:15;--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查看处于 CLOSE_WAIT 的链接</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> g++</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> test.cpp</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./test.cpp</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 127.0.0.1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> telnet</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 127.0.0.1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Trying</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1...</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Connected</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1.</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Escape</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> character</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> is</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">^]</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ntp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Not</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> all</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> processes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> could</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> be</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> identified,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> non-owned</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> process</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> info</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">will</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> not</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> be</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> shown,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> you</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> would</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> have</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> be</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> see</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> it</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> all.</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tcp</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:42088</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         127.0.0.1:8081</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          FIN_WAIT2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                   </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tcp</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:42074</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         127.0.0.1:8081</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          FIN_WAIT2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                   </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tcp</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:42060</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         127.0.0.1:8081</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          FIN_WAIT2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   -</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div></details><p>此时出现了很多处于 <code>CLOSE_WAIT</code> 状态的链接，这意味着发生了内存泄露。因此如果发现服务器具有大量的 <code>CLOSE_WAIT</code> 说明什么？说明应用层有 <code>bug</code>，很有可能忘记关闭 <code>sockfd</code> 套接字导致无法进入 <code>LASK_ACK</code> 状态。而且这里我们会发现，链接是操作系统维护的，哪怕客户端进程彻底结束了，链接也依旧存在操作系统中，内部状态依旧可以接受到 <code>ACK</code> 陷入 <code>FIN_WAIT2</code> 状态，因此最后两次挥手就是操作系统来完成的。</p><p>在理论上，客户端处于 <code>FIN_WAIT_2</code> 状态应该会在一段时间后自动关闭连接。根据 <code>TCP</code> 协议的规范，<code>FIN_WAIT_2</code> 状态通常会在一段时间（通常是几分钟到几小时）后超时并自动关闭连接，这个时间间隔称为 <code>2MSL(Maximum Segment Lifetime，最大报文生存时间)</code> 后面我还会再提及这个机制。</p><p>而如果反过来，服务端提前断开时，是服务端这边进程结束了，发生了两次挥手，而客户端这边由于使用了 <code>telnet</code>，检测到对端关闭就会自动发起挥手，而由于服务端进程还需要处于一段时间的 <code>TIME_WAIT</code> 状态，此时大概 <code>30~60s</code> 内重启同一 <code>IP</code> 和 <code>POST</code> 的服务端进程很可能会失败（原因就是这个端口上的链接资源没有彻底被释放回收），只有过一段时间才能重启。</p><details class="hint-container details"><summary>详情</summary><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 和服务端建立连接后强行终止服务端程序</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./a.out</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 127.0.0.1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">服务器启动,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 等待连接...</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">连接来自:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:48250</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">^C</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ntp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">No</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> info</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> could</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> be</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> read</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> for</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-p</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> geteuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1001</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> but</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> you</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> should</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> be</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root.</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tcp</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:8081</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          127.0.0.1:48250</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         TIME_WAIT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   -</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>因此我们最好让客户端不固定端口号，并且最好客户端比服务端先关闭，让客户端自己进入 <code>TIME_WAIT</code>，而由于客户端进程还会更改端口号，就不会出现这样的问题。</p><div class="hint-container note"><p class="hint-container-title">注</p><p>吐槽：这里可以总结一个小规律，只要谁先断开的，最后一定会陷入 <code>TIME_WAIT</code> 状态。</p></div><p>或者可以了解一下接口 <code>setsockopt(server_socket, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT, &amp;opt, sizeof(opt))</code> 函数来设置套接字选项，其作用是允许重用地址和端口。具体来说，<code>setsockopt()</code> 函数用于设置套接字的选项值，在这个调用中：</p><ul><li><code>_listensock</code> 是要设置选项的套接字描述符</li><li><code>SOL_SOCKET</code> 是选项所属的协议级别，代表通用套接字选项</li><li><code>SO_REUSEADDR</code> 和 <code>SO_REUSEPORT</code> 是两个选项名，它们分别表示允许地址重用和端口重用</li><li><code>&amp;opt</code> 是一个指向选项值的指针，<code>opt</code> 可以是一个整数类型的变量，通常被设置为 <code>1</code> 表示启用选项，或者设置为 <code>0</code> 表示禁用选项</li><li><code>sizeof(opt)</code> 是选项值的大小</li></ul><p>在这个调用中，<code>SO_REUSEADDR</code> 和 <code>SO_REUSEPORT</code> 选项的作用如下：</p><ul><li><code>SO_REUSEADDR</code>：允许在套接字关闭后，立即重启服务器并绑定到之前使用的地址和端口，即使该地址和端口仍然处于 <code>TIME_WAIT</code> 状态，这样可以避免因为之前的连接还未完全关闭而导致无法绑定到指定的地址和端口。</li><li><code>SO_REUSEPORT</code>：允许多个套接字绑定到相同的地址和端口，这样可以实现多个进程或线程共享相同的端口号，这对于负载均衡和并发处理非常有用。</li></ul><p>在实际应用中，如果你希望在服务器重启时立即绑定到相同的地址和端口，通常会使用 <code>SO_REUSEADDR</code> 选项。如果你希望多个进程或线程共享相同的端口号，那么可以使用 <code>SO_REUSEPORT</code> 选项。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="cpp" style="--vp-collapsed-lines:15;--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// test.cpp</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">iostream</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">string</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cstdlib</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cstring</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">arpa/inet.h</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">#</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">include</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">unistd.h</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> argc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> char*</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[])</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 创建套接字</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> server_socket </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">AF_INET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> SOCK_STREAM</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> opt </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 注意这里要加上                                                  </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    setsockopt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> SOL_SOCKET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> SO_REUSEADDR </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> SO_REUSEPORT</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">opt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      opt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 准备地址结构体</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">    struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr_in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    memset</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">));</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_family</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> AF_INET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">s_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> inet_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]);;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 监听网络接口</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> =</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> htons</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">atoi</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">args</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]));</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 监听端口</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 绑定套接字到地址和端口</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    if</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">bind</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> ==</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> -</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cerr </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">bind error...</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">endl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 开始监听连接</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    listen</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cout </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">服务器启动, 等待连接...</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">true</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 接受客户端连接</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr_in</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        socklen_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_address_size </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_socket </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> accept</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> (</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">struct</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;"> sockaddr</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">*</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_address_size</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 打印客户端连接信息</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> client_ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">INET_ADDRSTRLEN</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        inet_ntop</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">AF_INET</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &amp;</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_addr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_ip</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> INET_ADDRSTRLEN</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cout </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">连接来自: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> client_ip </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> ntohs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">client_address</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sin_port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">endl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">        // 接收和发送数据</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        char</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1024</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">];</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        ssize_t</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> bytes_received</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        while</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> ((</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">bytes_received </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> recv</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> sizeof</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">),</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &gt;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cout </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;&lt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">收到消息: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">string</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> bytes_received</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> std</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">::</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">endl</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">            send</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">client_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> buffer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> bytes_received</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 回复相同的消息</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">        }</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // 关闭套接字</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">    // close(client_socket);</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> // 故意不关闭和客户端通信用的套接字, 客户端完成链接关闭, 但是服务端没有关闭单向的链接, 最终导致资源泄露</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    close</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">server_socket</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 不间断建立连接</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./a.out</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 127.0.0.1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">服务器启动,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 等待连接...</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">连接来自:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:51110</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">^C</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./a.out</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 127.0.0.1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">服务器启动,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 等待连接...</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">连接来自:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:51116</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">^C</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./a.out</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 127.0.0.1</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">服务器启动,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 等待连接...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 地址和端口复用</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> netstat</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -ntp</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> grep</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 8081</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">No</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> info</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> could</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> be</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> read</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> for</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-p</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> geteuid</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1001</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> but</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> you</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> should</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> be</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root.</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tcp</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:8081</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          127.0.0.1:50330</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         TIME_WAIT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   -</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                   </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">tcp</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        0</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 127.0.0.1:8081</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          127.0.0.1:50298</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         TIME_WAIT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   -</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>但是这里有一个值得探究的问题，为什么需要 <code>TIME_WAIT</code> 这种奇怪的状态保留？不能直接让先断开的一端在收到就进入 <code>CLOSED</code> 状态么？主要原因是为了保证历史报文消散，避免影响新连接的建立（所谓的释放就是操作系统接受了旧链接的旧数据但进行了丢弃，不影响新的链接）。</p><p>那么一个报文的最大存活时间是多少呢？一般不同系统设置不一，但是定义都是 <code>2MSL</code>，信道的一个朝向所需时间就是一个 <code>MSL</code>。</p><details class="hint-container details"><summary>详情</summary><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 查询 TIME_WAIT 的大小</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> cat</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /proc/sys/net/ipv4/tcp_fin_timeout</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">60</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><div class="hint-container caution"><p class="hint-container-title">警告</p><p>警告：值得注意的是上述的代码和相关命令现象，我是在 <code>Centos 7</code> 系统下进行观察的，很可能会有些变动。</p></div><p><strong>四次挥手是必须的么？两次、三次、五次怎么样？</strong></p><ul><li><code>1、2</code> 次怎么样？肯定不行的，最多保证一端被关闭，而无法百分百保证两端链接都进行了关闭</li><li><code>3</code> 次挥手可以么？没有一种可能 <code>ACK</code> 和 <code>FIN</code> 被同时设置呢？也就是所谓的三次挥手呢？是有可能存在的常规的四次挥手中，理论上可以把第二次和第三次挥手的 <code>ACK</code> 和 <code>FIN</code> 合在一起发送的。</li><li><code>4</code> 次挥手的概率比 <code>3</code> 次挥手的概率高，但为什么常见的基本都是四次呢？因为发送端想要断开链接基本是发送端自己的事，而接收端很可能对链接资源还需要进一步的处理，导致消耗一些必要时间（在接受端到发送端的信道还没关闭前，接收端可以回收自己的链接资源、向发送端发送剩余的数据...）。接收端可以同意发送端的关闭，但是很难出现 <code>ACK</code> 和 <code>FIN</code> 时机相同的时候（但是这种情况也不是没有，不过不是主流）。</li></ul><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：这里可以继续深挖一个问题，上面我在 <code>4</code> 次挥手中说过，尽管发送端关闭了链接，但是接收端不一定跟着就关闭了，还有可能持有单向的信道向发送端发送数据。但是我们在实际编码的过程中，在客户端向服务端通信结束后，往往关闭了 <code>fd</code>，客户端怎么知道服务端还有数据没有传输过来呢？</p><p>实际上，<code>Linux</code> 系统的内部还有接口 <code>shutdown()</code>，这个接口可以选择关闭套接字的读端或写端，所以作为客户端可以只关闭写接口，依旧保留读接口，这样就可以把服务端剩下的数据传输过来。</p><details class="hint-container details"><summary>详情</summary><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// shutdiwn()</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">shutdown</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sockfd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> int</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> how</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// sockfd 是指定的套接字文件描述符, how 是指定关闭套接字的方式, 可以取三个值:</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// SHUT_RD: 关闭套接字的读端, 即禁止接收数据</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// SHUT_WR: 关闭套接字的写端, 即禁止发送数据</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">// SHUT_RDWR: 同时关闭套接字的读端和写端</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></div><p><strong>四次挥手的意义是什么？</strong></p><p>三次握手是为了确认双方都具有全双工或者说建立链接的能力，可以百分百确认一个链接是否彻底建立成功。而四次挥手是为了确认双方都正确断开了链接，如果三次握手按照四次握手来理解（也就是第二次握手的过程拆分为两次来理解），会发现握手和挥手的过程很是类似，也能保证百分百确认一个链接是否彻底断开成功，或者说，保证了两端的链接资源都被成功释放。</p><h5 id="_2-2-4-3-超时重传机制-可靠" tabindex="-1"><a class="header-anchor" href="#_2-2-4-3-超时重传机制-可靠"><span>2.2.4.3.超时重传机制(可靠)</span></a></h5><p>超时重传机制（也就是 <code>ARQ</code> 重传机制）依赖于标志位中的 <code>ACK</code>。</p><figure><img src="/work-blog-website/assets/1715743920929-DKSu1nTg.jpg" alt="1715743920929" tabindex="0" loading="lazy"><figcaption>1715743920929</figcaption></figure><p>如果数据发生了丢包（或者应答发生了丢包），一端没有接受到应答，就会经过特点的时间间隔（超时时间）进行重传。但有一个问题，如果 <code>ACK</code> 丢失了，那另外一端不就收到两份同样的数据了？不用担心，另一端可以通过头部中的序号来去重。</p><p>那超时具体应该设置时间为多少？过多和过少都不行，而且网络环境还随时间和地点不同，因此就必须是动态调整的时间。<code>Linux</code> 内核中（<code>BSD Unix、Windows</code> 而是如此）超时以 <code>500ms</code> 为一个单位进行控制，每次判定超时重发的时间都是 <code>500ms</code> 的整数倍。如果重发一次后仍然得不到应答，则会等待 <code>2*500ms</code> 在进行重传，以此类推，直达累积到一定的重传次数，<code>TCP</code> 就会认为网络或者对端主机出现异常，强制关闭连接。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：当然，有些特殊情况下，不是丢包的问题，而是“迟到”了，也会导致触发重传机制。这样对方很可能收到同一份报文，此时可以使用序号来进行去重。</p></div><p>这里还需要注意到，已经发送出去的数据不能立刻被清除，有可能还需要被重发。最少也需要在接受到 <code>ACK</code> 应答后，才被清理。因此超时重传机制背后隐藏的意义是：<strong>没有受到应答时，数据必须被保存起来</strong>！</p><h5 id="_2-2-4-4-流量控制机制-可靠" tabindex="-1"><a class="header-anchor" href="#_2-2-4-4-流量控制机制-可靠"><span>2.2.4.4.流量控制机制(可靠)</span></a></h5><p>流量控制依靠 <strong>头部字段 16 位窗口大小</strong> 和 <strong>确认应答机制</strong>。</p><p>接收端处理数据的速度是有限的，如果发送端发的太快，导致接收端的缓冲区被打满, 这个时候如果发送端继续发送，就会造成丢包，继而引起丢包重传等等一系列连锁反应。尽管“确认应答机制”和“超时重传机制”可以保证对端处理完后收到丢包的数据报，但是这不合理，报文传输是有代价的，一个大概率内容正确无误的报文仅仅因为对端缓冲区不够存储就进行丢弃，未免太过于铺张浪费。</p><p>既然对端缓冲区已经无法接受更多的报文了，您也许会有两种优化思路：</p><ul><li>提高对端业务的处理速度，但这很多时候和软件设计以及复杂的业务有关，有些时候不是说提高就提高的</li><li>根据对端的缓冲区接受能力，减少本端的发送频次，避免对端缓存压力过大，这种方案容易想到，实现成本也比较提</li></ul><p>而 <code>TCP</code> 支持根据接收端的处理能力, 来决定发送端的发送速度，这个机制就叫做“流量控制”。在报文应答中，对端接受的同时，将自己可以接收的缓冲区大小放入 <code>TCP</code> 首部中的“窗口大小”字段, 通过 <code>ACK</code> 报文通知发送数据的本端。</p><p>窗口大小字段越大, 说明网络的吞吐量越高。对端一旦发现自己的缓冲区快满了, 就会将窗口大小设置成一个更小的值通知给本端。</p><p>本端接受到这个窗口之后, 就会减慢自己的发送速度。如果接收端缓冲区满了, 就会将窗口置为 <code>0</code>。这时本端不再发送数据, 但需要定期发送一个窗口探测数据段，使对端把窗口大小告诉本端，检测是否有缓存空间进行后续的发送。</p><p>此时本端的写接口，对端的读接口，在现象上就处于阻塞状态。但发送端也不是一直陷入等待，需要有两种策略：</p><ul><li>接收端如果缓存没空间可以存储，发送端就需要定期向接收端发送探测报文，只需要头部即可，接收端也使用头部来回应</li><li>接收端如果缓存有空间可以存储，也会自主向服务端发送窗口更新的报文，也是只需要头部，此时就会用到 <code>PSH</code> 报文</li></ul><p>这两种策略就会保证一定的传输效率，解决互相等待的问题，同时流量控制机制本身也防止了报文因为溢出丢失的问题。并且可以注意到，流量控制也是两个方向的流量控制。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>PSH</code> 在接收方主动回应窗口大小这里，就有很明显的应用场景，</p></div><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>16</code> 位数字最大表示 <code>65535</code>, 那么 <code>TCP</code> 窗口最大就是 <code>65535</code> 字节么? 实际上, <code>TCP</code> 首部 <code>40</code> 字节选项中还包含了一个窗口扩大因子 <code>M</code>，实际窗口大小是窗口字段的值左移 <code>M</code> 位。</p></div><h5 id="_2-2-4-5-滑动窗口机制-效率" tabindex="-1"><a class="header-anchor" href="#_2-2-4-5-滑动窗口机制-效率"><span>2.2.4.5.滑动窗口机制(效率)</span></a></h5><p>滑动窗口机制依靠 <strong>32 位序号</strong> 和 <strong>滑动窗口大小</strong>。</p><p>滑动窗口机制实际上是 <code>TCP</code> 为效率做出的努力，实质是发送缓冲区中的一部分区域。在我们之前的应答策略中，每一个发送的数据段，都要给一个 <code>ACK</code> 确认应答，收到 <code>ACK</code> 后再发送下一个数据段。</p><p>但是这样做性能较差，尤其是数据往返的时间较长的时候。既然这样一发一收的方式性能较低，那么我们一次发送多条正文数据，就可以大大的提高性能。其中一种有效的滑动窗口机制实现如下：</p><figure><img src="/work-blog-website/assets/1716190179369-u8VPGafV.jpg" alt="1716190179369" tabindex="0" loading="lazy"><figcaption>1716190179369</figcaption></figure><ol><li>我们假设发送前四个段的时候，不需要等待任何 <code>ACK</code>，直接发送四个数据报（无需等待之前需要的报文响应 <code>ACK</code>），这四个数据报构成一个滑动窗口</li><li>只有等待收到第一个数据报的 <code>ACK</code> 后，滑动窗口才开始向后移动，继续发送第五个段的数据，依次类推</li><li>操作系统内核为了维护这个滑动窗口，需要开辟发送缓冲区来记录当前还有哪些数据没有应答，只有确认应答过的数据，才能从缓冲区删掉</li><li>这样的滑动窗口被设置的越大，则网络的吞吐率就越高</li></ol><p>这里的滑动窗口机制，把发送缓冲区看作一行逻辑内存，则滑动窗口左侧代表 <strong>数据已经发送且收到应答</strong>，滑动窗口中的数据代表 <strong>可以被立刻发送并且无需被立刻应答的数据</strong>，而滑动窗口的右侧代表 <strong>数据尚未进行发送需等待窗口挪动/或者干脆没有数据</strong>。</p><p>滑动窗口的大小该怎么决定呢？很明显需要由对方的接受能力来决定，也就是返回的滑动窗口大小 <code>win_size</code>，如果把滑动窗口的起始来理解为 <code>win_start</code>，那么 <code>win_end=win_start+win_size</code>。而 <code>win_size</code> 早在三次握手的时候就会被得知，这也是三次握手的意义之一。</p><p>因此这里您也必须意识到，滑动窗口本身的大小是会发生改变的，或者为零，或者不变，或者变长。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：这是一种典型的滑动窗口算法，有兴趣您可以前去了解一下...</p></div><p>可以看到，滑动窗口机制只能进行向右滑动，无法向左滑动，尽管一直向右滑动，但是有可能内部实现是类似环形结构，所以也不会越界。</p><figure><img src="/work-blog-website/assets/1716199838769-C-elvGBx.jpg" alt="1716199838769" tabindex="0" loading="lazy"><figcaption>1716199838769</figcaption></figure><p>那么如果出现了丢包, 如何进行重传? 依照上图，这里分两种情况讨论：</p><ul><li><p>情况一：滑动窗口中的数据包就直接丢了。当某一段报文段丢失之后，发送端会一直收到 <code>0001</code> 这样的 <code>ACK</code>，就像是在提醒发送端“我想要的是 <code>1001</code> 一样”。如果发送端主机连续 <strong>三次或以上</strong> 收到了同样的 <code>0001</code> 应答, 就会将对应的数据 <code>1001</code> 重新发送（这种重新发送不是超时重传机制，必须满足三次以上的应答条件才能重传，低于三次才采用超时重传机制）。如果其他几个报文都正确被对端收到了，就会直接返回序号 <code>4001</code> 的应答（而滑动窗口内的其他报文丢失也是类似的原理）。</p></li><li><p>情况二：数据包已经抵达但 <code>ACK</code> 丢了。这种情况下，序号较前的报文 <code>ACK</code> 丢了并不要紧, 因为可以通过后续的 <code>ACK</code> 进行确认，操作系统只要接受到了数据包，只需要把连续的序号最大的发送回去即可。这样根据序号的定义，就可以保证最大序号之前的所有数据包全都接收到了，哪怕之前的 <code>ACK</code> 丢失了也没关系，只要最后一个需要的 <code>ACK</code> 返回即可。</p><p>而就算是没有收到 <code>ACK</code> 回应导致数据包重发，接收端收到重复的数据包也会自动进行除重。</p></li></ul><p>这种机制被称为 <code>高速重发控制/快重传</code>，但是快重传是有前提条件的连续 <strong>三次或以上</strong> 收到了同样的序号的应答。因此和超时重传机制不冲突，超时重传机制只要时间满足即可。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：另外，由于底层一次发送的数据有限，必须要对 <code>TCP</code> 数据进行分割，因此才会有滑动窗口机制的使用（也算是可靠性的一种，而不仅仅是效率）。并且，滑动窗口机制实际上也有包含流量控制的意味在里头。</p></div><h5 id="_2-2-4-6-拥塞控制机制-效率" tabindex="-1"><a class="header-anchor" href="#_2-2-4-6-拥塞控制机制-效率"><span>2.2.4.6.拥塞控制机制(效率)</span></a></h5><p><code>TCP</code> 过程中，有时不仅仅是端对端的事情，还需要需要关注网络的状态。如果出现大量丢包，真的需要发送端进行重传么？网络状态极其糟糕的情况下，就不是两端的问题，而应该是网路本身的问题。出现网络阻塞现象时，继续进行重传只会更加阻塞网络（这种现象更常见出现在局域网中）。</p><p>因此 <code>TCP</code> 引入了慢启动机制，先发少量报文摸摸网络情况，也就是监控实时的网络状态。这就会产生拥塞窗口的概念，单台主机一次向网络中发送大量数据时，就会引发网络拥塞的上限值。</p><figure><img src="/work-blog-website/assets/1716543760527-B51TlXwJ.jpg" alt="1716543760527" tabindex="0" loading="lazy"><figcaption>1716543760527</figcaption></figure><p>前期以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mi>n</mi></msup></mrow><annotation encoding="application/x-tex">2^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6644em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span> 慢启动的方式来发送报文，用于检测网络状态。并且我们定义一个拥塞窗口的概念，一开始发送的时候，拥塞窗口大小为 <code>1</code> 每收到一个 <code>ACK</code> 应答，拥塞窗口就进行 <code>+1</code>，而由于是慢启动，拥塞窗口的大小一开始一是指数规律来增长的。</p><p>前期慢后期快的指数增长很符合试探和尽快恢复正常的网络通信。如果网络一直不拥塞，理论上拥塞窗口会一直线性增长，不过也有极限。在遇到慢启动的初始阈值 <code>ssthresh</code> 时，就会开始线性增长。</p><p>而在流量控制机制和滑动窗口中我提到过，<code>TCP</code> 过程中还会涉及到滑动窗口大小的传递，用来交互对端缓冲区的空间资源大小，提高传输效率。而实际上真正意义上的窗口大小，应该是 <code>min(对端接受能力, 网络拥塞程度) = min(滑动窗口数值, 拥塞窗口数值)</code>。</p><p>这样就可以考虑对端的接收能力，又可以考虑网络中的拥塞程度。并且既是拥塞窗口的数值较大，也会采用较小的滑动窗口数值来作为报文中滑动窗口大小。而即使对端滑动窗口较大，而阻塞窗口较小时，就会采用阻塞窗口作为报文中的滑动窗口大小。</p><p>一旦遇到了网络阻塞，就会重新开始初始化拥塞窗口的大小，并且稍微减低一下阈值大小，让后续的增长幅度不要过大。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：上述不断增长到拥塞点时，就可以动态检测网络的状态。</p></div><h5 id="_2-2-4-7-延迟应答机制-效率" tabindex="-1"><a class="header-anchor" href="#_2-2-4-7-延迟应答机制-效率"><span>2.2.4.7.延迟应答机制(效率)</span></a></h5><p>怎么保证对方同步给自己更大的接受能力呢？如果对端收到数据后立刻应答，那么窗口可能比较小（这是肯定的，因为本次发送了很多数据过去）。这个时候等待上层取走缓冲区后再应答，就可以提高吞吐量，进而提高传输效率（因为实际上对端读取缓冲区的速度有可能很快）。</p><p>具体的延迟应答参数，也是依靠操作系统中协议栈的具体实现，而且这里的实现也很复杂，尤其受到各种因素的影响。这个机制提高的效率也是概率性的，设置太短没效果，设置太长引发超时误判。因此一般通过两种机制来实现：</p><ul><li>可设定每隔 <code>N</code> 个数据包才应答一次（可以通过序号实现）</li><li>或者将要超过最大延迟时间就应答一次（根据超时传输实现）</li></ul><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：一般操作系统可能会跟倾向于第一种实现，但是也不排除其他的实现方案。</p></div><h5 id="_2-2-4-8-捎带应答机制-效率" tabindex="-1"><a class="header-anchor" href="#_2-2-4-8-捎带应答机制-效率"><span>2.2.4.8.捎带应答机制(效率)</span></a></h5><p>捎带应答机制需要依靠两个序号，并且一定需要两个。</p><p>由于 <code>TCP</code> 的实现是全双工的，为了效率，在 <code>TCP</code> 过程中可以把 <code>ACK</code> 应答报文的头部和下次要正文合起来发送，也就是“捎带”。这种机制的原理我们在前面也提到过，也就是类似两端都需要进行读写的场景中。</p><p>这就意味着，<code>TCP</code> 过程中大部分的报文都会携带完整的正文数据，并且可能出现既是响应也是请求的 <code>tcp</code> 报文。而这也是为什么需要在报头中有两个序号，两个序号有可能被同时使用。</p><figure><img src="/work-blog-website/assets/1715662359683-CwpUklyA.jpg" alt="1715662359683" tabindex="0" loading="lazy"><figcaption>1715662359683</figcaption></figure><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：也有人认为一个 <code>tcp</code> 报文被同时设置为两种状态标志位后也算一种捎带应答。</p></div><h4 id="_2-2-5-协议目的" tabindex="-1"><a class="header-anchor" href="#_2-2-5-协议目的"><span>2.2.5.协议目的</span></a></h4><p>而到此，<code>TCP</code> 协议实现了传输层的目标：</p><ul><li>解决了发多少的问题，例如滑动窗口机制</li><li>解决了什么时候发的问题，看操作系统的实现，达到某个条件后就一次性发送</li><li>解决了丢失了怎么办的问题，丢失会有各种机制来保证重传，例如超时重传</li></ul><h3 id="_2-3-传输粘包问题" tabindex="-1"><a class="header-anchor" href="#_2-3-传输粘包问题"><span>2.3.传输粘包问题</span></a></h3><p>由于 <code>TCP</code> 不关心字节流数据的格式，就有可能出现多个报文黏着，导致产生多读或少读的 <strong>粘包问题</strong>。我们之前通过使用 <code>HTTP</code> 协议来解决这个问题。通过明确报文之间的边界，如 <code>自描述数据大小的字段和分隔符配合使用、特殊字符、定长报文</code> 这些常见的方案组合起来解决报文不完整的问题。</p><div class="hint-container caution"><p class="hint-container-title">警告</p><p>警告：因此我们之前写的关于 <code>TCP</code> 的代码，只要不携带 <code>HTTP</code> 或者自定义协议的，都是不严谨的代码，但凡出现大量数据发送的场景，就有可能出现不完整的情况。</p></div><p>而 <code>UDP</code> 发送时，对端要么收到完整的报文，要么干脆就拒绝接收（这很像原子性），因此就不会出现上述的粘包问题。</p><h3 id="_2-4-链接异常情况" tabindex="-1"><a class="header-anchor" href="#_2-4-链接异常情况"><span>2.4.链接异常情况</span></a></h3><p>当进程终止时，就会自动释放文件描述符，关闭就是在进行四次挥手，不影响底层链接的正常释放。机器重启的情况也和终止类似，但如果是机器断电或者网线断开呢，这种异常会怎么办？</p><p>我们假设是发送端断电了，没机会进行四次挥手。但其实此时的接收端维护的链接不会什么都不做，会进行一定的 <strong>保活</strong> 机制。接收端会定期向发送端发送保活报文，确保链接存活，询问多次毫无应答时，就会把这个链接自动关闭（甚至您理解为一些定时器操作也不是不行）。</p><p>不过这种保活策略在 <code>TCP</code> 中的实现可能时间较长，因此这种定时机制一般在应用层中可以设置更加灵活的保活策略，类似的策略也被称为 <strong>心跳机制</strong>。</p><p>如果还没触发保活定时器，发送端立刻恢复了网络，但是发送端知道曾经出现了异常提前把链接释放了，而如果接收端依旧在使用旧链接，就有可能向发送端发送数据，发送端就会收到莫名的回应（没有三次握手建立链接就得到的回应），因此本端就会要求对端重新连接，也就是发送 <code>ACK+RESET</code> 报文。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>QQ</code> 为了节省资源，会短暂下线 <code>QQ</code> 用户，等到用户需要使用时才重新连接，也是类似的原理。</p></div><h3 id="_2-5-参与握手问题" tabindex="-1"><a class="header-anchor" href="#_2-5-参与握手问题"><span>2.5.参与握手问题</span></a></h3><p><code>accpet()</code> 要不要参与传输三次握手的过程呢？实际上是不需要的，这个函数本身在做的事情就是从底层直接获取已经建立好的连接。如果不调用 <code>accept()</code> 也会连接成功，这点可以使用 <code>netstart</code> 验证。</p><p>那如果上层来不及调用 <code>accept()</code>，并且对端还来了大量的链接，难道所有链接都应该连接上么？肯定不行，但这就涉及到 <code>listen()</code> 的第二个参数了，我一直都刻意忽略这个参数的讲解，因为只有在这里才能讲解清楚。</p><p><code>listen()</code> 的第二个参数 <code>backlog</code> 可以让操作系统维护有限的链接个数，超过数量 <code>backlog+1</code> 的链接在进行三次握手过程中会陷入停滞或者说阻塞的状态，没法彻底完成三次握手。因此这个参数可以让访问同一台主机的同一个端口的众多客户端能够排队进行等待。</p><p>一旦设置了队列长度，但其他已经完成三次握手的链接又都是长连接，就会导致其他后来的新链接阻塞处于 <code>SYN_RCVD(同步收到)</code> 状态。只有之前的长连接关闭时，后来的链接才能继续进行完整的三次握手过程（这点可以多次使用 <code>telnet</code> 链接服务端程序来查看，会看到类似 <code>Trying...</code> 的输出，<code>telnet</code> 就像卡住一样）。</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>注意：上述现象可以在某些版本的操作系统中无法体现，没有连接上的链接可能直接就不显示了。但是 <code>telnet</code> 会出现卡住的情况，也就是一直显示 <code>Trying...</code> 的字眼，并且如果时间过长还会自动取消 <code>telnet</code>...</p></div><p>其中，完成连接所有链接就叫做全连接队列，未完成连接所有链接就叫半连接队列。、</p><div class="hint-container warning"><p class="hint-container-title">注意</p><p>注意：这个链接在两端都存在，所以在发送端中处于半链接队列中的状态可能是 <code>SYN_SENT</code>，而在接收端中处于半链接队列中的状态可能是 <code>SYN_RECV</code>。</p></div><p>因此我们遗漏的这个参数就是设置全链接列队中链接的最大个数为 <code>backlog+1</code>，并且这个参数也一般取决于实际应用中。</p><p>这个队列可以让服务器断开某些链接时，可以立刻从队列中获取新的链接，避免出现服务空闲（也算是链接的一种缓冲区）。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：因此有时为了避免长链接占用资源过多，除了定时断开链接的机制，也可以限制长链接队列的最大数目。</p></div><h2 id="_3-查看传输状态" tabindex="-1"><a class="header-anchor" href="#_3-查看传输状态"><span>3.查看传输状态</span></a></h2><p>再次强调一下，在应用层时解决数据使用的问题，下三层解决网络通信的细节，而传输层保证将数据可靠得从 <code>A</code> 到 <code>B</code> 进行传送。传输层的目标：<strong>提供端到端的通信服务，确保一定程度上可靠的数据传输，并且解决核心三个问题，要发多少、什么时候发、丢失了怎么办</strong>。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：而网络层需要解决的就是提供将数据从 <code>A</code> 送到 <code>B</code> 能力（有能力并不一定能做到，而是有较大概率做到，做提供能力的工作，不保证可靠性，让传输层来做到），我下一章节要细讲的就是网络层协议之一的 <code>IP</code> 协议...</p></div><p>而在 <code>TCP/IP</code> 协议中，我相信您也一定可以注意到，使用 <code>源IP + 源PORT + 目的IP + 目的PORT + 协议号</code> 五元组就可以确定两进程之间的通信。您可以使用 <code>netstat</code> 来查看，下面是 <code>netstat</code> 命令的常用参数（有些需要 <code>sudo</code>）：</p><ol><li><code>-n</code>：拒接显示别名的进程，则使用数字格式显示地址和端口号，而不进行 <code>DNS</code> 解析</li><li><code>-l</code>：仅显示正在侦听的端口</li><li><code>-t</code>：显示 <code>TCP</code> 连接</li><li><code>-u</code>：显示 <code>UDP</code> 连接</li><li><code>-p</code>：显示建立相关链接的程序名</li><li><code>-a</code>：显示所有连接和侦听端口（不加这个参数的话，默认不显示 <code>LISTEN</code> 相关）</li></ol><div class="hint-container note"><p class="hint-container-title">注</p><p>吐槽：常用的就是组合参数就是 <code>nltp/nlup</code>，<strong>您(n)</strong> 在实际开发中会 <strong>老(l)</strong> 是使用 <code>TCP/UDP(tp/up)</code> 的状态检测。</p></div><p>另外，您可能检测会遇到检测占用某些端口的情况，此时可以使用指令 <code>pidof &lt;服务名称</code> 得到对应网络服务占用的 <code>pid</code>，再结合管道得到 <code>pidof &lt;服务名&gt; | xargs kill -9</code> 即可杀死该进程。</p><div class="hint-container important"><p class="hint-container-title">重要</p><p>补充：<code>xargs</code> 可以从标准输入读取数据，转化为命令行参数交给命令行，类似还有 <code>ls | xargs touch</code> 来更新所有文件的改动时间。</p></div><p>使用鲨鱼完整走完 <code>TCP</code> 过程，待补充...</p><h2 id="_4-自主实现可靠传输" tabindex="-1"><a class="header-anchor" href="#_4-自主实现可靠传输"><span>4.自主实现可靠传输</span></a></h2><p>其实就是 <code>UDP</code> 封装得到 <code>TCP</code> 的过程，引入和 <code>TCP</code> 类似的字段，定制和 <code>TCP</code> 类似的机制，最终就包装为一个类 <code>TCP</code> 协议。</p><h2 id="_5-网卡和操作系统" tabindex="-1"><a class="header-anchor" href="#_5-网卡和操作系统"><span>5.网卡和操作系统</span></a></h2><p>网卡作为设备，接收到网络数据后，就会向 <code>CPU</code> 发送中断信号，逼迫 <code>CPU</code> 运行操作系统中注册的网卡驱动程序，进而把网卡中的网络数据读取到内存中。</p><p>而内存根据网络协议栈来读取网络数据，一直到 <code>UDP/TCP</code> 的缓冲区中，这个过程中有繁琐的交付和封装。</p><p>而只要是在缓冲区中的数据，就类似文件缓冲区，可以使用一个描述符来被一个进程所读取，因此网络通信可以使用类似文件套接字的原理和文件是类似的。</p><p>相关的结构体描述中，也有类似 <code>struct_file{};</code> 的结构 <code>struct_socket{};</code>，内部的 <code>prot_ops</code> 字段指向的就是各类的网络方法（例如 <code>bind()</code>），内部还有发送和接受双链表缓冲区的相关字段。</p><p>因此，我们还可以在内核中找到 <code>inet_sock{};</code> 或者 <code>inet_connection_sock{};</code> 等等诸多的结构体。</p><p>这些说出来很多很复杂，已经是内核层次的内容了，但足以说明问题。</p></div><!----><!----><div class="vp-doc-copyright" data-v-eccffa44><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-8803b277><a href="#doc-copyright" class="header-anchor" data-v-8803b277><span data-v-8803b277><!--[-->版权所有<!--]--></span></a></h2><div class="hint-container tip copyright-container" data-v-4a95ad3f><p data-v-4a95ad3f><span data-v-4a95ad3f>版权归属：</span><a class="vp-link no-icon link" href="https://github.com/limou3434" target="_blank" rel="noreferrer" data-v-4a95ad3f data-v-a73080b7><!--[-->limou3434<!--]--><!----></a></p><!----><p data-v-4a95ad3f><span data-v-4a95ad3f>许可证：</span><a class="vp-link no-icon link" href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noreferrer" data-v-4a95ad3f data-v-a73080b7><!--[-->署名 4.0 国际 (CC-BY-4.0)<!--]--><!----></a><!--[--><span class="vpi-license-cc" data-v-4a95ad3f></span><span class="vpi-license-by" data-v-4a95ad3f></span><!--]--></p></div></div></div></main><footer class="vp-doc-footer" data-v-eccffa44 data-v-a4d41ee7><!--[--><!--]--><div class="edit-info" data-v-a4d41ee7><div class="edit-link" data-v-a4d41ee7><a class="vp-link no-icon link edit-link-button" href="https://github.com/limou3434/work-blog-website/edit/main/docs/notes/1.编码修养/3.系统网络/022_ljp_2024_03_28_传输层.md" target="_blank" rel="noreferrer" data-v-a4d41ee7 data-v-a73080b7><!--[--><span class="vpi-square-pen edit-link-icon" aria-label="edit icon" data-v-a4d41ee7></span> 编辑此页<!--]--><!----></a></div><!----></div><div class="contributors" aria-label="Contributors" data-v-a4d41ee7><span class="contributors-label" data-v-a4d41ee7>贡献者: </span><span class="contributors-info" data-v-a4d41ee7><!--[--><!--[--><span class="contributor" data-v-a4d41ee7>limou3434</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-a4d41ee7><div class="pager" data-v-a4d41ee7><a class="vp-link no-icon link pager-link prev" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/u9tjrmxs/" data-v-a4d41ee7 data-v-a73080b7><!--[--><span class="desc" data-v-a4d41ee7>上一页</span><span class="title" data-v-a4d41ee7>应用层</span><!--]--><!----></a></div><div class="pager" data-v-a4d41ee7><a class="vp-link no-icon link pager-link next" href="/work-blog-website/1.%E7%BC%96%E7%A0%81%E4%BF%AE%E5%85%BB/3.%E7%B3%BB%E7%BB%9F%E7%BD%91%E7%BB%9C/dh22vht2/" data-v-a4d41ee7 data-v-a73080b7><!--[--><span class="desc" data-v-a4d41ee7>下一页</span><span class="title" data-v-a4d41ee7>网络层</span><!--]--><!----></a></div></nav></footer><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;" data-v-eccffa44><div style="display: flex;
align-items: center;
justify-content: center;
height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);
--icon-size: 48px;
display: inline-block;
width: var(--icon-size);
height: var(--icon-size);
background-color: currentcolor;
-webkit-mask-image: var(--loading-icon);
mask-image: var(--loading-icon);
"></span></div></div><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-f64889e1 data-v-7af942b0><span class="percent" data-allow-mismatch data-v-7af942b0>0%</span><span class="show icon vpi-back-to-top" data-v-7af942b0></span><svg aria-hidden="true" data-v-7af942b0><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-7af942b0></circle></svg></button><footer class="vp-footer has-sidebar" vp-footer data-v-f64889e1 data-v-6df181e1><!--[--><div class="container" data-v-6df181e1><p class="message" data-v-6df181e1>Make by <a target="_blank" href="https://github.com/limou3434">Work</a></p><p class="copyright" data-v-6df181e1>MIT</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><div class="border top-right vp-bulletin preset"><button type="button" class="close"><span class="vpi-close"></span></button><!--[--><h2>本站公告</h2><div class="container"><div class="bulletin-content content vp-doc" data-v-4ae7319c><p data-v-4ae7319c>本网站正在不断升级中，若有 bug 可以在本开发者的对应项目下提交 <a href="https://github.com/limou3434/work-blog-website/issues" target="_blank" data-v-4ae7319c>issues</a>。 您在使用中的任何问题也可以加入我们的 QQ 群聊一起讨论。</p><img src="/work-blog-website/assets/qqtlq-CvHrqwx-.png" alt="讨论群" data-v-4ae7319c></div></div><!--]--></div><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/work-blog-website/assets/app-DcSFSDZX.js" defer></script></body></html>