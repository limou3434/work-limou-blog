---
createTime: 2025/04/16 18:29:46
permalink: /2.ä¸šåŠ¡å¼€å‘/1p5pwex9/
---

# Nacos

## 1.Nacos çš„å…¨é¢æ¦‚è¿°

[Nacos](https://nacos.io/) æ˜¯ `Dynamic Naming and Configuration Service` çš„é¦–å­—æ¯ç®€ç§°ï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚å®ƒæä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚å®é™…ä¸Šï¼Œ`Nacos` ä¸ä»…æ”¯æŒé…ç½®ç®¡ç†ï¼Œå®ƒè¿˜æ”¯æŒæœåŠ¡å‘ç°ï¼ˆä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼‰ï¼Œä»¥ä¸‹æ˜¯å®˜ç½‘æ€»ç»“çš„ `Nacos` åœ°å›¾ï¼Œè€Œæœ¬æ–‡æ¡£åªä½¿ç”¨å®ƒçš„é…ç½®ç®¡ç†åŠŸèƒ½ã€‚

![img](./assets/NVwGzUD9yp1DcdcU.webp)

## 2.Nacos çš„åŸºæœ¬åŠŸèƒ½

è¦å­¦ä¼š `Nacos` é…ç½®ç®¡ç†ï¼Œå°±å…ˆè¦çŸ¥é“å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

- **Namespace** å‘½åç©ºé—´ï¼šå‘½åç©ºé—´ç”¨äºéš”ç¦»ä¸åŒçš„é…ç½®é›†ã€‚å®ƒå…è®¸åœ¨åŒä¸€ä¸ª `Nacos` é›†ç¾¤ä¸­å°†ä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰æˆ–è€…ä¸åŒçš„ä¸šåŠ¡çº¿çš„é…ç½®è¿›è¡Œéš”ç¦»ï¼ˆé»˜è®¤æä¾›äº†ä¸€ä¸ª `public` å‘½åç©ºé—´ï¼‰ã€‚åœ¨å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­ï¼Œæˆ–è€…éœ€è¦åŒºåˆ†ä¸åŒçš„ç¯å¢ƒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å‘½åç©ºé—´ã€‚ä¾‹å¦‚ï¼Œå¼€å‘ç¯å¢ƒçš„é…ç½®å’Œç”Ÿäº§ç¯å¢ƒçš„é…ç½®å®Œå…¨éš”ç¦»ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„å‘½åç©ºé—´æ¥ç®¡ç†ã€‚
- **Group** ç»„ï¼šé…ç½®ç»„æ˜¯ç”¨äºå°†å¤šä¸ªç›¸å…³çš„é…ç½®é¡¹è¿›è¡Œåˆ†ç±»ç®¡ç†çš„é€»è¾‘åˆ†ç»„æœºåˆ¶ã€‚æ¯ä¸ªé…ç½®é¡¹å¯ä»¥å±äºä¸åŒçš„ç»„ï¼Œä»¥ä¾¿äºé…ç½®ç®¡ç†ã€‚ å½“ä¸€ä¸ªåº”ç”¨æœ‰å¤šä¸ªæ¨¡å—ï¼Œä¸”ä¸åŒæ¨¡å—ä¹‹é—´å…±äº«éƒ¨åˆ†é…ç½®æ—¶ï¼Œå¯ä»¥ç”¨ç»„æ¥å¯¹è¿™äº›æ¨¡å—çš„é…ç½®è¿›è¡Œåˆ†ç±»å’Œç®¡ç†ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿä¸­çš„â€œæ”¯ä»˜æœåŠ¡â€å’Œâ€œè®¢å•æœåŠ¡â€å¯èƒ½éœ€è¦ç”¨ä¸åŒçš„ç»„æ¥å­˜å‚¨å„è‡ªçš„é…ç½®ã€‚
- **Data ID** æ ‡è¯†ï¼š`Data ID` æ˜¯ä¸€ä¸ªå”¯ä¸€çš„é…ç½®æ ‡è¯†ç¬¦ï¼Œé€šå¸¸ä¸å…·ä½“çš„åº”ç”¨ç¨‹åºç›¸å…³ã€‚é€šè¿‡ `Data ID`ï¼Œ`Nacos` çŸ¥é“å¦‚ä½•è·å–ç‰¹å®šåº”ç”¨çš„æŸä¸ªå…·ä½“é…ç½®ã€‚ æ¯ä¸ªåº”ç”¨çš„é…ç½®éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ `Data ID`ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæ”¯ä»˜ç³»ç»Ÿå¯èƒ½æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶å« `com.payment.pay-service.yaml`ï¼Œè¿™å°±æ˜¯å®ƒçš„ `Data ID`ã€‚
- **Config Listener** é…ç½®ç›‘å¬å™¨ï¼šé…ç½®ç›‘å¬å™¨ç”¨äºè®©å®¢æˆ·ç«¯å®æ—¶ç›‘å¬ `Nacos` é…ç½®ä¸­å¿ƒä¸­çš„é…ç½®å˜åŒ–ï¼Œå¯ä»¥è‡ªåŠ¨æ„ŸçŸ¥é…ç½®çš„æ›´æ–°å¹¶åšå‡ºç›¸åº”çš„å¤„ç†ã€‚åœ¨éœ€è¦åŠ¨æ€è°ƒæ•´é…ç½®çš„åœºæ™¯ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚è°ƒæ•´ç¼“å­˜å¤§å°ã€åˆ‡æ¢ä¸åŒçš„æœåŠ¡ç«¯ç‚¹ç­‰ï¼Œåº”ç”¨å¯ä»¥é€šè¿‡ç›‘å¬å™¨åŠæ—¶æ„ŸçŸ¥è¿™äº›å˜åŒ–å¹¶åº”ç”¨æ–°çš„é…ç½®ã€‚

## 3.Nacos çš„ä½¿ç”¨æ•™ç¨‹

### 3.1.ç»„ä»¶éƒ¨ç½²

æ¨é€é…ç½®çš„æ–¹æ³•ä¸€èˆ¬æœ‰ä»¥ä¸‹æ–¹å¼ï¼š

- `Nacos` æ§åˆ¶å°
- [åº”ç”¨ç¨‹åº SDK](https://nacos.io/zh-cn/docs/quick-start-spring-boot.html)
- [Open API](https://nacos.io/zh-cn/docs/open-api.html)

è€Œç›‘å¬æ–¹æ³•ä¸€èˆ¬æ˜¯ä½¿ç”¨ `SDK` é…ç½® [Config Listener](https://nacos.io/zh-cn/docs/sdk.html) ã€‚

```java
String serverAddr = "{serverAddr}";
String dataId = "{dataId}";
String group = "{group}";
Properties properties = new Properties();
properties.put("serverAddr", serverAddr);
ConfigService configService = NacosFactory.createConfigService(properties);
String content = configService.getConfig(dataId, group, 5000);
System.out.println(content);
configService.addListener(dataId, group, new Listener() {
	@Override
	public void receiveConfigInfo(String configInfo) {
		System.out.println("recieve1:" + configInfo);
	}
	@Override
	public Executor getExecutor() {
		return null;
	}
});

// æµ‹è¯•è®©ä¸»çº¿ç¨‹ä¸é€€å‡ºï¼Œå› ä¸ºè®¢é˜…é…ç½®æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹é€€å‡ºå®ˆæŠ¤çº¿ç¨‹å°±ä¼šé€€å‡º, æ­£å¼ä»£ç ä¸­æ— éœ€ä¸‹é¢ä»£ç 
while (true) {
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        e.printStackTrace();
    }
}
```

æˆ–è€…ç›´æ¥é€šè¿‡æ³¨è§£è¯»å– `value`ï¼Œä¹Ÿèƒ½å¤Ÿå®æ—¶è·å–åˆ°æœ€æ–°çš„é…ç½®å€¼ï¼š

```java
@Controller
@RequestMapping("config")
public class ConfigController {

    @NacosValue(value = "${useLocalCache:false}", autoRefreshed = true)
    private boolean useLocalCache;

    @RequestMapping(value = "/get", method = GET)
    @ResponseBody
    public boolean get() {
        return useLocalCache;
    }
}
```

å¯¹ `Nacos` æœ‰åˆæ­¥äº†è§£åï¼Œä¸‹é¢æˆ‘ä»¬åœ¨ `work-user-centre` ä¸­å®ç°åŸºäº `Nacos` å®ç°é™æ€ `IP` é»‘åå•éœ€æ±‚ã€‚é¦–å…ˆæ‚¨éœ€è¦éƒ¨ç½²å¥½ `Nacos` æ§åˆ¶å°ï¼Œæˆ‘ä»¬ä½¿ç”¨æ§åˆ¶å°æ¨é€é…ç½®ï¼Œæ³¨è§£ç›‘å¬é…ç½®çš„æ–¹æ¡ˆã€‚å‚è€ƒä¸‹é¢çš„ `docker-compose` æ¥å¿«é€Ÿä½¿ç”¨ `Docker` éƒ¨ç½²ï¼Œæˆ–è€… [å‚è€ƒå®˜æ–¹éƒ¨ç½²æ–‡æ¡£](https://nacos.io/docs/latest/manual/admin/deployment/deployment-overview/?spm=5238cd80.2ef5001f.0.0.3f613b7cljRvDF)ã€‚

```yaml
services:  
  work-nacos:
    image: nacos/nacos-server:v2.5.1
    container_name: work-nacos
    restart: always
    ports:
      - "8848:8848"
      - "9848:9848"
    environment:
      MODE: standalone # å•æœºéƒ¨ç½²æ¨¡å¼
      NACOS_AUTH_TOKEN: au3y/JinInzSQu5hxaQQSiyvN3kMcfgOLcFRA4AHrUE= # ä½¿ç”¨ openssl rand -base64 32 ç”Ÿæˆ
      NACOS_AUTH_IDENTITY_KEY: username
      NACOS_AUTH_IDENTITY_VALUE: root
      NACOS_AUTH_ENABLE: true # å¼€å¯æƒé™ç³»ç»Ÿ
    networks:
      - work-network
      
```

è®¿é—® `http://127.0.0.8848` å°±å¯ä»¥è®¿é—® `Nacos`ã€‚

### 3.2.å¿«é€Ÿä½¿ç”¨

ç„¶åå®šä¹‰æˆ‘ä»¬çš„ `IP` é™åˆ¶é…ç½®æ–‡ä»¶ï¼Œå‘½åç©ºé—´ä½¿ç”¨é»˜è®¤çš„å³å¯ï¼Œ`Data ID` å¡«å†™ä¸ºé¡¹ç›®çš„åç§° `workusercentre`ï¼Œ`Group` é»˜è®¤ä¸º `DEFAULT_GROUP` å³å¯ã€‚

![image-20250418164547083](./assets/image-20250418164547083.png)

![image-20250418164846737](./assets/image-20250418164846737.png)

æ¥ä¸‹æ¥æˆ‘ä»¬é…ç½®åœ¨ `Spring Boot2.7.2` ä¸­çš„ç›‘å¬é…ç½®ã€‚

```xml
<dependency>Elasticsearch å…¥é—¨
å¯å‚è€ƒ ç¼–ç¨‹å¯¼èˆª - èšåˆæœç´¢é¡¹ç›® çš„ç¬”è®°ï¼Œè¯¥é¡¹ç›®ç³»ç»Ÿè®²è§£è¿‡ Elasticsearchã€‚

1ã€ä»€ä¹ˆæ˜¯ Elasticsearchï¼Ÿ
Elasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¼€æºçš„æœç´¢å¼•æ“ï¼Œä¸“é—¨ç”¨äºå¤„ç†å¤§è§„æ¨¡çš„æ•°æ®æœç´¢å’Œåˆ†æã€‚å®ƒåŸºäº Apache Lucene æ„å»ºï¼Œå…·æœ‰å®æ—¶æœç´¢ã€åˆ†å¸ƒå¼è®¡ç®—å’Œé«˜å¯æ‰©å±•æ€§ï¼Œå¹¿æ³›ç”¨äº å…¨æ–‡æ£€ç´¢ã€æ—¥å¿—åˆ†æã€ç›‘æ§æ•°æ®åˆ†æ ç­‰åœºæ™¯ã€‚

å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/docsï¼Œå»ºè®®å…¥é—¨åé˜…è¯»ä¸€éï¼Œäº†è§£æ›´å¤šå®ƒçš„ç‰¹æ€§ã€‚

2ã€Elasticsearch ç”Ÿæ€
Elasticsearch ç”Ÿæ€ç³»ç»Ÿéå¸¸ä¸°å¯Œï¼ŒåŒ…å«äº†ä¸€ç³»åˆ—å·¥å…·å’ŒåŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·å¤„ç†ã€åˆ†æå’Œå¯è§†åŒ–æ•°æ®ï¼ŒElastic Stack æ˜¯å…¶æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚

Elastic Stackï¼ˆä¹Ÿç§°ä¸º ELK Stackï¼‰ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š

Elasticsearchï¼šæ ¸å¿ƒæœç´¢å¼•æ“ï¼Œè´Ÿè´£å­˜å‚¨ã€ç´¢å¼•å’Œæœç´¢æ•°æ®ã€‚
Kibanaï¼šå¯è§†åŒ–å¹³å°ï¼Œç”¨äºæŸ¥è¯¢ã€åˆ†æå’Œå±•ç¤º Elasticsearch ä¸­çš„æ•°æ®ã€‚
Logstashï¼šæ•°æ®å¤„ç†ç®¡é“ï¼Œè´Ÿè´£æ•°æ®æ”¶é›†ã€è¿‡æ»¤ã€å¢å¼ºå’Œä¼ è¾“åˆ° Elasticsearchã€‚
Beatsï¼šè½»é‡çº§çš„æ•°æ®ä¼ è¾“å·¥å…·ï¼Œæ”¶é›†å’Œå‘é€æ•°æ®åˆ° Logstash æˆ– Elasticsearchã€‚
Kibana æ˜¯ Elastic Stack çš„å¯è§†åŒ–ç»„ä»¶ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å›¾è¡¨ã€åœ°å›¾å’Œä»ªè¡¨ç›˜æ¥å±•ç¤ºå­˜å‚¨åœ¨ Elasticsearch ä¸­çš„æ•°æ®ã€‚å®ƒæä¾›äº†ç®€å•çš„æŸ¥è¯¢æ¥å£ã€æ•°æ®åˆ†æå’Œå®æ—¶ç›‘æ§åŠŸèƒ½ã€‚

img
Logstash æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®æ”¶é›†ç®¡é“å·¥å…·ï¼Œèƒ½å¤Ÿä»å¤šä¸ªæ¥æºæ”¶é›†ã€è¿‡æ»¤ã€è½¬æ¢æ•°æ®ï¼Œç„¶åå°†æ•°æ®å‘é€åˆ° Elasticsearchã€‚Logstash æ”¯æŒä¸°å¯Œçš„è¾“å…¥ã€è¿‡æ»¤å’Œè¾“å‡ºæ’ä»¶ã€‚

img
Beats æ˜¯ä¸€ç»„è½»é‡çº§çš„æ•°æ®é‡‡é›†ä»£ç†ï¼Œè´Ÿè´£ä»ä¸åŒæ¥æºæ”¶é›†æ•°æ®å¹¶å‘é€åˆ° Elasticsearch æˆ– Logstashã€‚å¸¸è§çš„ Beats åŒ…æ‹¬ï¼š

Filebeatï¼šæ”¶é›†æ—¥å¿—æ–‡ä»¶ã€‚
Metricbeatï¼šæ”¶é›†ç³»ç»Ÿå’ŒæœåŠ¡çš„æŒ‡æ ‡ã€‚
Packetbeatï¼šç›‘æ§ç½‘ç»œæµé‡ã€‚
img
ä¸Šé¢è¿™å¼ å›¾ï¼Œä¹Ÿæ˜¯æ ‡å‡†çš„ Elastic Stack æŠ€æœ¯æ ˆçš„äº¤äº’å›¾ã€‚

3ã€Elasticsearch çš„æ ¸å¿ƒæ¦‚å¿µ
ç´¢å¼•ï¼ˆIndexï¼‰ï¼šç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼Œç´¢å¼•æ˜¯æ•°æ®å­˜å‚¨å’Œæœç´¢çš„ åŸºæœ¬å•ä½ã€‚æ¯ä¸ªç´¢å¼•å¯ä»¥å­˜å‚¨å¤šæ¡æ–‡æ¡£æ•°æ®ã€‚

æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼šç´¢å¼•ä¸­çš„æ¯æ¡è®°å½•ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„è¡Œã€‚æ–‡æ¡£ä»¥ JSON æ ¼å¼å­˜å‚¨ã€‚

å­—æ®µï¼ˆFieldï¼‰ï¼šæ–‡æ¡£ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„åˆ—ã€‚

æ˜ å°„ï¼ˆMappingï¼‰ï¼šç”¨äºå®šä¹‰ Elasticsearch ç´¢å¼•ä¸­æ–‡æ¡£å­—æ®µçš„æ•°æ®ç±»å‹åŠå…¶å¤„ç†æ–¹å¼ï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ Schema è¡¨ç»“æ„ï¼Œå¸®åŠ©æ§åˆ¶å­—æ®µçš„å­˜å‚¨ã€ç´¢å¼•å’ŒæŸ¥è¯¢è¡Œä¸ºã€‚

é›†ç¾¤ï¼ˆClusterï¼‰ï¼šå¤šä¸ªèŠ‚ç‚¹ç»„æˆçš„ç¾¤é›†ï¼Œç”¨äºå­˜å‚¨æ•°æ®å¹¶æä¾›æœç´¢åŠŸèƒ½ã€‚é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†æ•°æ®ã€‚

åˆ†ç‰‡ï¼ˆShardï¼‰ï¼šä¸ºäº†å®ç°æ¨ªå‘æ‰©å±•ï¼ŒES å°†ç´¢å¼•æ‹†åˆ†æˆå¤šä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šã€‚

å‰¯æœ¬ï¼ˆReplicaï¼‰ï¼šåˆ†ç‰‡çš„å¤åˆ¶å“ï¼Œç”¨äºæé«˜å¯ç”¨æ€§å’Œå®¹é”™æ€§ã€‚

img
å’Œæ•°æ®åº“ç±»æ¯”ï¼š

Elasticsearch æ¦‚å¿µ	å…³ç³»å‹æ•°æ®åº“ç±»æ¯”
Index	Table
Document	Row
Field	Column
Mapping	Schema
Shard	Partition
Replica	Backup
4ã€Elasticsearch å®ç°å…¨æ–‡æ£€ç´¢çš„åŸç†
1ï¼‰åˆ†è¯ï¼šElasticsearch çš„åˆ†è¯å™¨ä¼šå°†è¾“å…¥æ–‡æœ¬æ‹†è§£æˆç‹¬ç«‹çš„è¯æ¡ï¼ˆtokensï¼‰ï¼Œæ–¹ä¾¿è¿›è¡Œç´¢å¼•å’Œæœç´¢ã€‚åˆ†è¯çš„å…·ä½“è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ æ­¥ï¼š

å­—ç¬¦è¿‡æ»¤ï¼šå»é™¤ç‰¹æ®Šå­—ç¬¦ã€HTML æ ‡ç­¾æˆ–è¿›è¡Œå…¶ä»–æ–‡æœ¬æ¸…ç†ã€‚
åˆ†è¯ï¼šæ ¹æ®æŒ‡å®šçš„åˆ†è¯å™¨ï¼ˆanalyzerï¼‰ï¼Œå°†æ–‡æœ¬æŒ‰è§„åˆ™æ‹†åˆ†æˆä¸€ä¸ªä¸ªè¯æ¡ã€‚ä¾‹å¦‚ï¼Œè‹±æ–‡å¯ä»¥æŒ‰ç©ºæ ¼æ‹†åˆ†ï¼Œä¸­æ–‡ä½¿ç”¨ä¸“é—¨çš„åˆ†è¯å™¨å¤„ç†ã€‚
è¯æ±‡è¿‡æ»¤ï¼šå¯¹åˆ†è¯ç»“æœè¿›è¡Œè¿‡æ»¤ï¼Œå¦‚å»æ‰åœç”¨è¯ï¼ˆå¸¸è§ä½†æ— æ„ä¹‰çš„è¯ï¼Œå¦‚ "the"ã€"is" ç­‰ï¼‰æˆ–è¿›è¡Œè¯å½¢å½’å¹¶ï¼ˆå¦‚å°†åŠ¨è¯å˜ä¸ºåŸå½¢ï¼‰ã€‚
Elasticsearch å†…ç½®äº†å¾ˆå¤šåˆ†è¯å™¨ï¼Œæ¯”å¦‚æŒ‰ç…§ç©ºæ ¼åˆ†è¯ç­‰ï¼Œé»˜è®¤åªæ”¯æŒè‹±æ–‡ï¼Œå¯ä»¥åœ¨ å®˜æ–¹æ–‡æ¡£ äº†è§£ã€‚

2ï¼‰å€’æ’ç´¢å¼•ï¼š

å€’æ’ç´¢å¼•æ˜¯ Elasticsearch å®ç°é«˜æ•ˆæœç´¢çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚å®ƒå°†æ–‡æ¡£ä¸­çš„è¯æ¡æ˜ å°„åˆ°æ–‡æ¡£ IDï¼Œå®ç°å¿«é€ŸæŸ¥æ‰¾ã€‚

å·¥ä½œåŸç†ï¼š

æ¯ä¸ªæ–‡æ¡£åœ¨è¢«ç´¢å¼•æ—¶ï¼Œåˆ†è¯å™¨ä¼šå°†æ–‡æ¡£å†…å®¹æ‹†è§£ä¸ºå¤šä¸ªè¯æ¡ã€‚
ç„¶åï¼ŒElasticsearch ä¸ºæ¯ä¸ªè¯æ¡ç”Ÿæˆä¸€ä¸ªå€’æ’ç´¢å¼•ï¼Œè®°å½•è¯¥è¯æ¡åœ¨å“ªäº›æ–‡æ¡£ä¸­å‡ºç°ã€‚
ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªæ–‡æ¡£ï¼š

æ–‡æ¡£ 1ï¼šé±¼çš®æ˜¯å¸…é”…
æ–‡æ¡£ 2ï¼šé±¼çš®æ˜¯å¥½äºº
ä¸­æ–‡åˆ†è¯åï¼Œç”Ÿæˆçš„å€’æ’ç´¢å¼•å¤§è‡´å¦‚ä¸‹ï¼š

è¯æ¡	æ–‡æ¡£ ID
é±¼çš®	1, 2
æ˜¯	1, 2
å¸…é”…	1
å¥½äºº	2
é€šè¿‡è¿™ç§ç»“æ„ï¼ŒæŸ¥è¯¢æŸä¸ªè¯æ—¶ï¼Œå¯ä»¥å¿«é€Ÿæ‰¾åˆ°åŒ…å«è¯¥è¯çš„æ‰€æœ‰æ–‡æ¡£ã€‚

5ã€Elasticsearch æ‰“åˆ†è§„åˆ™
å®é™…åº”ç”¨ Elasticsearch æ¥å®ç°æœç´¢åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…è¦æ±‚èƒ½æœåˆ°å†…å®¹ï¼Œè€Œä¸”è¿˜è¦æŠŠå’Œç”¨æˆ·æœç´¢æœ€ç›¸å…³çš„å†…å®¹å±•ç¤ºåœ¨å‰é¢ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬äº†è§£ Elasticsearch çš„æ‰“åˆ†è§„åˆ™ã€‚

æ‰“åˆ†è§„åˆ™ï¼ˆ_Scoreï¼‰æ˜¯ç”¨äºè¡¡é‡æ¯ä¸ªæ–‡æ¡£ä¸æŸ¥è¯¢æ¡ä»¶çš„åŒ¹é…åº¦çš„è¯„åˆ†æœºåˆ¶ã€‚æœç´¢ç»“æœçš„é»˜è®¤æ’åºæ–¹å¼æ˜¯æŒ‰ç›¸å…³æ€§å¾—åˆ†ï¼ˆ_scoreï¼‰ä»é«˜åˆ°ä½ã€‚Elasticsearch ä½¿ç”¨ BM25 ç®—æ³• æ¥è®¡ç®—æ¯ä¸ªæ–‡æ¡£çš„å¾—åˆ†ï¼Œå®ƒæ˜¯åŸºäºè¯é¢‘ã€åå‘æ–‡æ¡£é¢‘ç‡ã€æ–‡æ¡£é•¿åº¦ç­‰å› ç´ æ¥è¯„ä¼°æ–‡æ¡£å’ŒæŸ¥è¯¢çš„ç›¸å…³æ€§ã€‚

æ‰“åˆ†çš„ä¸»è¦å› ç´ ï¼š

è¯é¢‘ï¼ˆTF, Term Frequencyï¼‰ï¼šæŸ¥è¯¢è¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œå‡ºç°æ¬¡æ•°è¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜ã€‚
åå‘æ–‡æ¡£é¢‘ç‡ï¼ˆIDF, Inverse Document Frequencyï¼‰ï¼šæŸ¥è¯¢è¯åœ¨æ‰€æœ‰æ–‡æ¡£ä¸­å‡ºç°çš„é¢‘ç‡ã€‚è¯åœ¨è¶Šå°‘çš„æ–‡æ¡£ä¸­å‡ºç°ï¼ŒIDF å€¼è¶Šé«˜ï¼Œå¾—åˆ†è¶Šé«˜ã€‚
æ–‡æ¡£é•¿åº¦ï¼šè¾ƒçŸ­çš„æ–‡æ¡£å¾€å¾€è¢«è®¤ä¸ºæ›´ç›¸å…³ï¼Œå› ä¸ºæŸ¥è¯¢è¯åœ¨çŸ­æ–‡æ¡£ä¸­å çš„æ¯”ä¾‹æ›´å¤§ã€‚
ä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼šå‡è®¾è¦åœ¨ Elasticsearch ä¸­æŸ¥è¯¢ é±¼çš® è¿™ä¸ªå…³é”®è¯ï¼Œç´¢å¼•ä¸­æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–‡æ¡£ï¼š

æ–‡æ¡£ 1ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ï¼Œé±¼çš®éå¸¸èªæ˜ï¼Œé±¼çš®å¾ˆå–œæ¬¢ç¼–ç¨‹ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 3 æ¬¡ã€‚
è¯¥æ–‡æ¡£è¾ƒçŸ­ï¼ŒæŸ¥è¯¢è¯ é±¼çš® çš„å¯†åº¦å¾ˆé«˜ã€‚
ç”±äº é±¼çš® åœ¨æ–‡æ¡£ä¸­å¤šæ¬¡å‡ºç°ä¸”æ–‡æ¡£è¾ƒçŸ­ï¼Œå› æ­¤å¾—åˆ†è¾ƒé«˜ï¼Œç›¸å…³æ€§è¾ƒå¼ºã€‚

æ–‡æ¡£ 2ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 1 æ¬¡ã€‚
æ–‡æ¡£éå¸¸çŸ­
å°½ç®¡æ–‡æ¡£çŸ­ï¼Œä½†æ˜¯æŸ¥è¯¢è¯å‡ºç°çš„æ¬¡æ•°å°‘ï¼Œå› æ­¤å¾—åˆ†ä¸­ç­‰ï¼Œç›¸å…³æ€§è¾ƒæ™®é€šã€‚

æ–‡æ¡£ 3ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ï¼Œä»–å–œæ¬¢å†™ä»£ç ã€‚ä»–çš„æœ‹å‹ä»¬ä¹Ÿå¾ˆå–œæ¬¢ç¼–ç¨‹å’ŒæŠ€æœ¯è®¨è®ºï¼Œå¤§å®¶ç»å¸¸ä¸€èµ·å‚ä¸å„ç§æŠ€æœ¯ä¼šè®®ï¼Œè®¨è®ºåˆ†å¸ƒå¼ç³»ç»Ÿã€æœºå™¨å­¦ä¹ å’Œäººå·¥æ™ºèƒ½ç­‰ä¸»é¢˜ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 1 æ¬¡ã€‚
æ–‡æ¡£è¾ƒé•¿ï¼Œä¸” é±¼çš® åªåœ¨æ–‡æ¡£å¼€å¤´å‡ºç°ï¼Œè¯æ¡å¯†åº¦è¾ƒä½ã€‚
ç”±äºæ–‡æ¡£å¾ˆé•¿ï¼Œé±¼çš® å‡ºç°çš„æ¬¡æ•°å°‘ï¼Œå¯†åº¦ä¹Ÿä½ï¼Œå› æ­¤å¾—åˆ†è¾ƒä½ï¼Œç›¸å…³æ€§ä¸å¼ºã€‚

å†ä¸¾ä¸ªä¾‹å­ï¼Œä»€ä¹ˆæ˜¯åå‘æ–‡æ¡£é¢‘ç‡ï¼Ÿ

å‡å¦‚è¯´ ES ä¸­æœ‰ 10 ä¸ªæ–‡æ¡£ï¼Œéƒ½åŒ…å«äº†â€œé±¼çš®â€è¿™ä¸ªå…³é”®è¯ï¼›åªæœ‰ 1 ä¸ªæ–‡æ¡£åŒ…å«äº†â€œå¸…é”…â€è¿™ä¸ªå…³é”®è¯ã€‚

ç°åœ¨ç”¨æˆ·æœç´¢â€œé±¼çš®å¸…é”…â€ï¼Œå¤§æ¦‚ç‡ä¼šæŠŠåé¢è¿™æ¡æ–‡æ¡£æœå‡ºæ¥ï¼Œå› ä¸ºæ›´ç¨€æœ‰ã€‚

å½“ç„¶ï¼Œä»¥ä¸Šåªæ˜¯ç®€å•ä¸¾ä¾‹ï¼Œå®é™…ä¸Š ES è®¡ç®—æ‰“åˆ†è§„åˆ™æ—¶ï¼Œä¼šæœ‰ä¸€å¥—è¾ƒä¸ºå¤æ‚çš„å…¬å¼ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯»ä¸‹é¢èµ„æ–™æ¥äº†è§£ï¼š

é±¼çš®æ–‡ç« ï¼šhttps://liyupi.blog.csdn.net/article/details/119176943
å®˜æ–¹æ–‡ç« ï¼šhttps://www.elastic.co/guide/en/elasticsearch/guide/master/controlling-relevance.html
6ã€Elasticsearch æŸ¥è¯¢è¯­æ³•
Elasticsearch æ”¯æŒå¤šç§æŸ¥è¯¢è¯­æ³•ï¼Œç”¨äºä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ï¼Œä¸»è¦åŒ…æ‹¬æŸ¥è¯¢ DSLã€EQLã€SQL ç­‰ã€‚

1ï¼‰DSL æŸ¥è¯¢ï¼ˆDomain Specific Languageï¼‰

ä¸€ç§åŸºäº JSON çš„æŸ¥è¯¢è¯­è¨€ï¼Œå®ƒæ˜¯ Elasticsearch ä¸­æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ–¹å¼ã€‚

ç¤ºä¾‹ï¼š

â–¼
json
å¤åˆ¶ä»£ç 
{
  "query": {
    "match": {
      "message": "Elasticsearch æ˜¯å¼ºå¤§çš„"
    }
  }
}
è¿™ä¸ªæŸ¥è¯¢ä¼šå¯¹ message å­—æ®µè¿›è¡Œåˆ†è¯ï¼Œå¹¶æŸ¥æ‰¾åŒ…å« "Elasticsearch" å’Œ "å¼ºå¤§" è¯æ¡çš„æ–‡æ¡£ã€‚

2ï¼‰EQL

EQL å…¨ç§° Event Query Languageï¼Œæ˜¯ä¸€ç§ç”¨äºæ£€æµ‹å’Œæ£€ç´¢æ—¶é—´åºåˆ— äº‹ä»¶ çš„æŸ¥è¯¢è¯­è¨€ï¼Œå¸¸ç”¨äºæ—¥å¿—å’Œå®‰å…¨ç›‘æ§åœºæ™¯ã€‚

ç¤ºä¾‹ï¼šæŸ¥æ‰¾ç‰¹å®šäº‹ä»¶

â–¼
plain
å¤åˆ¶ä»£ç 
process where process.name == "malware.exe"
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ process.name ä¸º "malware.exe" çš„æ‰€æœ‰è¿›ç¨‹äº‹ä»¶ï¼Œå¸¸ç”¨äºå®‰å…¨æ£€æµ‹ä¸­çš„æ¶æ„è½¯ä»¶åˆ†æã€‚

3ï¼‰SQL æŸ¥è¯¢

Elasticsearch æä¾›äº†ç±»ä¼¼äºä¼ ç»Ÿæ•°æ®åº“çš„ SQL æŸ¥è¯¢è¯­æ³•ï¼Œå…è®¸ç”¨æˆ·ä»¥ SQL çš„å½¢å¼æŸ¥è¯¢ Elasticsearch ä¸­çš„æ•°æ®ï¼Œå¯¹ç†Ÿæ‚‰ SQL çš„ç”¨æˆ·æ¥è¯´éå¸¸æ–¹ä¾¿ã€‚

ç¤ºä¾‹ SQL æŸ¥è¯¢ï¼š

â–¼
sql
å¤åˆ¶ä»£ç 
SELECT name, age FROM users WHERE age > 30 ORDER BY age DESC
è¿™ä¸ªæŸ¥è¯¢ä¼šè¿”å› users ç´¢å¼•ä¸­ age å¤§äº 30 çš„æ‰€æœ‰ç”¨æˆ·ï¼Œå¹¶æŒ‰å¹´é¾„é™åºæ’åºã€‚

ä»¥ä¸‹å‡ ç§ç®€å•äº†è§£å³å¯ï¼š

4ï¼‰Lucene æŸ¥è¯¢è¯­æ³•

Lucene æ˜¯ Elasticsearch åº•å±‚çš„æœç´¢å¼•æ“ï¼ŒElasticsearch æ”¯æŒç›´æ¥ä½¿ç”¨ Lucene çš„æŸ¥è¯¢è¯­æ³•ï¼Œé€‚åˆç®€å•çš„å­—ç¬¦ä¸²æŸ¥è¯¢ã€‚

ç¤ºä¾‹ Lucene æŸ¥è¯¢ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
name:Elasticsearch AND age:[30 TO 40]
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ name å­—æ®µä¸º "Elasticsearch" ä¸” age åœ¨ 30 åˆ° 40 ä¹‹é—´çš„æ–‡æ¡£ã€‚

5ï¼‰Kueryï¼ˆKQL: Kibana Query Languageï¼‰

KQL æ˜¯ Kibana çš„æŸ¥è¯¢è¯­è¨€ï¼Œä¸“é—¨ç”¨äºåœ¨ Kibana ç•Œé¢ä¸Šæ‰§è¡Œæœç´¢æŸ¥è¯¢ï¼Œå¸¸ç”¨äºä»ªè¡¨ç›˜å’Œæ•°æ®æ¢ç´¢ä¸­ã€‚

ç¤ºä¾‹ KQL æŸ¥è¯¢ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
name: "Elasticsearch" and age > 30
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ name ä¸º "Elasticsearch" ä¸” age å¤§äº 30 çš„æ–‡æ¡£ã€‚

6ï¼‰Painless è„šæœ¬æŸ¥è¯¢

Painless æ˜¯ Elasticsearch çš„å†…ç½®è„šæœ¬è¯­è¨€ï¼Œç”¨äºæ‰§è¡Œè‡ªå®šä¹‰çš„è„šæœ¬æ“ä½œï¼Œå¸¸ç”¨äºæ’åºã€èšåˆæˆ–å¤æ‚è®¡ç®—åœºæ™¯ã€‚

ç¤ºä¾‹ Painless è„šæœ¬ï¼š

â–¼
json
å¤åˆ¶ä»£ç 
{
  "query": {
    "script_score": {
      "query": {
        "match": { "message": "Elasticsearch" }
      },
      "script": {
        "source": "doc['popularity'].value * 2"
      }
    }
  }
}
è¿™ä¸ªæŸ¥è¯¢ä¼šåŸºäº populElasticsearch å…¥é—¨
å¯å‚è€ƒ ç¼–ç¨‹å¯¼èˆª - èšåˆæœç´¢é¡¹ç›® çš„ç¬”è®°ï¼Œè¯¥é¡¹ç›®ç³»ç»Ÿè®²è§£è¿‡ Elasticsearchã€‚

1ã€ä»€ä¹ˆæ˜¯ Elasticsearchï¼Ÿ
Elasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¼€æºçš„æœç´¢å¼•æ“ï¼Œä¸“é—¨ç”¨äºå¤„ç†å¤§è§„æ¨¡çš„æ•°æ®æœç´¢å’Œåˆ†æã€‚å®ƒåŸºäº Apache Lucene æ„å»ºï¼Œå…·æœ‰å®æ—¶æœç´¢ã€åˆ†å¸ƒå¼è®¡ç®—å’Œé«˜å¯æ‰©å±•æ€§ï¼Œå¹¿æ³›ç”¨äº å…¨æ–‡æ£€ç´¢ã€æ—¥å¿—åˆ†æã€ç›‘æ§æ•°æ®åˆ†æ ç­‰åœºæ™¯ã€‚

å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/docsï¼Œå»ºè®®å…¥é—¨åé˜…è¯»ä¸€éï¼Œäº†è§£æ›´å¤šå®ƒçš„ç‰¹æ€§ã€‚

2ã€Elasticsearch ç”Ÿæ€
Elasticsearch ç”Ÿæ€ç³»ç»Ÿéå¸¸ä¸°å¯Œï¼ŒåŒ…å«äº†ä¸€ç³»åˆ—å·¥å…·å’ŒåŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·å¤„ç†ã€åˆ†æå’Œå¯è§†åŒ–æ•°æ®ï¼ŒElastic Stack æ˜¯å…¶æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚

Elastic Stackï¼ˆä¹Ÿç§°ä¸º ELK Stackï¼‰ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š

Elasticsearchï¼šæ ¸å¿ƒæœç´¢å¼•æ“ï¼Œè´Ÿè´£å­˜å‚¨ã€ç´¢å¼•å’Œæœç´¢æ•°æ®ã€‚
Kibanaï¼šå¯è§†åŒ–å¹³å°ï¼Œç”¨äºæŸ¥è¯¢ã€åˆ†æå’Œå±•ç¤º Elasticsearch ä¸­çš„æ•°æ®ã€‚
Logstashï¼šæ•°æ®å¤„ç†ç®¡é“ï¼Œè´Ÿè´£æ•°æ®æ”¶é›†ã€è¿‡æ»¤ã€å¢å¼ºå’Œä¼ è¾“åˆ° Elasticsearchã€‚
Beatsï¼šè½»é‡çº§çš„æ•°æ®ä¼ è¾“å·¥å…·ï¼Œæ”¶é›†å’Œå‘é€æ•°æ®åˆ° Logstash æˆ– Elasticsearchã€‚
Kibana æ˜¯ Elastic Stack çš„å¯è§†åŒ–ç»„ä»¶ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å›¾è¡¨ã€åœ°å›¾å’Œä»ªè¡¨ç›˜æ¥å±•ç¤ºå­˜å‚¨åœ¨ Elasticsearch ä¸­çš„æ•°æ®ã€‚å®ƒæä¾›äº†ç®€å•çš„æŸ¥è¯¢æ¥å£ã€æ•°æ®åˆ†æå’Œå®æ—¶ç›‘æ§åŠŸèƒ½ã€‚

img
Logstash æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®æ”¶é›†ç®¡é“å·¥å…·ï¼Œèƒ½å¤Ÿä»å¤šä¸ªæ¥æºæ”¶é›†ã€è¿‡æ»¤ã€è½¬æ¢æ•°æ®ï¼Œç„¶åå°†æ•°æ®å‘é€åˆ° Elasticsearchã€‚Logstash æ”¯æŒä¸°å¯Œçš„è¾“å…¥ã€è¿‡æ»¤å’Œè¾“å‡ºæ’ä»¶ã€‚

img
Beats æ˜¯ä¸€ç»„è½»é‡çº§çš„æ•°æ®é‡‡é›†ä»£ç†ï¼Œè´Ÿè´£ä»ä¸åŒæ¥æºæ”¶é›†æ•°æ®å¹¶å‘é€åˆ° Elasticsearch æˆ– Logstashã€‚å¸¸è§çš„ Beats åŒ…æ‹¬ï¼š

Filebeatï¼šæ”¶é›†æ—¥å¿—æ–‡ä»¶ã€‚
Metricbeatï¼šæ”¶é›†ç³»ç»Ÿå’ŒæœåŠ¡çš„æŒ‡æ ‡ã€‚
Packetbeatï¼šç›‘æ§ç½‘ç»œæµé‡ã€‚
img
ä¸Šé¢è¿™å¼ å›¾ï¼Œä¹Ÿæ˜¯æ ‡å‡†çš„ Elastic Stack æŠ€æœ¯æ ˆçš„äº¤äº’å›¾ã€‚

3ã€Elasticsearch çš„æ ¸å¿ƒæ¦‚å¿µ
ç´¢å¼•ï¼ˆIndexï¼‰ï¼šç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼Œç´¢å¼•æ˜¯æ•°æ®å­˜å‚¨å’Œæœç´¢çš„ åŸºæœ¬å•ä½ã€‚æ¯ä¸ªç´¢å¼•å¯ä»¥å­˜å‚¨å¤šæ¡æ–‡æ¡£æ•°æ®ã€‚

æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼šç´¢å¼•ä¸­çš„æ¯æ¡è®°å½•ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„è¡Œã€‚æ–‡æ¡£ä»¥ JSON æ ¼å¼å­˜å‚¨ã€‚

å­—æ®µï¼ˆFieldï¼‰ï¼šæ–‡æ¡£ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„åˆ—ã€‚

æ˜ å°„ï¼ˆMappingï¼‰ï¼šç”¨äºå®šä¹‰ Elasticsearch ç´¢å¼•ä¸­æ–‡æ¡£å­—æ®µçš„æ•°æ®ç±»å‹åŠå…¶å¤„ç†æ–¹å¼ï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ Schema è¡¨ç»“æ„ï¼Œå¸®åŠ©æ§åˆ¶å­—æ®µçš„å­˜å‚¨ã€ç´¢å¼•å’ŒæŸ¥è¯¢è¡Œä¸ºã€‚

é›†ç¾¤ï¼ˆClusterï¼‰ï¼šå¤šä¸ªèŠ‚ç‚¹ç»„æˆçš„ç¾¤é›†ï¼Œç”¨äºå­˜å‚¨æ•°æ®å¹¶æä¾›æœç´¢åŠŸèƒ½ã€‚é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†æ•°æ®ã€‚

åˆ†ç‰‡ï¼ˆShardï¼‰ï¼šä¸ºäº†å®ç°æ¨ªå‘æ‰©å±•ï¼ŒES å°†ç´¢å¼•æ‹†åˆ†æˆå¤šä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šã€‚

å‰¯æœ¬ï¼ˆReplicaï¼‰ï¼šåˆ†ç‰‡çš„å¤åˆ¶å“ï¼Œç”¨äºæé«˜å¯ç”¨æ€§å’Œå®¹é”™æ€§ã€‚

img
å’Œæ•°æ®åº“ç±»æ¯”ï¼š

Elasticsearch æ¦‚å¿µ	å…³ç³»å‹æ•°æ®åº“ç±»æ¯”
Index	Table
Document	Row
Field	Column
Mapping	Schema
Shard	Partition
Replica	Backup
4ã€Elasticsearch å®ç°å…¨æ–‡æ£€ç´¢çš„åŸç†
1ï¼‰åˆ†è¯ï¼šElasticsearch çš„åˆ†è¯å™¨ä¼šå°†è¾“å…¥æ–‡æœ¬æ‹†è§£æˆç‹¬ç«‹çš„è¯æ¡ï¼ˆtokensï¼‰ï¼Œæ–¹ä¾¿è¿›è¡Œç´¢å¼•å’Œæœç´¢ã€‚åˆ†è¯çš„å…·ä½“è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ æ­¥ï¼š

å­—ç¬¦è¿‡æ»¤ï¼šå»é™¤ç‰¹æ®Šå­—ç¬¦ã€HTML æ ‡ç­¾æˆ–è¿›è¡Œå…¶ä»–æ–‡æœ¬æ¸…ç†ã€‚
åˆ†è¯ï¼šæ ¹æ®æŒ‡å®šçš„åˆ†è¯å™¨ï¼ˆanalyzerï¼‰ï¼Œå°†æ–‡æœ¬æŒ‰è§„åˆ™æ‹†åˆ†æˆä¸€ä¸ªä¸ªè¯æ¡ã€‚ä¾‹å¦‚ï¼Œè‹±æ–‡å¯ä»¥æŒ‰ç©ºæ ¼æ‹†åˆ†ï¼Œä¸­æ–‡ä½¿ç”¨ä¸“é—¨çš„åˆ†è¯å™¨å¤„ç†ã€‚
è¯æ±‡è¿‡æ»¤ï¼šå¯¹åˆ†è¯ç»“æœè¿›è¡Œè¿‡æ»¤ï¼Œå¦‚å»æ‰åœç”¨è¯ï¼ˆå¸¸è§ä½†æ— æ„ä¹‰çš„è¯ï¼Œå¦‚ "the"ã€"is" ç­‰ï¼‰æˆ–è¿›è¡Œè¯å½¢å½’å¹¶ï¼ˆå¦‚å°†åŠ¨è¯å˜ä¸ºåŸå½¢ï¼‰ã€‚
Elasticsearch å†…ç½®äº†å¾ˆå¤šåˆ†è¯å™¨ï¼Œæ¯”å¦‚æŒ‰ç…§ç©ºæ ¼åˆ†è¯ç­‰ï¼Œé»˜è®¤åªæ”¯æŒè‹±æ–‡ï¼Œå¯ä»¥åœ¨ å®˜æ–¹æ–‡æ¡£ äº†è§£ã€‚

2ï¼‰å€’æ’ç´¢å¼•ï¼š

å€’æ’ç´¢å¼•æ˜¯ Elasticsearch å®ç°é«˜æ•ˆæœç´¢çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚å®ƒå°†æ–‡æ¡£ä¸­çš„è¯æ¡æ˜ å°„åˆ°æ–‡æ¡£ IDï¼Œå®ç°å¿«é€ŸæŸ¥æ‰¾ã€‚

å·¥ä½œåŸç†ï¼š

æ¯ä¸ªæ–‡æ¡£åœ¨è¢«ç´¢å¼•æ—¶ï¼Œåˆ†è¯å™¨ä¼šå°†æ–‡æ¡£å†…å®¹æ‹†è§£ä¸ºå¤šä¸ªè¯æ¡ã€‚
ç„¶åï¼ŒElasticsearch ä¸ºæ¯ä¸ªè¯æ¡ç”Ÿæˆä¸€ä¸ªå€’æ’ç´¢å¼•ï¼Œè®°å½•è¯¥è¯æ¡åœ¨å“ªäº›æ–‡æ¡£ä¸­å‡ºç°ã€‚
ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªæ–‡æ¡£ï¼š

æ–‡æ¡£ 1ï¼šé±¼çš®æ˜¯å¸…é”…
æ–‡æ¡£ 2ï¼šé±¼çš®æ˜¯å¥½äºº
ä¸­æ–‡åˆ†è¯åï¼Œç”Ÿæˆçš„å€’æ’ç´¢å¼•å¤§è‡´å¦‚ä¸‹ï¼š

è¯æ¡	æ–‡æ¡£ ID
é±¼çš®	1, 2
æ˜¯	1, 2
å¸…é”…	1
å¥½äºº	2
é€šè¿‡è¿™ç§ç»“æ„ï¼ŒæŸ¥è¯¢æŸä¸ªè¯æ—¶ï¼Œå¯ä»¥å¿«é€Ÿæ‰¾åˆ°åŒ…å«è¯¥è¯çš„æ‰€æœ‰æ–‡æ¡£ã€‚

5ã€Elasticsearch æ‰“åˆ†è§„åˆ™
å®é™…åº”ç”¨ Elasticsearch æ¥å®ç°æœç´¢åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…è¦æ±‚èƒ½æœåˆ°å†…å®¹ï¼Œè€Œä¸”è¿˜è¦æŠŠå’Œç”¨æˆ·æœç´¢æœ€ç›¸å…³çš„å†…å®¹å±•ç¤ºåœ¨å‰é¢ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬äº†è§£ Elasticsearch çš„æ‰“åˆ†è§„åˆ™ã€‚

æ‰“åˆ†è§„åˆ™ï¼ˆ_Scoreï¼‰æ˜¯ç”¨äºè¡¡é‡æ¯ä¸ªæ–‡æ¡£ä¸æŸ¥è¯¢æ¡ä»¶çš„åŒ¹é…åº¦çš„è¯„åˆ†æœºåˆ¶ã€‚æœç´¢ç»“æœçš„é»˜è®¤æ’åºæ–¹å¼æ˜¯æŒ‰ç›¸å…³æ€§å¾—åˆ†ï¼ˆ_scoreï¼‰ä»é«˜åˆ°ä½ã€‚Elasticsearch ä½¿ç”¨ BM25 ç®—æ³• æ¥è®¡ç®—æ¯ä¸ªæ–‡æ¡£çš„å¾—åˆ†ï¼Œå®ƒæ˜¯åŸºäºè¯é¢‘ã€åå‘æ–‡æ¡£é¢‘ç‡ã€æ–‡æ¡£é•¿åº¦ç­‰å› ç´ æ¥è¯„ä¼°æ–‡æ¡£å’ŒæŸ¥è¯¢çš„ç›¸å…³æ€§ã€‚

æ‰“åˆ†çš„ä¸»è¦å› ç´ ï¼š

è¯é¢‘ï¼ˆTF, Term Frequencyï¼‰ï¼šæŸ¥è¯¢è¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œå‡ºç°æ¬¡æ•°è¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜ã€‚
åå‘æ–‡æ¡£é¢‘ç‡ï¼ˆIDF, Inverse Document Frequencyï¼‰ï¼šæŸ¥è¯¢è¯åœ¨æ‰€æœ‰æ–‡æ¡£ä¸­å‡ºç°çš„é¢‘ç‡ã€‚è¯åœ¨è¶Šå°‘çš„æ–‡æ¡£ä¸­å‡ºç°ï¼ŒIDF å€¼è¶Šé«˜ï¼Œå¾—åˆ†è¶Šé«˜ã€‚
æ–‡æ¡£é•¿åº¦ï¼šè¾ƒçŸ­çš„æ–‡æ¡£å¾€å¾€è¢«è®¤ä¸ºæ›´ç›¸å…³ï¼Œå› ä¸ºæŸ¥è¯¢è¯åœ¨çŸ­æ–‡æ¡£ä¸­å çš„æ¯”ä¾‹æ›´å¤§ã€‚
ä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼šå‡è®¾è¦åœ¨ Elasticsearch ä¸­æŸ¥è¯¢ é±¼çš® è¿™ä¸ªå…³é”®è¯ï¼Œç´¢å¼•ä¸­æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–‡æ¡£ï¼š

æ–‡æ¡£ 1ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ï¼Œé±¼çš®éå¸¸èªæ˜ï¼Œé±¼çš®å¾ˆå–œæ¬¢ç¼–ç¨‹ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 3 æ¬¡ã€‚
è¯¥æ–‡æ¡£è¾ƒçŸ­ï¼ŒæŸ¥è¯¢è¯ é±¼çš® çš„å¯†åº¦å¾ˆé«˜ã€‚
ç”±äº é±¼çš® åœ¨æ–‡æ¡£ä¸­å¤šæ¬¡å‡ºç°ä¸”æ–‡æ¡£è¾ƒçŸ­ï¼Œå› æ­¤å¾—åˆ†è¾ƒé«˜ï¼Œç›¸å…³æ€§è¾ƒå¼ºã€‚

æ–‡æ¡£ 2ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 1 æ¬¡ã€‚
æ–‡æ¡£éå¸¸çŸ­
å°½ç®¡æ–‡æ¡£çŸ­ï¼Œä½†æ˜¯æŸ¥è¯¢è¯å‡ºç°çš„æ¬¡æ•°å°‘ï¼Œå› æ­¤å¾—åˆ†ä¸­ç­‰ï¼Œç›¸å…³æ€§è¾ƒæ™®é€šã€‚

æ–‡æ¡£ 3ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ï¼Œä»–å–œæ¬¢å†™ä»£ç ã€‚ä»–çš„æœ‹å‹ä»¬ä¹Ÿå¾ˆå–œæ¬¢ç¼–ç¨‹å’ŒæŠ€æœ¯è®¨è®ºï¼Œå¤§å®¶ç»å¸¸ä¸€èµ·å‚ä¸å„ç§æŠ€æœ¯ä¼šè®®ï¼Œè®¨è®ºåˆ†å¸ƒå¼ç³»ç»Ÿã€æœºå™¨å­¦ä¹ å’Œäººå·¥æ™ºèƒ½ç­‰ä¸»é¢˜ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 1 æ¬¡ã€‚
æ–‡æ¡£è¾ƒé•¿ï¼Œä¸” é±¼çš® åªåœ¨æ–‡æ¡£å¼€å¤´å‡ºç°ï¼Œè¯æ¡å¯†åº¦è¾ƒä½ã€‚
ç”±äºæ–‡æ¡£å¾ˆé•¿ï¼Œé±¼çš® å‡ºç°çš„æ¬¡æ•°å°‘ï¼Œå¯†åº¦ä¹Ÿä½ï¼Œå› æ­¤å¾—åˆ†è¾ƒä½ï¼Œç›¸å…³æ€§ä¸å¼ºã€‚

å†ä¸¾ä¸ªä¾‹å­ï¼Œä»€ä¹ˆæ˜¯åå‘æ–‡æ¡£é¢‘ç‡ï¼Ÿ

å‡å¦‚è¯´ ES ä¸­æœ‰ 10 ä¸ªæ–‡æ¡£ï¼Œéƒ½åŒ…å«äº†â€œé±¼çš®â€è¿™ä¸ªå…³é”®è¯ï¼›åªæœ‰ 1 ä¸ªæ–‡æ¡£åŒ…å«äº†â€œå¸…é”…â€è¿™ä¸ªå…³é”®è¯ã€‚

ç°åœ¨ç”¨æˆ·æœç´¢â€œé±¼çš®å¸…é”…â€ï¼Œå¤§æ¦‚ç‡ä¼šæŠŠåé¢è¿™æ¡æ–‡æ¡£æœå‡ºæ¥ï¼Œå› ä¸ºæ›´ç¨€æœ‰ã€‚

å½“ç„¶ï¼Œä»¥ä¸Šåªæ˜¯ç®€å•ä¸¾ä¾‹ï¼Œå®é™…ä¸Š ES è®¡ç®—æ‰“åˆ†è§„åˆ™æ—¶ï¼Œä¼šæœ‰ä¸€å¥—è¾ƒä¸ºå¤æ‚çš„å…¬å¼ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯»ä¸‹é¢èµ„æ–™æ¥äº†è§£ï¼š

é±¼çš®æ–‡ç« ï¼šhttps://liyupi.blog.csdn.net/article/details/119176943
å®˜æ–¹æ–‡ç« ï¼šhttps://www.elastic.co/guide/en/elasticsearch/guide/master/controlling-relevance.html
6ã€Elasticsearch æŸ¥è¯¢è¯­æ³•
Elasticsearch æ”¯æŒå¤šç§æŸ¥è¯¢è¯­æ³•ï¼Œç”¨äºä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ï¼Œä¸»è¦åŒ…æ‹¬æŸ¥è¯¢ DSLã€EQLã€SQL ç­‰ã€‚

1ï¼‰DSL æŸ¥è¯¢ï¼ˆDomain Specific Languageï¼‰

ä¸€ç§åŸºäº JSON çš„æŸ¥è¯¢è¯­è¨€ï¼Œå®ƒæ˜¯ Elasticsearch ä¸­æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ–¹å¼ã€‚

ç¤ºä¾‹ï¼š

â–¼
json
å¤åˆ¶ä»£ç 
{
  "query": {
    "match": {
      "message": "Elasticsearch æ˜¯å¼ºå¤§çš„"
    }
  }
}
è¿™ä¸ªæŸ¥è¯¢ä¼šå¯¹ message å­—æ®µè¿›è¡Œåˆ†è¯ï¼Œå¹¶æŸ¥æ‰¾åŒ…å« "Elasticsearch" å’Œ "å¼ºå¤§" è¯æ¡çš„æ–‡æ¡£ã€‚

2ï¼‰EQL

EQL å…¨ç§° Event Query Languageï¼Œæ˜¯ä¸€ç§ç”¨äºæ£€æµ‹å’Œæ£€ç´¢æ—¶é—´åºåˆ— äº‹ä»¶ çš„æŸ¥è¯¢è¯­è¨€ï¼Œå¸¸ç”¨äºæ—¥å¿—å’Œå®‰å…¨ç›‘æ§åœºæ™¯ã€‚

ç¤ºä¾‹ï¼šæŸ¥æ‰¾ç‰¹å®šäº‹ä»¶

â–¼
plain
å¤åˆ¶ä»£ç 
process where process.name == "malware.exe"
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ process.name ä¸º "malware.exe" çš„æ‰€æœ‰è¿›ç¨‹äº‹ä»¶ï¼Œå¸¸ç”¨äºå®‰å…¨æ£€æµ‹ä¸­çš„æ¶æ„è½¯ä»¶åˆ†æã€‚

3ï¼‰SQL æŸ¥è¯¢

Elasticsearch æä¾›äº†ç±»ä¼¼äºä¼ ç»Ÿæ•°æ®åº“çš„ SQL æŸ¥è¯¢è¯­æ³•ï¼Œå…è®¸ç”¨æˆ·ä»¥ SQL çš„å½¢å¼æŸ¥è¯¢ Elasticsearch ä¸­çš„æ•°æ®ï¼Œå¯¹ç†Ÿæ‚‰ SQL çš„ç”¨æˆ·æ¥è¯´éå¸¸æ–¹ä¾¿ã€‚

ç¤ºä¾‹ SQL æŸ¥è¯¢ï¼š

â–¼
sql
å¤åˆ¶ä»£ç 
SELECT name, age FROM users WHERE age > 30 ORDER BY age DESC
è¿™ä¸ªæŸ¥è¯¢ä¼šè¿”å› users ç´¢å¼•ä¸­ age å¤§äº 30 çš„æ‰€æœ‰ç”¨æˆ·ï¼Œå¹¶æŒ‰å¹´é¾„é™åºæ’åºã€‚

ä»¥ä¸‹å‡ ç§ç®€å•äº†è§£å³å¯ï¼š

4ï¼‰Lucene æŸ¥è¯¢è¯­æ³•

Lucene æ˜¯ Elasticsearch åº•å±‚çš„æœç´¢å¼•æ“ï¼ŒElasticsearch æ”¯æŒç›´æ¥ä½¿ç”¨ Lucene çš„æŸ¥è¯¢è¯­æ³•ï¼Œé€‚åˆç®€å•çš„å­—ç¬¦ä¸²æŸ¥è¯¢ã€‚

ç¤ºä¾‹ Lucene æŸ¥è¯¢ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
name:Elasticsearch AND age:[30 TO 40]
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ name å­—æ®µä¸º "Elasticsearch" ä¸” age åœ¨ 30 åˆ° 40 ä¹‹é—´çš„æ–‡æ¡£ã€‚

5ï¼‰Kueryï¼ˆKQL: Kibana Query Languageï¼‰

KQL æ˜¯ Kibana çš„æŸ¥è¯¢è¯­è¨€ï¼Œä¸“é—¨ç”¨äºåœ¨ Kibana ç•Œé¢ä¸Šæ‰§è¡Œæœç´¢æŸ¥è¯¢ï¼Œå¸¸ç”¨äºä»ªè¡¨ç›˜å’Œæ•°æ®æ¢ç´¢ä¸­ã€‚

ç¤ºä¾‹ KQL æŸ¥è¯¢ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
name: "Elasticsearch" and age > 30
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ name ä¸º "Elasticsearch" ä¸” age å¤§äº 30 çš„æ–‡æ¡£ã€‚

6ï¼‰Painless è„šæœ¬æŸ¥è¯¢

Painless æ˜¯ Elasticsearch çš„å†…ç½®è„šæœ¬è¯­è¨€ï¼Œç”¨äºæ‰§è¡Œè‡ªå®šä¹‰çš„è„šæœ¬æ“ä½œï¼Œå¸¸ç”¨äºæ’åºã€èšåˆæˆ–å¤æ‚è®¡ç®—åœºæ™¯ã€‚

ç¤ºä¾‹ Painless è„šæœ¬ï¼š

â–¼
json
å¤åˆ¶ä»£ç 
{
  "query": {
    "script_score": {
      "query": {
        "match": { "message": "Elasticsearch" }
      },
      "script": {
        "source": "doc['popularity'].value * 2"
      }
    }
  }
}
è¿™ä¸ªæŸ¥è¯¢ä¼šåŸºäº popularity å­—æ®µçš„å€¼è¿›è¡ŒåŠ¨æ€è¯„åˆ†ï¼Œå°†å…¶ä¹˜ä»¥ 2ã€‚

æ€»ç»“ä¸€ä¸‹ï¼ŒDSL æ˜¯æœ€é€šç”¨çš„ï¼ŒEQL å’Œ KQL åˆ™é€‚ç”¨äºç‰¹å®šåœºæ™¯ï¼Œå¦‚æ—¥å¿—åˆ†æå’Œ Kibana æŸ¥è¯¢ï¼Œè€Œ SQL åˆ™ä¾¿äºæ•°æ®åº“å¼€å‘äººå‘˜ä¸Šæ‰‹ã€‚

7ã€Elasticsearch æŸ¥è¯¢æ¡ä»¶
å¦‚ä½•åˆ©ç”¨ Elasticsearch å®ç°æ•°æ®ç­›é€‰å‘¢ï¼Ÿéœ€è¦äº†è§£å…¶æŸ¥è¯¢æ¡ä»¶ï¼Œä»¥ ES çš„ DSL è¯­æ³•ä¸ºä¾‹ï¼š

æŸ¥è¯¢æ¡ä»¶	ä»‹ç»	ç¤ºä¾‹	ç”¨é€”
match	ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œå°†æŸ¥è¯¢å­—ç¬¦ä¸²è¿›è¡Œåˆ†è¯å¹¶åŒ¹é…æ–‡æ¡£ä¸­å¯¹åº”çš„å­—æ®µã€‚	{ "match": { "content": "é±¼çš®æ˜¯å¸…å°ä¼™" } }	é€‚ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œåˆ†è¯ååŒ¹é…æ–‡æ¡£å†…å®¹ã€‚
term	ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼Œä¸è¿›è¡Œåˆ†è¯ã€‚é€šå¸¸ç”¨äºç»“æ„åŒ–æ•°æ®çš„ç²¾ç¡®åŒ¹é…ï¼Œå¦‚æ•°å­—ã€æ—¥æœŸã€å…³é”®è¯ç­‰ã€‚	{ "term": { "status": "active" } }	é€‚ç”¨äºå­—æ®µçš„ç²¾ç¡®åŒ¹é…ï¼Œå¦‚çŠ¶æ€ã€IDã€å¸ƒå°”å€¼ç­‰ã€‚
terms	åŒ¹é…å¤šä¸ªå€¼ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œç›¸å½“äºå¤šä¸ª term æŸ¥è¯¢çš„ç»„åˆã€‚	{ "terms": { "status": ["active", "pending"] } }	é€‚ç”¨äºå¤šå€¼åŒ¹é…çš„åœºæ™¯ã€‚
range	èŒƒå›´æŸ¥è¯¢ï¼Œå¸¸ç”¨äºæ•°å­—ã€æ—¥æœŸå­—æ®µï¼Œæ”¯æŒå¤§äºã€å°äºã€åŒºé—´ç­‰æŸ¥è¯¢ã€‚	{ "range": { "age": { "gte": 18, "lte": 30 } } }	é€‚ç”¨äºæ•°å€¼æˆ–æ—¥æœŸçš„èŒƒå›´æŸ¥è¯¢ã€‚
bool	ç»„åˆæŸ¥è¯¢ï¼Œé€šè¿‡ mustã€shouldã€must_not ç­‰ç»„åˆå¤šä¸ªæŸ¥è¯¢æ¡ä»¶ã€‚	{ "bool": { "must": [ { "term": { "status": "active" } }, { "range": { "age": { "gte": 18 } } } ] } }	é€‚ç”¨äºå¤æ‚çš„å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œå¯ä»¥çµæ´»ç»„åˆã€‚
wildcard	é€šé…ç¬¦æŸ¥è¯¢ï¼Œæ”¯æŒ * å’Œ ?ï¼Œå‰è€…åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œåè€…åŒ¹é…å•ä¸ªå­—ç¬¦ã€‚	{ "wildcard": { "name": "é±¼*" } }	é€‚ç”¨äºéƒ¨åˆ†åŒ¹é…çš„æŸ¥è¯¢ï¼Œå¦‚æ¨¡ç³Šæœç´¢ã€‚
prefix	å‰ç¼€æŸ¥è¯¢ï¼ŒåŒ¹é…ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´çš„å­—æ®µå†…å®¹ã€‚	{ "prefix": { "name": "é±¼" } }	é€‚ç”¨äºæŸ¥æ‰¾ä»¥æŒ‡å®šå­—ç¬¦ä¸²å¼€å¤´çš„å†…å®¹ã€‚
fuzzy	æ¨¡ç³ŠæŸ¥è¯¢ï¼Œå…è®¸æŒ‡å®šç¨‹åº¦çš„æ‹¼å†™é”™è¯¯æˆ–å­—ç¬¦æ›¿æ¢ã€‚	{ "fuzzy": { "name": "yupi~2" } }	é€‚ç”¨äºå¤„ç†æ‹¼å†™é”™è¯¯æˆ–ä¸å®Œå…¨åŒ¹é…çš„æŸ¥è¯¢ã€‚
exists	æŸ¥è¯¢æŸå­—æ®µæ˜¯å¦å­˜åœ¨ã€‚	{ "exists": { "field": "name" } }	é€‚ç”¨äºæŸ¥æ‰¾å­—æ®µå­˜åœ¨æˆ–ç¼ºå¤±çš„æ–‡æ¡£ã€‚
match_phrase	çŸ­è¯­åŒ¹é…æŸ¥è¯¢ï¼Œè¦æ±‚æŸ¥è¯¢çš„è¯è¯­æŒ‰é¡ºåºå®Œå…¨åŒ¹é…ã€‚	{ "match_phrase": { "content": "é±¼çš® å¸…å°ä¼™" } }	é€‚ç”¨äºä¸¥æ ¼çš„çŸ­è¯­åŒ¹é…ï¼Œè¯è¯­é¡ºåºå’Œè·ç¦»éƒ½ä¸¥æ ¼æ§åˆ¶ã€‚
match_all	åŒ¹é…æ‰€æœ‰æ–‡æ¡£ã€‚	{ "match_all": {} }	é€‚ç”¨äºæŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼Œé€šå¸¸ä¸åˆ†é¡µé…åˆä½¿ç”¨ã€‚
ids	åŸºäºæ–‡æ¡£ ID æŸ¥è¯¢ï¼Œæ”¯æŒæŸ¥è¯¢ç‰¹å®š ID çš„æ–‡æ¡£ã€‚	{ "ids": { "values": ["1", "2", "3"] } }	é€‚ç”¨äºæ ¹æ®æ–‡æ¡£ ID æŸ¥æ‰¾ç‰¹å®šæ–‡æ¡£ã€‚
geo_distance	åœ°ç†ä½ç½®æŸ¥è¯¢ï¼ŒåŸºäºåœ°ç†åæ ‡å’ŒæŒ‡å®šè·ç¦»æŸ¥è¯¢ã€‚	{ "geo_distance": { "distance": "12km", "location": { "lat": 40.73, "lon": -74.1 } } }	é€‚ç”¨äºæ ¹æ®è·ç¦»è®¡ç®—æŸ¥æ‰¾åœ°ç†ä½ç½®é™„è¿‘çš„æ–‡æ¡£ã€‚
aggregations	èšåˆæŸ¥è¯¢ï¼Œç”¨äºç»Ÿè®¡ã€è®¡ç®—å’Œåˆ†ç»„æŸ¥è¯¢ï¼Œç±»ä¼¼ SQL ä¸­çš„ GROUP BYã€‚	{ "aggs": { "age_stats": { "stats": { "field": "age" } } } }	é€‚ç”¨äºç»Ÿè®¡å’Œåˆ†ææ•°æ®ï¼Œæ¯”å¦‚æ±‚å’Œã€å¹³å‡å€¼ã€æœ€å¤§å€¼ç­‰ã€‚
å…¶ä¸­çš„å‡ ä¸ªå…³é”®ï¼š

ç²¾ç¡®åŒ¹é… vs. å…¨æ–‡æ£€ç´¢ï¼šterm æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œä¸åˆ†è¯ï¼›match ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œä¼šå¯¹æŸ¥è¯¢è¯è¿›è¡Œåˆ†è¯ã€‚
ç»„åˆæŸ¥è¯¢ï¼šbool æŸ¥è¯¢å¯ä»¥çµæ´»ç»„åˆå¤šä¸ªæ¡ä»¶ï¼Œé€‚ç”¨äºå¤æ‚çš„æŸ¥è¯¢éœ€æ±‚ã€‚
æ¨¡ç³ŠæŸ¥è¯¢ï¼šfuzzy å’Œ wildcard æä¾›äº†çµæ´»çš„æ¨¡ç³ŠåŒ¹é…æ–¹å¼ï¼Œé€‚ç”¨äºæ‹¼å†™é”™è¯¯æˆ–ä¸å®Œå…¨åŒ¹é…çš„åœºæ™¯ã€‚
äº†è§£ä¸Šé¢è¿™äº›ä¸€èˆ¬å°±è¶³å¤Ÿäº†ï¼Œæ›´å¤šå¯ä»¥éšç”¨éšæŸ¥ï¼Œå‚è€ƒ å®˜æ–¹æ–‡æ¡£ ã€‚

8ã€Elasticsearch å®¢æˆ·ç«¯
å‰é¢äº†è§£äº† Elasticsearch çš„æ¦‚å¿µå’ŒæŸ¥è¯¢è¯­æ³•ï¼Œä½†æ˜¯å¦‚ä½•æ‰§è¡Œ Elasticsearch æ“ä½œå‘¢ï¼Ÿè¿˜éœ€è¦äº†è§£ä¸‹ ES çš„å®¢æˆ·ç«¯ï¼Œåˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„ï¼š

1ï¼‰HTTP APIï¼šElasticsearch æä¾›äº† RESTful HTTP APIï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç›´æ¥å‘é€ HTTP è¯·æ±‚æ¥æ‰§è¡Œç´¢å¼•ã€æœç´¢å’Œç®¡ç†é›†ç¾¤çš„æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

2ï¼‰Kibanaï¼šKibana æ˜¯ Elasticsearch å®˜æ–¹æä¾›çš„å¯è§†åŒ–å·¥å…·ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ Kibana æ§åˆ¶å°ä½¿ç”¨æŸ¥è¯¢è¯­æ³•ï¼ˆå¦‚ DSLã€KQLï¼‰æ¥æ‰§è¡Œæœç´¢ã€åˆ†æå’Œæ•°æ®å¯è§†åŒ–ã€‚

3ï¼‰Java REST Clientï¼šElasticsearch å®˜æ–¹æä¾›çš„ Java é«˜çº§ REST å®¢æˆ·ç«¯åº“ï¼Œç”¨äº Java ç¨‹åºä¸­ä¸ Elasticsearch è¿›è¡Œé€šä¿¡ï¼Œæ”¯æŒç´¢å¼•ã€æŸ¥è¯¢ã€é›†ç¾¤ç®¡ç†ç­‰æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

4ï¼‰Spring Data Elasticsearchï¼šSpring å…¨å®¶æ¡¶çš„ä¸€å‘˜ï¼Œç”¨äºå°† Elasticsearch ä¸ Spring æ¡†æ¶é›†æˆï¼Œé€šè¿‡ç®€åŒ–çš„ Repository æ–¹å¼è¿›è¡Œç´¢å¼•ã€æŸ¥è¯¢å’Œæ•°æ®ç®¡ç†æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

5ï¼‰Elasticsearch SQL CLIï¼šå‘½ä»¤è¡Œå·¥å…·ï¼Œå…è®¸é€šè¿‡ç±» SQL è¯­æ³•ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æŸ¥è¯¢ Elasticsearch æ•°æ®ï¼Œé€‚ç”¨äºç†Ÿæ‚‰ SQL çš„ç”¨æˆ·ã€‚

æ­¤å¤–ï¼ŒElasticsearch å½“ç„¶ä¸åªæœ‰ Java çš„å®¢æˆ·ç«¯ï¼ŒPythonã€PHPã€Node.jsã€Go çš„å®¢æˆ·ç«¯éƒ½æ˜¯æ”¯æŒçš„ã€‚

ğŸ’¡ åœ¨é€‰æ‹©å®¢æˆ·ç«¯æ—¶ï¼Œè¦æ ¼å¤–æ³¨æ„ç‰ˆæœ¬å·ï¼ï¼ï¼è¦è·Ÿ Elasticsearch çš„ç‰ˆæœ¬ä¿æŒå…¼å®¹ã€‚

9ã€ES æ•°æ®åŒæ­¥æ–¹æ¡ˆ
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœåšæŸ¥è¯¢æœç´¢åŠŸèƒ½ï¼Œä½¿ç”¨ ES æ¥æ¨¡ç³Šæœç´¢ï¼Œä½†æ˜¯æ•°æ®æ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ MySQL é‡Œçš„ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦æŠŠ MySQL ä¸­çš„æ•°æ®å’Œ ES è¿›è¡ŒåŒæ­¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´ï¼ˆä»¥ MySQL ä¸ºä¸»ï¼‰ã€‚

æ•°æ®æµå‘ï¼šMySQL => ES ï¼ˆå•å‘ï¼‰

æ•°æ®åŒæ­¥ä¸€èˆ¬æœ‰ 2 ä¸ªè¿‡ç¨‹ï¼šå…¨é‡åŒæ­¥ï¼ˆé¦–æ¬¡ï¼‰+ å¢é‡åŒæ­¥ï¼ˆæ–°æ•°æ®ï¼‰

æ€»å…±æœ‰ 4 ç§ä¸»æµæ–¹æ¡ˆï¼š

1ï¼‰å®šæ—¶ä»»åŠ¡

æ¯”å¦‚ 1 åˆ†é’Ÿ 1 æ¬¡ï¼Œæ‰¾åˆ° MySQL ä¸­è¿‡å»å‡ åˆ†é’Ÿå†…ï¼ˆè‡³å°‘æ˜¯å®šæ—¶å‘¨æœŸçš„ 2 å€ï¼‰å‘ç”Ÿæ”¹å˜çš„æ•°æ®ï¼Œç„¶åæ›´æ–°åˆ° ESã€‚

ä¼˜ç‚¹ï¼š

ç®€å•æ˜“æ‡‚ï¼Œå¼€å‘ã€éƒ¨ç½²ã€ç»´æŠ¤ç›¸å¯¹å®¹æ˜“ã€‚
å ç”¨èµ„æºå°‘ï¼Œä¸éœ€è¦å¼•å…¥å¤æ‚çš„ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ã€‚
ä¸ç”¨å¤„ç†å¤æ‚çš„å¹¶å‘å’Œå®æ—¶æ€§é—®é¢˜ã€‚
ç¼ºç‚¹ï¼š

æœ‰æ—¶é—´å·®ï¼šæ— æ³•åšåˆ°å®æ—¶åŒæ­¥ï¼Œæ•°æ®å­˜åœ¨æ»åã€‚
æ•°æ®é¢‘ç¹å˜åŒ–æ—¶ï¼Œæ— æ³•ç¡®ä¿æ•°æ®å®Œå…¨åŒæ­¥ï¼Œå®¹æ˜“å‡ºç°é”™è¿‡æ›´æ–°çš„æƒ…å†µã€‚
å¯¹å¤§æ•°æ®é‡çš„æ›´æ–°å¤„ç†ä¸å¤Ÿé«˜æ•ˆï¼Œå¯èƒ½ä¼šå¼•å…¥é‡å¤æ›´æ–°é€»è¾‘ã€‚
åº”ç”¨åœºæ™¯ï¼š

æ•°æ®å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼šé€‚åˆæ•°æ®çŸ­æ—¶é—´å†…ä¸åŒæ­¥ä¸ä¼šå¸¦æ¥é‡å¤§å½±å“çš„åœºæ™¯ã€‚
æ•°æ®åŸºæœ¬ä¸å‘ç”Ÿä¿®æ”¹ï¼šé€‚åˆæ•°æ®å‡ ä¹ä¸ä¿®æ”¹ã€ä¿®æ”¹ä¸é¢‘ç¹çš„åœºæ™¯ã€‚
æ•°æ®å®¹å¿ä¸¢å¤±
2ï¼‰åŒå†™

å†™æ•°æ®çš„æ—¶å€™ï¼Œå¿…é¡»ä¹Ÿå»å†™ ESï¼›æ›´æ–°åˆ é™¤æ•°æ®åº“åŒç†ã€‚

å¯ä»¥é€šè¿‡äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½¿ç”¨äº‹åŠ¡æ—¶ï¼Œè¦å…ˆä¿è¯ MySQL å†™æˆåŠŸï¼Œå› ä¸ºå¦‚æœ ES å†™å…¥å¤±è´¥äº†ï¼Œä¸ä¼šè§¦å‘å›æ»šï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡ + æ—¥å¿— + å‘Šè­¦è¿›è¡Œæ£€æµ‹å’Œä¿®å¤ï¼ˆè¡¥å¿ï¼‰ã€‚

ä¼˜ç‚¹ï¼š

æ–¹æ¡ˆç®€å•æ˜“æ‡‚ï¼Œä¸šåŠ¡é€»è¾‘ç›´æ¥æ§åˆ¶æ•°æ®åŒæ­¥ã€‚
å¯ä»¥åˆ©ç”¨äº‹åŠ¡éƒ¨åˆ†ä¿è¯ MySQL å’Œ ES çš„æ•°æ®ä¸€è‡´æ€§ã€‚
åŒæ­¥çš„æ—¶å»¶è¾ƒçŸ­ï¼Œç†è®ºä¸Šå¯ä»¥æ¥è¿‘å®æ—¶æ›´æ–° ESã€‚
ç¼ºç‚¹ï¼š

å½±å“æ€§èƒ½ï¼šæ¯æ¬¡å†™ MySQL æ—¶ï¼Œéœ€è¦åŒæ—¶æ“ä½œ ESï¼Œå¢åŠ äº†ä¸šåŠ¡å†™å…¥å»¶è¿Ÿï¼Œå½±å“æ€§èƒ½ã€‚
ä¸€è‡´æ€§é—®é¢˜ï¼šå¦‚æœ ES å†™å…¥å¤±è´¥ï¼ŒMySQL äº‹åŠ¡æäº¤æˆåŠŸåï¼ŒES å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ï¼›æˆ–è€… ES å†™å…¥æˆåŠŸï¼ŒMySQL äº‹åŠ¡æäº¤å¤±è´¥ï¼ŒES æ— æ³•å›æ»šã€‚å› æ­¤å¿…é¡»é¢å¤–è®¾è®¡ç›‘æ§ã€è¡¥å¿æœºåˆ¶æ¥æ£€æµ‹åŒæ­¥å¤±è´¥çš„æƒ…å†µï¼ˆå¦‚é€šè¿‡å®šæ—¶ä»»åŠ¡ã€æ—¥å¿—å’Œå‘Šè­¦ä¿®å¤ï¼‰ã€‚
ä»£ç å¤æ‚åº¦å¢åŠ ï¼Œéœ€è¦å¯¹æ¯ä¸ªå†™æ“ä½œéƒ½è¿›è¡ŒåŒå†™å¤„ç†ã€‚
åº”ç”¨åœºæ™¯ï¼š

å®æ—¶æ€§è¦æ±‚è¾ƒé«˜
ä¸šåŠ¡å†™å…¥é¢‘ç‡è¾ƒä½ï¼šé€‚åˆå†™æ“ä½œä¸é¢‘ç¹çš„åœºæ™¯ï¼Œè¿™æ ·å¯¹æ€§èƒ½çš„å½±å“è¾ƒå°ã€‚
3ï¼‰ç”¨ Logstash æ•°æ®åŒæ­¥ç®¡é“

ä¸€èˆ¬è¦é…åˆ kafka æ¶ˆæ¯é˜Ÿåˆ— + beats é‡‡é›†å™¨ï¼š

img
ä¼˜ç‚¹ï¼š

é…ç½®é©±åŠ¨ï¼šåŸºäºé…ç½®æ–‡ä»¶ï¼Œå‡å°‘äº†æ‰‹åŠ¨ç¼–ç ï¼Œæ•°æ®åŒæ­¥é€»è¾‘å’Œä¸šåŠ¡ä»£ç è§£è€¦ã€‚
æ‰©å±•æ€§å¥½ï¼šå¯ä»¥çµæ´»å¼•å…¥ Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥æ•°æ®åŒæ­¥ï¼Œå¹¶å¯å¤„ç†é«˜ååé‡æ•°æ®ã€‚
æ”¯æŒå¤šç§æ•°æ®æºï¼šLogstash æ”¯æŒä¸°å¯Œçš„æ•°æ®æºï¼Œæ–¹ä¾¿æ‰©å±•å…¶ä»–åŒæ­¥éœ€æ±‚ã€‚
ç¼ºç‚¹ï¼š

çµæ´»æ€§å·®ï¼šéœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¯èƒ½éš¾ä»¥åœ¨é…ç½®ä¸­å®ç°ï¼Œæ— æ³•å¤„ç†ç»†ç²’åº¦çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚
å¼•å…¥é¢å¤–ç»„ä»¶ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼šé€šå¸¸éœ€è¦å¼•å…¥ Kafkaã€Beats ç­‰ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§å’Œè¿ç»´æˆæœ¬ã€‚
åº”ç”¨åœºæ™¯ï¼š

å¤§æ•°æ®åŒæ­¥ï¼šé€‚åˆå¤§è§„æ¨¡ã€åˆ†å¸ƒå¼æ•°æ®åŒæ­¥åœºæ™¯ã€‚
å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼šé€‚åˆæ•°æ®æµå¤„ç†æˆ–å»¶è¿Ÿå®¹å¿è¾ƒå¤§çš„ç³»ç»Ÿã€‚
ç³»ç»Ÿå·²æœ‰ Kafka æˆ–ç±»ä¼¼çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„ï¼šå¦‚æœç³»ç»Ÿä¸­å·²ç»ä½¿ç”¨äº† Kafka ç­‰ä¸­é—´ä»¶ï¼Œä½¿ç”¨ Logstash ç®¡é“ä¼šå˜å¾—å¾ˆæ–¹ä¾¿ã€‚
4ï¼‰ç›‘å¬ MySQL Binlog

æœ‰ä»»ä½•æ•°æ®å˜æ›´æ—¶éƒ½èƒ½å¤Ÿå®æ—¶ç›‘å¬åˆ°ï¼Œå¹¶ä¸”åŒæ­¥åˆ° Elasticsearchã€‚ä¸€èˆ¬ä¸éœ€è¦è‡ªå·±ç›‘å¬ï¼Œå¯ä»¥ä½¿ç”¨ç°æˆçš„æŠ€æœ¯ï¼Œæ¯”å¦‚ Canal ã€‚

img
ğŸ’¡ Canal çš„æ ¸å¿ƒåŸç†ï¼šæ•°æ®åº“æ¯æ¬¡ä¿®æ”¹æ—¶ï¼Œä¼šä¿®æ”¹ binlog æ–‡ä»¶ï¼Œåªè¦ç›‘å¬è¯¥æ–‡ä»¶çš„ä¿®æ”¹ï¼Œå°±èƒ½ç¬¬ä¸€æ—¶é—´å¾—åˆ°æ¶ˆæ¯å¹¶å¤„ç†

ä¼˜ç‚¹ï¼š

å®æ—¶æ€§å¼ºï¼šèƒ½å¤Ÿåœ¨ MySQL æ•°æ®å‘ç”Ÿå˜æ›´çš„ç¬¬ä¸€æ—¶é—´åŒæ­¥åˆ° ESï¼Œåšåˆ°çœŸæ­£çš„å®æ—¶åŒæ­¥ã€‚
è½»é‡çº§ï¼šBinlog æ˜¯æ•°æ®åº“è‡ªå¸¦çš„æ—¥å¿—åŠŸèƒ½ï¼Œä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä¸šåŠ¡ä»£ç ï¼Œåªéœ€è¦æ–°å¢ç›‘å¬é€»è¾‘ã€‚
ç¼ºç‚¹ï¼š

å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼šéœ€è¦å¼•å…¥åƒ Canal è¿™æ ·çš„ä¸­é—´ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§å’Œç»´æŠ¤æˆæœ¬ã€‚
è¿ç»´éš¾åº¦å¢åŠ ï¼šéœ€è¦ç¡®ä¿ Canal æˆ–è€…å…¶ä»– Binlog ç›‘å¬å™¨çš„ç¨³å®šè¿è¡Œï¼Œå¹¶ä¸”å¯¹ MySQL çš„ Binlog é…ç½®è¦æ±‚è¾ƒé«˜ã€‚
ä¸€è‡´æ€§é—®é¢˜ï¼šå¦‚æœ Canal æœåŠ¡å‡ºç°é—®é¢˜æˆ–æš‚åœï¼Œæ•°æ®å¯èƒ½ä¼šæ»åæˆ–ä¸¢å¤±ï¼Œå¿…é¡»è®¾è®¡è¡¥å¿æœºåˆ¶ã€‚
åº”ç”¨åœºæ™¯ï¼š

å®æ—¶åŒæ­¥è¦æ±‚é«˜ï¼šé€‚åˆéœ€è¦å®æ—¶æ•°æ®åŒæ­¥çš„åœºæ™¯ï¼Œé€šå¸¸ç”¨äºé«˜å¹¶å‘ã€é«˜æ•°æ®ä¸€è‡´æ€§è¦æ±‚çš„ç³»ç»Ÿã€‚
æ•°æ®é¢‘ç¹å˜åŒ–ï¼šé€‚åˆæ•°æ®å˜æ›´é¢‘ç¹ä¸”éœ€è¦é«˜æ•ˆå¢é‡åŒæ­¥çš„åœºæ™¯ã€‚
æœ€ç»ˆæ–¹æ¡ˆï¼šå¯¹äºæœ¬é¡¹ç›®ï¼Œç”±äºæ•°æ®é‡ä¸å¤§ï¼Œé¢˜ç›®æ›´æ–°ä¹Ÿä¸é¢‘ç¹ï¼Œå®¹å¿ä¸¢å¤±å’Œä¸ä¸€è‡´ï¼Œæ‰€ä»¥é€‰ç”¨æ–¹æ¡ˆä¸€ï¼Œå®ç°æˆæœ¬æœ€ä½ã€‚arity å­—æ®µçš„å€¼è¿›è¡ŒåŠ¨æ€è¯„åˆ†ï¼Œå°†å…¶ä¹˜ä»¥ 2ã€‚

æ€»ç»“ä¸€ä¸‹ï¼ŒDSL æ˜¯æœ€é€šç”¨çš„ï¼ŒEQL å’Œ KQL åˆ™é€‚ç”¨äºç‰¹å®šåœºæ™¯ï¼Œå¦‚æ—¥å¿—åˆ†æå’Œ Kibana æŸ¥è¯¢ï¼Œè€Œ SQL åˆ™ä¾¿äºæ•°æ®åº“å¼€å‘äººå‘˜ä¸Šæ‰‹ã€‚

7ã€Elasticsearch æŸ¥è¯¢æ¡ä»¶
å¦‚ä½•åˆ©ç”¨ Elasticsearch å®ç°æ•°æ®ç­›é€‰å‘¢ï¼Ÿéœ€è¦äº†è§£å…¶æŸ¥è¯¢æ¡ä»¶ï¼Œä»¥ ES çš„ DSL è¯­æ³•ä¸ºä¾‹ï¼š

æŸ¥è¯¢æ¡ä»¶	ä»‹ç»	ç¤ºä¾‹	ç”¨é€”
match	ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œå°†æŸ¥è¯¢å­—ç¬¦ä¸²è¿›è¡Œåˆ†è¯å¹¶åŒ¹é…æ–‡æ¡£ä¸­å¯¹åº”çš„å­—æ®µã€‚	{ "match": { "content": "é±¼çš®æ˜¯å¸…å°ä¼™" } }	é€‚ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œåˆ†è¯ååŒ¹é…æ–‡æ¡£å†…å®¹ã€‚
term	ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼Œä¸è¿›è¡Œåˆ†è¯ã€‚é€šå¸¸ç”¨äºç»“æ„åŒ–æ•°æ®çš„ç²¾ç¡®åŒ¹é…ï¼Œå¦‚æ•°å­—ã€æ—¥æœŸã€å…³é”®è¯ç­‰ã€‚	{ "term": { "status": "active" } }	é€‚ç”¨äºå­—æ®µçš„ç²¾ç¡®åŒ¹é…ï¼Œå¦‚çŠ¶æ€ã€IDã€å¸ƒå°”å€¼ç­‰ã€‚
terms	åŒ¹é…å¤šä¸ªå€¼ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œç›¸å½“äºå¤šä¸ª term æŸ¥è¯¢çš„ç»„åˆã€‚	{ "terms": { "status": ["active", "pending"] } }	é€‚ç”¨äºå¤šå€¼åŒ¹é…çš„åœºæ™¯ã€‚
range	èŒƒå›´æŸ¥è¯¢ï¼Œå¸¸ç”¨äºæ•°å­—ã€æ—¥æœŸå­—æ®µï¼Œæ”¯æŒå¤§äºã€å°äºã€åŒºé—´ç­‰æŸ¥è¯¢ã€‚	{ "range": { "age": { "gte": 18, "lte": 30 } } }	é€‚ç”¨äºæ•°å€¼æˆ–æ—¥æœŸçš„èŒƒå›´æŸ¥è¯¢ã€‚
bool	ç»„åˆæŸ¥è¯¢ï¼Œé€šè¿‡ mustã€shouldã€must_not ç­‰ç»„åˆå¤šä¸ªæŸ¥è¯¢æ¡ä»¶ã€‚	{ "bool": { "must": [ { "term": { "status": "active" } }, { "range": { "age": { "gte": 18 } } } ] } }	é€‚ç”¨äºå¤æ‚çš„å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œå¯ä»¥çµæ´»ç»„åˆã€‚
wildcard	é€šé…ç¬¦æŸ¥è¯¢ï¼Œæ”¯æŒ * å’Œ ?ï¼Œå‰è€…åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œåè€…åŒ¹é…å•ä¸ªå­—ç¬¦ã€‚	{ "wildcard": { "name": "é±¼*" } }	é€‚ç”¨äºéƒ¨åˆ†åŒ¹é…çš„æŸ¥è¯¢ï¼Œå¦‚æ¨¡ç³Šæœç´¢ã€‚
prefix	å‰ç¼€æŸ¥è¯¢ï¼ŒåŒ¹é…ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´çš„å­—æ®µå†…å®¹ã€‚	{ "prefix": { "name": "é±¼" } }	é€‚ç”¨äºæŸ¥æ‰¾ä»¥æŒ‡å®šå­—ç¬¦ä¸²å¼€å¤´çš„å†…å®¹ã€‚
fuzzy	æ¨¡ç³ŠæŸ¥è¯¢ï¼Œå…è®¸æŒ‡å®šç¨‹åº¦çš„æ‹¼å†™é”™è¯¯æˆ–å­—ç¬¦æ›¿æ¢ã€‚	{ "fuzzy": { "name": "yupi~2" } }	é€‚ç”¨äºå¤„ç†æ‹¼å†™é”™è¯¯æˆ–ä¸å®Œå…¨åŒ¹é…çš„æŸ¥è¯¢ã€‚
exists	æŸ¥è¯¢æŸå­—æ®µæ˜¯å¦å­˜åœ¨ã€‚	{ "exists": { "field": "name" } }	é€‚ç”¨äºæŸ¥æ‰¾å­—æ®µå­˜åœ¨æˆ–ç¼ºå¤±çš„æ–‡æ¡£ã€‚
match_phrase	çŸ­è¯­åŒ¹é…æŸ¥è¯¢ï¼Œè¦æ±‚æŸ¥è¯¢çš„è¯è¯­æŒ‰é¡ºåºå®Œå…¨åŒ¹é…ã€‚	{ "match_phrase": { "content": "é±¼çš® å¸…å°ä¼™" } }	é€‚ç”¨äºä¸¥æ ¼çš„çŸ­è¯­åŒ¹é…ï¼Œè¯è¯­é¡ºåºå’Œè·ç¦»éƒ½ä¸¥æ ¼æ§åˆ¶ã€‚
match_all	åŒ¹é…æ‰€æœ‰æ–‡æ¡£ã€‚	{ "match_all": {} }	é€‚ç”¨äºæŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼Œé€šå¸¸ä¸åˆ†é¡µé…åˆä½¿ç”¨ã€‚
ids	åŸºäºæ–‡æ¡£ ID æŸ¥è¯¢ï¼Œæ”¯æŒæŸ¥è¯¢ç‰¹å®š ID çš„æ–‡æ¡£ã€‚	{ "ids": { "values": ["1", "2", "3"] } }	é€‚ç”¨äºæ ¹æ®æ–‡æ¡£ ID æŸ¥æ‰¾ç‰¹å®šæ–‡æ¡£ã€‚
geo_distance	åœ°ç†ä½ç½®æŸ¥è¯¢ï¼ŒåŸºäºåœ°ç†åæ ‡å’ŒæŒ‡å®šè·ç¦»æŸ¥è¯¢ã€‚	{ "geo_distance": { "distance": "12km", "location": { "lat": 40.73, "lon": -74.1 } } }	é€‚ç”¨äºæ ¹æ®è·ç¦»è®¡ç®—æŸ¥æ‰¾åœ°ç†ä½ç½®é™„è¿‘çš„æ–‡æ¡£ã€‚
aggregations	èšåˆæŸ¥è¯¢ï¼Œç”¨äºç»Ÿè®¡ã€è®¡ç®—å’Œåˆ†ç»„æŸ¥è¯¢ï¼Œç±»ä¼¼ SQL ä¸­çš„ GROUP BYã€‚	{ "aggs": { "age_stats": { "stats": { "field": "age" } } } }	é€‚ç”¨äºç»Ÿè®¡å’Œåˆ†ææ•°æ®ï¼Œæ¯”å¦‚æ±‚å’Œã€å¹³å‡å€¼ã€æœ€å¤§å€¼ç­‰ã€‚
å…¶ä¸­çš„å‡ ä¸ªå…³é”®ï¼š

ç²¾ç¡®åŒ¹é… vs. å…¨æ–‡æ£€ç´¢ï¼šterm æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œä¸åˆ†è¯ï¼›match ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œä¼šå¯¹æŸ¥è¯¢è¯è¿›è¡Œåˆ†è¯ã€‚
ç»„åˆæŸ¥è¯¢ï¼šbool æŸ¥è¯¢å¯ä»¥çµæ´»ç»„åˆå¤šä¸ªæ¡ä»¶ï¼Œé€‚ç”¨äºå¤æ‚çš„æŸ¥è¯¢éœ€æ±‚ã€‚
æ¨¡ç³ŠæŸ¥è¯¢ï¼šfuzzy å’Œ wildcard æä¾›äº†çµæ´»çš„æ¨¡ç³ŠåŒ¹é…æ–¹å¼ï¼Œé€‚ç”¨äºæ‹¼å†™é”™è¯¯æˆ–ä¸å®Œå…¨åŒ¹é…çš„åœºæ™¯ã€‚
äº†è§£ä¸Šé¢è¿™äº›ä¸€èˆ¬å°±è¶³å¤Ÿäº†ï¼Œæ›´å¤šå¯ä»¥éšç”¨éšæŸ¥ï¼Œå‚è€ƒ å®˜æ–¹æ–‡æ¡£ ã€‚

8ã€Elasticsearch å®¢æˆ·ç«¯
å‰é¢äº†è§£äº† Elasticsearch çš„æ¦‚å¿µå’ŒæŸ¥è¯¢è¯­æ³•ï¼Œä½†æ˜¯å¦‚ä½•æ‰§è¡Œ Elasticsearch æ“ä½œå‘¢ï¼Ÿè¿˜éœ€è¦äº†è§£ä¸‹ ES çš„å®¢æˆ·ç«¯ï¼Œåˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„ï¼š

1ï¼‰HTTP APIï¼šElasticsearch æä¾›äº† RESTful HTTP APIï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç›´æ¥å‘é€ HTTP è¯·æ±‚æ¥æ‰§è¡Œç´¢å¼•ã€æœç´¢å’Œç®¡ç†é›†ç¾¤çš„æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

2ï¼‰Kibanaï¼šKibana æ˜¯ Elasticsearch å®˜æ–¹æä¾›çš„å¯è§†åŒ–å·¥å…·ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ Kibana æ§åˆ¶å°ä½¿ç”¨æŸ¥è¯¢è¯­æ³•ï¼ˆå¦‚ DSLã€KQLï¼‰æ¥æ‰§è¡Œæœç´¢ã€åˆ†æå’Œæ•°æ®å¯è§†åŒ–ã€‚

3ï¼‰Java REST Clientï¼šElasticsearch å®˜æ–¹æä¾›çš„ Java é«˜çº§ REST å®¢æˆ·ç«¯åº“ï¼Œç”¨äº Java ç¨‹åºä¸­ä¸ Elasticsearch è¿›è¡Œé€šä¿¡ï¼Œæ”¯æŒç´¢å¼•ã€æŸ¥è¯¢ã€é›†ç¾¤ç®¡ç†ç­‰æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

4ï¼‰Spring Data Elasticsearchï¼šSpring å…¨å®¶æ¡¶çš„ä¸€å‘˜ï¼Œç”¨äºå°† Elasticsearch ä¸ Spring æ¡†æ¶é›†æˆï¼Œé€šè¿‡ç®€åŒ–çš„ Repository æ–¹å¼è¿›è¡Œç´¢å¼•ã€æŸ¥è¯¢å’Œæ•°æ®ç®¡ç†æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

5ï¼‰Elasticsearch SQL CLIï¼šå‘½ä»¤è¡Œå·¥å…·ï¼Œå…è®¸é€šè¿‡ç±» SQL è¯­æ³•ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æŸ¥è¯¢ Elasticsearch æ•°æ®ï¼Œé€‚ç”¨äºç†Ÿæ‚‰ SQL çš„ç”¨æˆ·ã€‚

æ­¤å¤–ï¼ŒElasticsearch å½“ç„¶ä¸åªæœ‰ Java çš„å®¢æˆ·ç«¯ï¼ŒPythonã€PHPã€Node.jsã€Go çš„å®¢æˆ·ç«¯éƒ½æ˜¯æ”¯æŒçš„ã€‚

ğŸ’¡ åœ¨é€‰æ‹©å®¢æˆ·ç«¯æ—¶ï¼Œè¦æ ¼å¤–æ³¨æ„ç‰ˆæœ¬å·ï¼ï¼ï¼è¦è·Ÿ Elasticsearch çš„ç‰ˆæœ¬ä¿æŒå…¼å®¹ã€‚

9ã€ES æ•°æ®åŒæ­¥æ–¹æ¡ˆ
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœåšæŸ¥è¯¢æœç´¢åŠŸèƒ½ï¼Œä½¿ç”¨ ES æ¥æ¨¡ç³Šæœç´¢ï¼Œä½†æ˜¯æ•°æ®æ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ MySQL é‡Œçš„ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦æŠŠ MySQL ä¸­çš„æ•°æ®å’Œ ES è¿›è¡ŒåŒæ­¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´ï¼ˆä»¥ MySQL ä¸ºä¸»ï¼‰ã€‚

æ•°æ®æµå‘ï¼šMySQL => ES ï¼ˆå•å‘ï¼‰

æ•°æ®åŒæ­¥ä¸€èˆ¬æœ‰ 2 ä¸ªè¿‡ç¨‹ï¼šå…¨é‡åŒæ­¥ï¼ˆé¦–æ¬¡ï¼‰+ å¢é‡åŒæ­¥ï¼ˆæ–°æ•°æ®ï¼‰

æ€»å…±æœ‰ 4 ç§ä¸»æµæ–¹æ¡ˆï¼š

1ï¼‰å®šæ—¶ä»»åŠ¡

æ¯”å¦‚ 1 åˆ†é’Ÿ 1 æ¬¡ï¼Œæ‰¾åˆ° MySQL ä¸­è¿‡å»å‡ åˆ†é’Ÿå†…ï¼ˆè‡³å°‘æ˜¯å®šæ—¶å‘¨æœŸçš„ 2 å€ï¼‰å‘ç”Ÿæ”¹å˜çš„æ•°æ®ï¼Œç„¶åæ›´æ–°åˆ° ESã€‚

ä¼˜ç‚¹ï¼š

ç®€å•æ˜“æ‡‚ï¼Œå¼€å‘ã€éƒ¨ç½²ã€ç»´æŠ¤ç›¸å¯¹å®¹æ˜“ã€‚
å ç”¨èµ„æºå°‘ï¼Œä¸éœ€è¦å¼•å…¥å¤æ‚çš„ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ã€‚
ä¸ç”¨å¤„ç†å¤æ‚çš„å¹¶å‘å’Œå®æ—¶æ€§é—®é¢˜ã€‚
ç¼ºç‚¹ï¼š

æœ‰æ—¶é—´å·®ï¼šæ— æ³•åšåˆ°å®æ—¶åŒæ­¥ï¼Œæ•°æ®å­˜åœ¨æ»åã€‚
æ•°æ®é¢‘ç¹å˜åŒ–æ—¶ï¼Œæ— æ³•Elasticsearch å…¥é—¨
å¯å‚è€ƒ ç¼–ç¨‹å¯¼èˆª - èšåˆæœç´¢é¡¹ç›® çš„ç¬”è®°ï¼Œè¯¥é¡¹ç›®ç³»ç»Ÿè®²è§£è¿‡ Elasticsearchã€‚

1ã€ä»€ä¹ˆæ˜¯ Elasticsearchï¼Ÿ
Elasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¼€æºçš„æœç´¢å¼•æ“ï¼Œä¸“é—¨ç”¨äºå¤„ç†å¤§è§„æ¨¡çš„æ•°æ®æœç´¢å’Œåˆ†æã€‚å®ƒåŸºäº Apache Lucene æ„å»ºï¼Œå…·æœ‰å®æ—¶æœç´¢ã€åˆ†å¸ƒå¼è®¡ç®—å’Œé«˜å¯æ‰©å±•æ€§ï¼Œå¹¿æ³›ç”¨äº å…¨æ–‡æ£€ç´¢ã€æ—¥å¿—åˆ†æã€ç›‘æ§æ•°æ®åˆ†æ ç­‰åœºæ™¯ã€‚

å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.elastic.co/docsï¼Œå»ºè®®å…¥é—¨åé˜…è¯»ä¸€éï¼Œäº†è§£æ›´å¤šå®ƒçš„ç‰¹æ€§ã€‚

2ã€Elasticsearch ç”Ÿæ€
Elasticsearch ç”Ÿæ€ç³»ç»Ÿéå¸¸ä¸°å¯Œï¼ŒåŒ…å«äº†ä¸€ç³»åˆ—å·¥å…·å’ŒåŠŸèƒ½ï¼Œå¸®åŠ©ç”¨æˆ·å¤„ç†ã€åˆ†æå’Œå¯è§†åŒ–æ•°æ®ï¼ŒElastic Stack æ˜¯å…¶æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚

Elastic Stackï¼ˆä¹Ÿç§°ä¸º ELK Stackï¼‰ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆï¼š

Elasticsearchï¼šæ ¸å¿ƒæœç´¢å¼•æ“ï¼Œè´Ÿè´£å­˜å‚¨ã€ç´¢å¼•å’Œæœç´¢æ•°æ®ã€‚
Kibanaï¼šå¯è§†åŒ–å¹³å°ï¼Œç”¨äºæŸ¥è¯¢ã€åˆ†æå’Œå±•ç¤º Elasticsearch ä¸­çš„æ•°æ®ã€‚
Logstashï¼šæ•°æ®å¤„ç†ç®¡é“ï¼Œè´Ÿè´£æ•°æ®æ”¶é›†ã€è¿‡æ»¤ã€å¢å¼ºå’Œä¼ è¾“åˆ° Elasticsearchã€‚
Beatsï¼šè½»é‡çº§çš„æ•°æ®ä¼ è¾“å·¥å…·ï¼Œæ”¶é›†å’Œå‘é€æ•°æ®åˆ° Logstash æˆ– Elasticsearchã€‚
Kibana æ˜¯ Elastic Stack çš„å¯è§†åŒ–ç»„ä»¶ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å›¾è¡¨ã€åœ°å›¾å’Œä»ªè¡¨ç›˜æ¥å±•ç¤ºå­˜å‚¨åœ¨ Elasticsearch ä¸­çš„æ•°æ®ã€‚å®ƒæä¾›äº†ç®€å•çš„æŸ¥è¯¢æ¥å£ã€æ•°æ®åˆ†æå’Œå®æ—¶ç›‘æ§åŠŸèƒ½ã€‚

img
Logstash æ˜¯ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®æ”¶é›†ç®¡é“å·¥å…·ï¼Œèƒ½å¤Ÿä»å¤šä¸ªæ¥æºæ”¶é›†ã€è¿‡æ»¤ã€è½¬æ¢æ•°æ®ï¼Œç„¶åå°†æ•°æ®å‘é€åˆ° Elasticsearchã€‚Logstash æ”¯æŒä¸°å¯Œçš„è¾“å…¥ã€è¿‡æ»¤å’Œè¾“å‡ºæ’ä»¶ã€‚

img
Beats æ˜¯ä¸€ç»„è½»é‡çº§çš„æ•°æ®é‡‡é›†ä»£ç†ï¼Œè´Ÿè´£ä»ä¸åŒæ¥æºæ”¶é›†æ•°æ®å¹¶å‘é€åˆ° Elasticsearch æˆ– Logstashã€‚å¸¸è§çš„ Beats åŒ…æ‹¬ï¼š

Filebeatï¼šæ”¶é›†æ—¥å¿—æ–‡ä»¶ã€‚
Metricbeatï¼šæ”¶é›†ç³»ç»Ÿå’ŒæœåŠ¡çš„æŒ‡æ ‡ã€‚
Packetbeatï¼šç›‘æ§ç½‘ç»œæµé‡ã€‚
img
ä¸Šé¢è¿™å¼ å›¾ï¼Œä¹Ÿæ˜¯æ ‡å‡†çš„ Elastic Stack æŠ€æœ¯æ ˆçš„äº¤äº’å›¾ã€‚

3ã€Elasticsearch çš„æ ¸å¿ƒæ¦‚å¿µ
ç´¢å¼•ï¼ˆIndexï¼‰ï¼šç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨ï¼Œç´¢å¼•æ˜¯æ•°æ®å­˜å‚¨å’Œæœç´¢çš„ åŸºæœ¬å•ä½ã€‚æ¯ä¸ªç´¢å¼•å¯ä»¥å­˜å‚¨å¤šæ¡æ–‡æ¡£æ•°æ®ã€‚

æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼šç´¢å¼•ä¸­çš„æ¯æ¡è®°å½•ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„è¡Œã€‚æ–‡æ¡£ä»¥ JSON æ ¼å¼å­˜å‚¨ã€‚

å­—æ®µï¼ˆFieldï¼‰ï¼šæ–‡æ¡£ä¸­çš„æ¯ä¸ªé”®å€¼å¯¹ï¼Œç±»ä¼¼äºæ•°æ®åº“ä¸­çš„åˆ—ã€‚

æ˜ å°„ï¼ˆMappingï¼‰ï¼šç”¨äºå®šä¹‰ Elasticsearch ç´¢å¼•ä¸­æ–‡æ¡£å­—æ®µçš„æ•°æ®ç±»å‹åŠå…¶å¤„ç†æ–¹å¼ï¼Œç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ Schema è¡¨ç»“æ„ï¼Œå¸®åŠ©æ§åˆ¶å­—æ®µçš„å­˜å‚¨ã€ç´¢å¼•å’ŒæŸ¥è¯¢è¡Œä¸ºã€‚

é›†ç¾¤ï¼ˆClusterï¼‰ï¼šå¤šä¸ªèŠ‚ç‚¹ç»„æˆçš„ç¾¤é›†ï¼Œç”¨äºå­˜å‚¨æ•°æ®å¹¶æä¾›æœç´¢åŠŸèƒ½ã€‚é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†æ•°æ®ã€‚

åˆ†ç‰‡ï¼ˆShardï¼‰ï¼šä¸ºäº†å®ç°æ¨ªå‘æ‰©å±•ï¼ŒES å°†ç´¢å¼•æ‹†åˆ†æˆå¤šä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ä¸Šã€‚

å‰¯æœ¬ï¼ˆReplicaï¼‰ï¼šåˆ†ç‰‡çš„å¤åˆ¶å“ï¼Œç”¨äºæé«˜å¯ç”¨æ€§å’Œå®¹é”™æ€§ã€‚

img
å’Œæ•°æ®åº“ç±»æ¯”ï¼š

Elasticsearch æ¦‚å¿µ	å…³ç³»å‹æ•°æ®åº“ç±»æ¯”
Index	Table
Document	Row
Field	Column
Mapping	Schema
Shard	Partition
Replica	Backup
4ã€Elasticsearch å®ç°å…¨æ–‡æ£€ç´¢çš„åŸç†
1ï¼‰åˆ†è¯ï¼šElasticsearch çš„åˆ†è¯å™¨ä¼šå°†è¾“å…¥æ–‡æœ¬æ‹†è§£æˆç‹¬ç«‹çš„è¯æ¡ï¼ˆtokensï¼‰ï¼Œæ–¹ä¾¿è¿›è¡Œç´¢å¼•å’Œæœç´¢ã€‚åˆ†è¯çš„å…·ä½“è¿‡ç¨‹åŒ…æ‹¬ä»¥ä¸‹å‡ æ­¥ï¼š

å­—ç¬¦è¿‡æ»¤ï¼šå»é™¤ç‰¹æ®Šå­—ç¬¦ã€HTML æ ‡ç­¾æˆ–è¿›è¡Œå…¶ä»–æ–‡æœ¬æ¸…ç†ã€‚
åˆ†è¯ï¼šæ ¹æ®æŒ‡å®šçš„åˆ†è¯å™¨ï¼ˆanalyzerï¼‰ï¼Œå°†æ–‡æœ¬æŒ‰è§„åˆ™æ‹†åˆ†æˆä¸€ä¸ªä¸ªè¯æ¡ã€‚ä¾‹å¦‚ï¼Œè‹±æ–‡å¯ä»¥æŒ‰ç©ºæ ¼æ‹†åˆ†ï¼Œä¸­æ–‡ä½¿ç”¨ä¸“é—¨çš„åˆ†è¯å™¨å¤„ç†ã€‚
è¯æ±‡è¿‡æ»¤ï¼šå¯¹åˆ†è¯ç»“æœè¿›è¡Œè¿‡æ»¤ï¼Œå¦‚å»æ‰åœç”¨è¯ï¼ˆå¸¸è§ä½†æ— æ„ä¹‰çš„è¯ï¼Œå¦‚ "the"ã€"is" ç­‰ï¼‰æˆ–è¿›è¡Œè¯å½¢å½’å¹¶ï¼ˆå¦‚å°†åŠ¨è¯å˜ä¸ºåŸå½¢ï¼‰ã€‚
Elasticsearch å†…ç½®äº†å¾ˆå¤šåˆ†è¯å™¨ï¼Œæ¯”å¦‚æŒ‰ç…§ç©ºæ ¼åˆ†è¯ç­‰ï¼Œé»˜è®¤åªæ”¯æŒè‹±æ–‡ï¼Œå¯ä»¥åœ¨ å®˜æ–¹æ–‡æ¡£ äº†è§£ã€‚

2ï¼‰å€’æ’ç´¢å¼•ï¼š

å€’æ’ç´¢å¼•æ˜¯ Elasticsearch å®ç°é«˜æ•ˆæœç´¢çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚å®ƒå°†æ–‡æ¡£ä¸­çš„è¯æ¡æ˜ å°„åˆ°æ–‡æ¡£ IDï¼Œå®ç°å¿«é€ŸæŸ¥æ‰¾ã€‚

å·¥ä½œåŸç†ï¼š

æ¯ä¸ªæ–‡æ¡£åœ¨è¢«ç´¢å¼•æ—¶ï¼Œåˆ†è¯å™¨ä¼šå°†æ–‡æ¡£å†…å®¹æ‹†è§£ä¸ºå¤šä¸ªè¯æ¡ã€‚
ç„¶åï¼ŒElasticsearch ä¸ºæ¯ä¸ªè¯æ¡ç”Ÿæˆä¸€ä¸ªå€’æ’ç´¢å¼•ï¼Œè®°å½•è¯¥è¯æ¡åœ¨å“ªäº›æ–‡æ¡£ä¸­å‡ºç°ã€‚
ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªæ–‡æ¡£ï¼š

æ–‡æ¡£ 1ï¼šé±¼çš®æ˜¯å¸…é”…
æ–‡æ¡£ 2ï¼šé±¼çš®æ˜¯å¥½äºº
ä¸­æ–‡åˆ†è¯åï¼Œç”Ÿæˆçš„å€’æ’ç´¢å¼•å¤§è‡´å¦‚ä¸‹ï¼š

è¯æ¡	æ–‡æ¡£ ID
é±¼çš®	1, 2
æ˜¯	1, 2
å¸…é”…	1
å¥½äºº	2
é€šè¿‡è¿™ç§ç»“æ„ï¼ŒæŸ¥è¯¢æŸä¸ªè¯æ—¶ï¼Œå¯ä»¥å¿«é€Ÿæ‰¾åˆ°åŒ…å«è¯¥è¯çš„æ‰€æœ‰æ–‡æ¡£ã€‚

5ã€Elasticsearch æ‰“åˆ†è§„åˆ™
å®é™…åº”ç”¨ Elasticsearch æ¥å®ç°æœç´¢åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬ä¸ä»…è¦æ±‚èƒ½æœåˆ°å†…å®¹ï¼Œè€Œä¸”è¿˜è¦æŠŠå’Œç”¨æˆ·æœç´¢æœ€ç›¸å…³çš„å†…å®¹å±•ç¤ºåœ¨å‰é¢ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬äº†è§£ Elasticsearch çš„æ‰“åˆ†è§„åˆ™ã€‚

æ‰“åˆ†è§„åˆ™ï¼ˆ_Scoreï¼‰æ˜¯ç”¨äºè¡¡é‡æ¯ä¸ªæ–‡æ¡£ä¸æŸ¥è¯¢æ¡ä»¶çš„åŒ¹é…åº¦çš„è¯„åˆ†æœºåˆ¶ã€‚æœç´¢ç»“æœçš„é»˜è®¤æ’åºæ–¹å¼æ˜¯æŒ‰ç›¸å…³æ€§å¾—åˆ†ï¼ˆ_scoreï¼‰ä»é«˜åˆ°ä½ã€‚Elasticsearch ä½¿ç”¨ BM25 ç®—æ³• æ¥è®¡ç®—æ¯ä¸ªæ–‡æ¡£çš„å¾—åˆ†ï¼Œå®ƒæ˜¯åŸºäºè¯é¢‘ã€åå‘æ–‡æ¡£é¢‘ç‡ã€æ–‡æ¡£é•¿åº¦ç­‰å› ç´ æ¥è¯„ä¼°æ–‡æ¡£å’ŒæŸ¥è¯¢çš„ç›¸å…³æ€§ã€‚

æ‰“åˆ†çš„ä¸»è¦å› ç´ ï¼š

è¯é¢‘ï¼ˆTF, Term Frequencyï¼‰ï¼šæŸ¥è¯¢è¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œå‡ºç°æ¬¡æ•°è¶Šå¤šï¼Œå¾—åˆ†è¶Šé«˜ã€‚
åå‘æ–‡æ¡£é¢‘ç‡ï¼ˆIDF, Inverse Document Frequencyï¼‰ï¼šæŸ¥è¯¢è¯åœ¨æ‰€æœ‰æ–‡æ¡£ä¸­å‡ºç°çš„é¢‘ç‡ã€‚è¯åœ¨è¶Šå°‘çš„æ–‡æ¡£ä¸­å‡ºç°ï¼ŒIDF å€¼è¶Šé«˜ï¼Œå¾—åˆ†è¶Šé«˜ã€‚
æ–‡æ¡£é•¿åº¦ï¼šè¾ƒçŸ­çš„æ–‡æ¡£å¾€å¾€è¢«è®¤ä¸ºæ›´ç›¸å…³ï¼Œå› ä¸ºæŸ¥è¯¢è¯åœ¨çŸ­æ–‡æ¡£ä¸­å çš„æ¯”ä¾‹æ›´å¤§ã€‚
ä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼šå‡è®¾è¦åœ¨ Elasticsearch ä¸­æŸ¥è¯¢ é±¼çš® è¿™ä¸ªå…³é”®è¯ï¼Œç´¢å¼•ä¸­æœ‰ä»¥ä¸‹ä¸‰ä¸ªæ–‡æ¡£ï¼š

æ–‡æ¡£ 1ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ï¼Œé±¼çš®éå¸¸èªæ˜ï¼Œé±¼çš®å¾ˆå–œæ¬¢ç¼–ç¨‹ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 3 æ¬¡ã€‚
è¯¥æ–‡æ¡£è¾ƒçŸ­ï¼ŒæŸ¥è¯¢è¯ é±¼çš® çš„å¯†åº¦å¾ˆé«˜ã€‚
ç”±äº é±¼çš® åœ¨æ–‡æ¡£ä¸­å¤šæ¬¡å‡ºç°ä¸”æ–‡æ¡£è¾ƒçŸ­ï¼Œå› æ­¤å¾—åˆ†è¾ƒé«˜ï¼Œç›¸å…³æ€§è¾ƒå¼ºã€‚

æ–‡æ¡£ 2ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 1 æ¬¡ã€‚
æ–‡æ¡£éå¸¸çŸ­
å°½ç®¡æ–‡æ¡£çŸ­ï¼Œä½†æ˜¯æŸ¥è¯¢è¯å‡ºç°çš„æ¬¡æ•°å°‘ï¼Œå› æ­¤å¾—åˆ†ä¸­ç­‰ï¼Œç›¸å…³æ€§è¾ƒæ™®é€šã€‚

æ–‡æ¡£ 3ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
é±¼çš®æ˜¯ä¸ªå¸…å°ä¼™ï¼Œä»–å–œæ¬¢å†™ä»£ç ã€‚ä»–çš„æœ‹å‹ä»¬ä¹Ÿå¾ˆå–œæ¬¢ç¼–ç¨‹å’ŒæŠ€æœ¯è®¨è®ºï¼Œå¤§å®¶ç»å¸¸ä¸€èµ·å‚ä¸å„ç§æŠ€æœ¯ä¼šè®®ï¼Œè®¨è®ºåˆ†å¸ƒå¼ç³»ç»Ÿã€æœºå™¨å­¦ä¹ å’Œäººå·¥æ™ºèƒ½ç­‰ä¸»é¢˜ã€‚
åˆ†æï¼š

æŸ¥è¯¢è¯ é±¼çš® å‡ºç°äº† 1 æ¬¡ã€‚
æ–‡æ¡£è¾ƒé•¿ï¼Œä¸” é±¼çš® åªåœ¨æ–‡æ¡£å¼€å¤´å‡ºç°ï¼Œè¯æ¡å¯†åº¦è¾ƒä½ã€‚
ç”±äºæ–‡æ¡£å¾ˆé•¿ï¼Œé±¼çš® å‡ºç°çš„æ¬¡æ•°å°‘ï¼Œå¯†åº¦ä¹Ÿä½ï¼Œå› æ­¤å¾—åˆ†è¾ƒä½ï¼Œç›¸å…³æ€§ä¸å¼ºã€‚

å†ä¸¾ä¸ªä¾‹å­ï¼Œä»€ä¹ˆæ˜¯åå‘æ–‡æ¡£é¢‘ç‡ï¼Ÿ

å‡å¦‚è¯´ ES ä¸­æœ‰ 10 ä¸ªæ–‡æ¡£ï¼Œéƒ½åŒ…å«äº†â€œé±¼çš®â€è¿™ä¸ªå…³é”®è¯ï¼›åªæœ‰ 1 ä¸ªæ–‡æ¡£åŒ…å«äº†â€œå¸…é”…â€è¿™ä¸ªå…³é”®è¯ã€‚

ç°åœ¨ç”¨æˆ·æœç´¢â€œé±¼çš®å¸…é”…â€ï¼Œå¤§æ¦‚ç‡ä¼šæŠŠåé¢è¿™æ¡æ–‡æ¡£æœå‡ºæ¥ï¼Œå› ä¸ºæ›´ç¨€æœ‰ã€‚

å½“ç„¶ï¼Œä»¥ä¸Šåªæ˜¯ç®€å•ä¸¾ä¾‹ï¼Œå®é™…ä¸Š ES è®¡ç®—æ‰“åˆ†è§„åˆ™æ—¶ï¼Œä¼šæœ‰ä¸€å¥—è¾ƒä¸ºå¤æ‚çš„å…¬å¼ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯»ä¸‹é¢èµ„æ–™æ¥äº†è§£ï¼š

é±¼çš®æ–‡ç« ï¼šhttps://liyupi.blog.csdn.net/article/details/119176943
å®˜æ–¹æ–‡ç« ï¼šhttps://www.elastic.co/guide/en/elasticsearch/guide/master/controlling-relevance.html
6ã€Elasticsearch æŸ¥è¯¢è¯­æ³•
Elasticsearch æ”¯æŒå¤šç§æŸ¥è¯¢è¯­æ³•ï¼Œç”¨äºä¸åŒçš„åœºæ™¯å’Œéœ€æ±‚ï¼Œä¸»è¦åŒ…æ‹¬æŸ¥è¯¢ DSLã€EQLã€SQL ç­‰ã€‚

1ï¼‰DSL æŸ¥è¯¢ï¼ˆDomain Specific Languageï¼‰

ä¸€ç§åŸºäº JSON çš„æŸ¥è¯¢è¯­è¨€ï¼Œå®ƒæ˜¯ Elasticsearch ä¸­æœ€å¸¸ç”¨çš„æŸ¥è¯¢æ–¹å¼ã€‚

ç¤ºä¾‹ï¼š

â–¼
json
å¤åˆ¶ä»£ç 
{
  "query": {
    "match": {
      "message": "Elasticsearch æ˜¯å¼ºå¤§çš„"
    }
  }
}
è¿™ä¸ªæŸ¥è¯¢ä¼šå¯¹ message å­—æ®µè¿›è¡Œåˆ†è¯ï¼Œå¹¶æŸ¥æ‰¾åŒ…å« "Elasticsearch" å’Œ "å¼ºå¤§" è¯æ¡çš„æ–‡æ¡£ã€‚

2ï¼‰EQL

EQL å…¨ç§° Event Query Languageï¼Œæ˜¯ä¸€ç§ç”¨äºæ£€æµ‹å’Œæ£€ç´¢æ—¶é—´åºåˆ— äº‹ä»¶ çš„æŸ¥è¯¢è¯­è¨€ï¼Œå¸¸ç”¨äºæ—¥å¿—å’Œå®‰å…¨ç›‘æ§åœºæ™¯ã€‚

ç¤ºä¾‹ï¼šæŸ¥æ‰¾ç‰¹å®šäº‹ä»¶

â–¼
plain
å¤åˆ¶ä»£ç 
process where process.name == "malware.exe"
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ process.name ä¸º "malware.exe" çš„æ‰€æœ‰è¿›ç¨‹äº‹ä»¶ï¼Œå¸¸ç”¨äºå®‰å…¨æ£€æµ‹ä¸­çš„æ¶æ„è½¯ä»¶åˆ†æã€‚

3ï¼‰SQL æŸ¥è¯¢

Elasticsearch æä¾›äº†ç±»ä¼¼äºä¼ ç»Ÿæ•°æ®åº“çš„ SQL æŸ¥è¯¢è¯­æ³•ï¼Œå…è®¸ç”¨æˆ·ä»¥ SQL çš„å½¢å¼æŸ¥è¯¢ Elasticsearch ä¸­çš„æ•°æ®ï¼Œå¯¹ç†Ÿæ‚‰ SQL çš„ç”¨æˆ·æ¥è¯´éå¸¸æ–¹ä¾¿ã€‚

ç¤ºä¾‹ SQL æŸ¥è¯¢ï¼š

â–¼
sql
å¤åˆ¶ä»£ç 
SELECT name, age FROM users WHERE age > 30 ORDER BY age DESC
è¿™ä¸ªæŸ¥è¯¢ä¼šè¿”å› users ç´¢å¼•ä¸­ age å¤§äº 30 çš„æ‰€æœ‰ç”¨æˆ·ï¼Œå¹¶æŒ‰å¹´é¾„é™åºæ’åºã€‚

ä»¥ä¸‹å‡ ç§ç®€å•äº†è§£å³å¯ï¼š

4ï¼‰Lucene æŸ¥è¯¢è¯­æ³•

Lucene æ˜¯ Elasticsearch åº•å±‚çš„æœç´¢å¼•æ“ï¼ŒElasticsearch æ”¯æŒç›´æ¥ä½¿ç”¨ Lucene çš„æŸ¥è¯¢è¯­æ³•ï¼Œé€‚åˆç®€å•çš„å­—ç¬¦ä¸²æŸ¥è¯¢ã€‚

ç¤ºä¾‹ Lucene æŸ¥è¯¢ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
name:Elasticsearch AND age:[30 TO 40]
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ name å­—æ®µä¸º "Elasticsearch" ä¸” age åœ¨ 30 åˆ° 40 ä¹‹é—´çš„æ–‡æ¡£ã€‚

5ï¼‰Kueryï¼ˆKQL: Kibana Query Languageï¼‰

KQL æ˜¯ Kibana çš„æŸ¥è¯¢è¯­è¨€ï¼Œä¸“é—¨ç”¨äºåœ¨ Kibana ç•Œé¢ä¸Šæ‰§è¡Œæœç´¢æŸ¥è¯¢ï¼Œå¸¸ç”¨äºä»ªè¡¨ç›˜å’Œæ•°æ®æ¢ç´¢ä¸­ã€‚

ç¤ºä¾‹ KQL æŸ¥è¯¢ï¼š

â–¼
plain
å¤åˆ¶ä»£ç 
name: "Elasticsearch" and age > 30
è¿™ä¸ªæŸ¥è¯¢ä¼šæŸ¥æ‰¾ name ä¸º "Elasticsearch" ä¸” age å¤§äº 30 çš„æ–‡æ¡£ã€‚

6ï¼‰Painless è„šæœ¬æŸ¥è¯¢

Painless æ˜¯ Elasticsearch çš„å†…ç½®è„šæœ¬è¯­è¨€ï¼Œç”¨äºæ‰§è¡Œè‡ªå®šä¹‰çš„è„šæœ¬æ“ä½œï¼Œå¸¸ç”¨äºæ’åºã€èšåˆæˆ–å¤æ‚è®¡ç®—åœºæ™¯ã€‚

ç¤ºä¾‹ Painless è„šæœ¬ï¼š

â–¼
json
å¤åˆ¶ä»£ç 
{
  "query": {
    "script_score": {
      "query": {
        "match": { "message": "Elasticsearch" }
      },
      "script": {
        "source": "doc['popularity'].value * 2"
      }
    }
  }
}
è¿™ä¸ªæŸ¥è¯¢ä¼šåŸºäº popularity å­—æ®µçš„å€¼è¿›è¡ŒåŠ¨æ€è¯„åˆ†ï¼Œå°†å…¶ä¹˜ä»¥ 2ã€‚

æ€»ç»“ä¸€ä¸‹ï¼ŒDSL æ˜¯æœ€é€šç”¨çš„ï¼ŒEQL å’Œ KQL åˆ™é€‚ç”¨äºç‰¹å®šåœºæ™¯ï¼Œå¦‚æ—¥å¿—åˆ†æå’Œ Kibana æŸ¥è¯¢ï¼Œè€Œ SQL åˆ™ä¾¿äºæ•°æ®åº“å¼€å‘äººå‘˜ä¸Šæ‰‹ã€‚

7ã€Elasticsearch æŸ¥è¯¢æ¡ä»¶
å¦‚ä½•åˆ©ç”¨ Elasticsearch å®ç°æ•°æ®ç­›é€‰å‘¢ï¼Ÿéœ€è¦äº†è§£å…¶æŸ¥è¯¢æ¡ä»¶ï¼Œä»¥ ES çš„ DSL è¯­æ³•ä¸ºä¾‹ï¼š

æŸ¥è¯¢æ¡ä»¶	ä»‹ç»	ç¤ºä¾‹	ç”¨é€”
match	ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œå°†æŸ¥è¯¢å­—ç¬¦ä¸²è¿›è¡Œåˆ†è¯å¹¶åŒ¹é…æ–‡æ¡£ä¸­å¯¹åº”çš„å­—æ®µã€‚	{ "match": { "content": "é±¼çš®æ˜¯å¸…å°ä¼™" } }	é€‚ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œåˆ†è¯ååŒ¹é…æ–‡æ¡£å†…å®¹ã€‚
term	ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼Œä¸è¿›è¡Œåˆ†è¯ã€‚é€šå¸¸ç”¨äºç»“æ„åŒ–æ•°æ®çš„ç²¾ç¡®åŒ¹é…ï¼Œå¦‚æ•°å­—ã€æ—¥æœŸã€å…³é”®è¯ç­‰ã€‚	{ "term": { "status": "active" } }	é€‚ç”¨äºå­—æ®µçš„ç²¾ç¡®åŒ¹é…ï¼Œå¦‚çŠ¶æ€ã€IDã€å¸ƒå°”å€¼ç­‰ã€‚
terms	åŒ¹é…å¤šä¸ªå€¼ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œç›¸å½“äºå¤šä¸ª term æŸ¥è¯¢çš„ç»„åˆã€‚	{ "terms": { "status": ["active", "pending"] } }	é€‚ç”¨äºå¤šå€¼åŒ¹é…çš„åœºæ™¯ã€‚
range	èŒƒå›´æŸ¥è¯¢ï¼Œå¸¸ç”¨äºæ•°å­—ã€æ—¥æœŸå­—æ®µï¼Œæ”¯æŒå¤§äºã€å°äºã€åŒºé—´ç­‰æŸ¥è¯¢ã€‚	{ "range": { "age": { "gte": 18, "lte": 30 } } }	é€‚ç”¨äºæ•°å€¼æˆ–æ—¥æœŸçš„èŒƒå›´æŸ¥è¯¢ã€‚
bool	ç»„åˆæŸ¥è¯¢ï¼Œé€šè¿‡ mustã€shouldã€must_not ç­‰ç»„åˆå¤šä¸ªæŸ¥è¯¢æ¡ä»¶ã€‚	{ "bool": { "must": [ { "term": { "status": "active" } }, { "range": { "age": { "gte": 18 } } } ] } }	é€‚ç”¨äºå¤æ‚çš„å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œå¯ä»¥çµæ´»ç»„åˆã€‚
wildcard	é€šé…ç¬¦æŸ¥è¯¢ï¼Œæ”¯æŒ * å’Œ ?ï¼Œå‰è€…åŒ¹é…ä»»æ„å­—ç¬¦ï¼Œåè€…åŒ¹é…å•ä¸ªå­—ç¬¦ã€‚	{ "wildcard": { "name": "é±¼*" } }	é€‚ç”¨äºéƒ¨åˆ†åŒ¹é…çš„æŸ¥è¯¢ï¼Œå¦‚æ¨¡ç³Šæœç´¢ã€‚
prefix	å‰ç¼€æŸ¥è¯¢ï¼ŒåŒ¹é…ä»¥æŒ‡å®šå‰ç¼€å¼€å¤´çš„å­—æ®µå†…å®¹ã€‚	{ "prefix": { "name": "é±¼" } }	é€‚ç”¨äºæŸ¥æ‰¾ä»¥æŒ‡å®šå­—ç¬¦ä¸²å¼€å¤´çš„å†…å®¹ã€‚
fuzzy	æ¨¡ç³ŠæŸ¥è¯¢ï¼Œå…è®¸æŒ‡å®šç¨‹åº¦çš„æ‹¼å†™é”™è¯¯æˆ–å­—ç¬¦æ›¿æ¢ã€‚	{ "fuzzy": { "name": "yupi~2" } }	é€‚ç”¨äºå¤„ç†æ‹¼å†™é”™è¯¯æˆ–ä¸å®Œå…¨åŒ¹é…çš„æŸ¥è¯¢ã€‚
exists	æŸ¥è¯¢æŸå­—æ®µæ˜¯å¦å­˜åœ¨ã€‚	{ "exists": { "field": "name" } }	é€‚ç”¨äºæŸ¥æ‰¾å­—æ®µå­˜åœ¨æˆ–ç¼ºå¤±çš„æ–‡æ¡£ã€‚
match_phrase	çŸ­è¯­åŒ¹é…æŸ¥è¯¢ï¼Œè¦æ±‚æŸ¥è¯¢çš„è¯è¯­æŒ‰é¡ºåºå®Œå…¨åŒ¹é…ã€‚	{ "match_phrase": { "content": "é±¼çš® å¸…å°ä¼™" } }	é€‚ç”¨äºä¸¥æ ¼çš„çŸ­è¯­åŒ¹é…ï¼Œè¯è¯­é¡ºåºå’Œè·ç¦»éƒ½ä¸¥æ ¼æ§åˆ¶ã€‚
match_all	åŒ¹é…æ‰€æœ‰æ–‡æ¡£ã€‚	{ "match_all": {} }	é€‚ç”¨äºæŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼Œé€šå¸¸ä¸åˆ†é¡µé…åˆä½¿ç”¨ã€‚
ids	åŸºäºæ–‡æ¡£ ID æŸ¥è¯¢ï¼Œæ”¯æŒæŸ¥è¯¢ç‰¹å®š ID çš„æ–‡æ¡£ã€‚	{ "ids": { "values": ["1", "2", "3"] } }	é€‚ç”¨äºæ ¹æ®æ–‡æ¡£ ID æŸ¥æ‰¾ç‰¹å®šæ–‡æ¡£ã€‚
geo_distance	åœ°ç†ä½ç½®æŸ¥è¯¢ï¼ŒåŸºäºåœ°ç†åæ ‡å’ŒæŒ‡å®šè·ç¦»æŸ¥è¯¢ã€‚	{ "geo_distance": { "distance": "12km", "location": { "lat": 40.73, "lon": -74.1 } } }	é€‚ç”¨äºæ ¹æ®è·ç¦»è®¡ç®—æŸ¥æ‰¾åœ°ç†ä½ç½®é™„è¿‘çš„æ–‡æ¡£ã€‚
aggregations	èšåˆæŸ¥è¯¢ï¼Œç”¨äºç»Ÿè®¡ã€è®¡ç®—å’Œåˆ†ç»„æŸ¥è¯¢ï¼Œç±»ä¼¼ SQL ä¸­çš„ GROUP BYã€‚	{ "aggs": { "age_stats": { "stats": { "field": "age" } } } }	é€‚ç”¨äºç»Ÿè®¡å’Œåˆ†ææ•°æ®ï¼Œæ¯”å¦‚æ±‚å’Œã€å¹³å‡å€¼ã€æœ€å¤§å€¼ç­‰ã€‚
å…¶ä¸­çš„å‡ ä¸ªå…³é”®ï¼š

ç²¾ç¡®åŒ¹é… vs. å…¨æ–‡æ£€ç´¢ï¼šterm æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œä¸åˆ†è¯ï¼›match ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œä¼šå¯¹æŸ¥è¯¢è¯è¿›è¡Œåˆ†è¯ã€‚
ç»„åˆæŸ¥è¯¢ï¼šbool æŸ¥è¯¢å¯ä»¥çµæ´»ç»„åˆå¤šä¸ªæ¡ä»¶ï¼Œé€‚ç”¨äºå¤æ‚çš„æŸ¥è¯¢éœ€æ±‚ã€‚
æ¨¡ç³ŠæŸ¥è¯¢ï¼šfuzzy å’Œ wildcard æä¾›äº†çµæ´»çš„æ¨¡ç³ŠåŒ¹é…æ–¹å¼ï¼Œé€‚ç”¨äºæ‹¼å†™é”™è¯¯æˆ–ä¸å®Œå…¨åŒ¹é…çš„åœºæ™¯ã€‚
äº†è§£ä¸Šé¢è¿™äº›ä¸€èˆ¬å°±è¶³å¤Ÿäº†ï¼Œæ›´å¤šå¯ä»¥éšç”¨éšæŸ¥ï¼Œå‚è€ƒ å®˜æ–¹æ–‡æ¡£ ã€‚

8ã€Elasticsearch å®¢æˆ·ç«¯
å‰é¢äº†è§£äº† Elasticsearch çš„æ¦‚å¿µå’ŒæŸ¥è¯¢è¯­æ³•ï¼Œä½†æ˜¯å¦‚ä½•æ‰§è¡Œ Elasticsearch æ“ä½œå‘¢ï¼Ÿè¿˜éœ€è¦äº†è§£ä¸‹ ES çš„å®¢æˆ·ç«¯ï¼Œåˆ—ä¸¾ä¸€äº›å¸¸ç”¨çš„ï¼š

1ï¼‰HTTP APIï¼šElasticsearch æä¾›äº† RESTful HTTP APIï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç›´æ¥å‘é€ HTTP è¯·æ±‚æ¥æ‰§è¡Œç´¢å¼•ã€æœç´¢å’Œç®¡ç†é›†ç¾¤çš„æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

2ï¼‰Kibanaï¼šKibana æ˜¯ Elasticsearch å®˜æ–¹æä¾›çš„å¯è§†åŒ–å·¥å…·ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ Kibana æ§åˆ¶å°ä½¿ç”¨æŸ¥è¯¢è¯­æ³•ï¼ˆå¦‚ DSLã€KQLï¼‰æ¥æ‰§è¡Œæœç´¢ã€åˆ†æå’Œæ•°æ®å¯è§†åŒ–ã€‚

3ï¼‰Java REST Clientï¼šElasticsearch å®˜æ–¹æä¾›çš„ Java é«˜çº§ REST å®¢æˆ·ç«¯åº“ï¼Œç”¨äº Java ç¨‹åºä¸­ä¸ Elasticsearch è¿›è¡Œé€šä¿¡ï¼Œæ”¯æŒç´¢å¼•ã€æŸ¥è¯¢ã€é›†ç¾¤ç®¡ç†ç­‰æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

4ï¼‰Spring Data Elasticsearchï¼šSpring å…¨å®¶æ¡¶çš„ä¸€å‘˜ï¼Œç”¨äºå°† Elasticsearch ä¸ Spring æ¡†æ¶é›†æˆï¼Œé€šè¿‡ç®€åŒ–çš„ Repository æ–¹å¼è¿›è¡Œç´¢å¼•ã€æŸ¥è¯¢å’Œæ•°æ®ç®¡ç†æ“ä½œã€‚å®˜æ–¹æ–‡æ¡£

5ï¼‰Elasticsearch SQL CLIï¼šå‘½ä»¤è¡Œå·¥å…·ï¼Œå…è®¸é€šè¿‡ç±» SQL è¯­æ³•ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æŸ¥è¯¢ Elasticsearch æ•°æ®ï¼Œé€‚ç”¨äºç†Ÿæ‚‰ SQL çš„ç”¨æˆ·ã€‚

æ­¤å¤–ï¼ŒElasticsearch å½“ç„¶ä¸åªæœ‰ Java çš„å®¢æˆ·ç«¯ï¼ŒPythonã€PHPã€Node.jsã€Go çš„å®¢æˆ·ç«¯éƒ½æ˜¯æ”¯æŒçš„ã€‚

ğŸ’¡ åœ¨é€‰æ‹©å®¢æˆ·ç«¯æ—¶ï¼Œè¦æ ¼å¤–æ³¨æ„ç‰ˆæœ¬å·ï¼ï¼ï¼è¦è·Ÿ Elasticsearch çš„ç‰ˆæœ¬ä¿æŒå…¼å®¹ã€‚

9ã€ES æ•°æ®åŒæ­¥æ–¹æ¡ˆ
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœåšæŸ¥è¯¢æœç´¢åŠŸèƒ½ï¼Œä½¿ç”¨ ES æ¥æ¨¡ç³Šæœç´¢ï¼Œä½†æ˜¯æ•°æ®æ˜¯å­˜æ”¾åœ¨æ•°æ®åº“ MySQL é‡Œçš„ï¼Œæ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦æŠŠ MySQL ä¸­çš„æ•°æ®å’Œ ES è¿›è¡ŒåŒæ­¥ï¼Œä¿è¯æ•°æ®ä¸€è‡´ï¼ˆä»¥ MySQL ä¸ºä¸»ï¼‰ã€‚

æ•°æ®æµå‘ï¼šMySQL => ES ï¼ˆå•å‘ï¼‰

æ•°æ®åŒæ­¥ä¸€èˆ¬æœ‰ 2 ä¸ªè¿‡ç¨‹ï¼šå…¨é‡åŒæ­¥ï¼ˆé¦–æ¬¡ï¼‰+ å¢é‡åŒæ­¥ï¼ˆæ–°æ•°æ®ï¼‰

æ€»å…±æœ‰ 4 ç§ä¸»æµæ–¹æ¡ˆï¼š

1ï¼‰å®šæ—¶ä»»åŠ¡

æ¯”å¦‚ 1 åˆ†é’Ÿ 1 æ¬¡ï¼Œæ‰¾åˆ° MySQL ä¸­è¿‡å»å‡ åˆ†é’Ÿå†…ï¼ˆè‡³å°‘æ˜¯å®šæ—¶å‘¨æœŸçš„ 2 å€ï¼‰å‘ç”Ÿæ”¹å˜çš„æ•°æ®ï¼Œç„¶åæ›´æ–°åˆ° ESã€‚

ä¼˜ç‚¹ï¼š

ç®€å•æ˜“æ‡‚ï¼Œå¼€å‘ã€éƒ¨ç½²ã€ç»´æŠ¤ç›¸å¯¹å®¹æ˜“ã€‚
å ç”¨èµ„æºå°‘ï¼Œä¸éœ€è¦å¼•å…¥å¤æ‚çš„ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶ã€‚
ä¸ç”¨å¤„ç†å¤æ‚çš„å¹¶å‘å’Œå®æ—¶æ€§é—®é¢˜ã€‚
ç¼ºç‚¹ï¼š

æœ‰æ—¶é—´å·®ï¼šæ— æ³•åšåˆ°å®æ—¶åŒæ­¥ï¼Œæ•°æ®å­˜åœ¨æ»åã€‚
æ•°æ®é¢‘ç¹å˜åŒ–æ—¶ï¼Œæ— æ³•ç¡®ä¿æ•°æ®å®Œå…¨åŒæ­¥ï¼Œå®¹æ˜“å‡ºç°é”™è¿‡æ›´æ–°çš„æƒ…å†µã€‚
å¯¹å¤§æ•°æ®é‡çš„æ›´æ–°å¤„ç†ä¸å¤Ÿé«˜æ•ˆï¼Œå¯èƒ½ä¼šå¼•å…¥é‡å¤æ›´æ–°é€»è¾‘ã€‚
åº”ç”¨åœºæ™¯ï¼š

æ•°æ®å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼šé€‚åˆæ•°æ®çŸ­æ—¶é—´å†…ä¸åŒæ­¥ä¸ä¼šå¸¦æ¥é‡å¤§å½±å“çš„åœºæ™¯ã€‚
æ•°æ®åŸºæœ¬ä¸å‘ç”Ÿä¿®æ”¹ï¼šé€‚åˆæ•°æ®å‡ ä¹ä¸ä¿®æ”¹ã€ä¿®æ”¹ä¸é¢‘ç¹çš„åœºæ™¯ã€‚
æ•°æ®å®¹å¿ä¸¢å¤±
2ï¼‰åŒå†™

å†™æ•°æ®çš„æ—¶å€™ï¼Œå¿…é¡»ä¹Ÿå»å†™ ESï¼›æ›´æ–°åˆ é™¤æ•°æ®åº“åŒç†ã€‚

å¯ä»¥é€šè¿‡äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½¿ç”¨äº‹åŠ¡æ—¶ï¼Œè¦å…ˆä¿è¯ MySQL å†™æˆåŠŸï¼Œå› ä¸ºå¦‚æœ ES å†™å…¥å¤±è´¥äº†ï¼Œä¸ä¼šè§¦å‘å›æ»šï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡ + æ—¥å¿— + å‘Šè­¦è¿›è¡Œæ£€æµ‹å’Œä¿®å¤ï¼ˆè¡¥å¿ï¼‰ã€‚

ä¼˜ç‚¹ï¼š

æ–¹æ¡ˆç®€å•æ˜“æ‡‚ï¼Œä¸šåŠ¡é€»è¾‘ç›´æ¥æ§åˆ¶æ•°æ®åŒæ­¥ã€‚
å¯ä»¥åˆ©ç”¨äº‹åŠ¡éƒ¨åˆ†ä¿è¯ MySQL å’Œ ES çš„æ•°æ®ä¸€è‡´æ€§ã€‚
åŒæ­¥çš„æ—¶å»¶è¾ƒçŸ­ï¼Œç†è®ºä¸Šå¯ä»¥æ¥è¿‘å®æ—¶æ›´æ–° ESã€‚
ç¼ºç‚¹ï¼š

å½±å“æ€§èƒ½ï¼šæ¯æ¬¡å†™ MySQL æ—¶ï¼Œéœ€è¦åŒæ—¶æ“ä½œ ESï¼Œå¢åŠ äº†ä¸šåŠ¡å†™å…¥å»¶è¿Ÿï¼Œå½±å“æ€§èƒ½ã€‚
ä¸€è‡´æ€§é—®é¢˜ï¼šå¦‚æœ ES å†™å…¥å¤±è´¥ï¼ŒMySQL äº‹åŠ¡æäº¤æˆåŠŸåï¼ŒES å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ï¼›æˆ–è€… ES å†™å…¥æˆåŠŸï¼ŒMySQL äº‹åŠ¡æäº¤å¤±è´¥ï¼ŒES æ— æ³•å›æ»šã€‚å› æ­¤å¿…é¡»é¢å¤–è®¾è®¡ç›‘æ§ã€è¡¥å¿æœºåˆ¶æ¥æ£€æµ‹åŒæ­¥å¤±è´¥çš„æƒ…å†µï¼ˆå¦‚é€šè¿‡å®šæ—¶ä»»åŠ¡ã€æ—¥å¿—å’Œå‘Šè­¦ä¿®å¤ï¼‰ã€‚
ä»£ç å¤æ‚åº¦å¢åŠ ï¼Œéœ€è¦å¯¹æ¯ä¸ªå†™æ“ä½œéƒ½è¿›è¡ŒåŒå†™å¤„ç†ã€‚
åº”ç”¨åœºæ™¯ï¼š

å®æ—¶æ€§è¦æ±‚è¾ƒé«˜
ä¸šåŠ¡å†™å…¥é¢‘ç‡è¾ƒä½ï¼šé€‚åˆå†™æ“ä½œä¸é¢‘ç¹çš„åœºæ™¯ï¼Œè¿™æ ·å¯¹æ€§èƒ½çš„å½±å“è¾ƒå°ã€‚
3ï¼‰ç”¨ Logstash æ•°æ®åŒæ­¥ç®¡é“

ä¸€èˆ¬è¦é…åˆ kafka æ¶ˆæ¯é˜Ÿåˆ— + beats é‡‡é›†å™¨ï¼š

img
ä¼˜ç‚¹ï¼š

é…ç½®é©±åŠ¨ï¼šåŸºäºé…ç½®æ–‡ä»¶ï¼Œå‡å°‘äº†æ‰‹åŠ¨ç¼–ç ï¼Œæ•°æ®åŒæ­¥é€»è¾‘å’Œä¸šåŠ¡ä»£ç è§£è€¦ã€‚
æ‰©å±•æ€§å¥½ï¼šå¯ä»¥çµæ´»å¼•å…¥ Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥æ•°æ®åŒæ­¥ï¼Œå¹¶å¯å¤„ç†é«˜ååé‡æ•°æ®ã€‚
æ”¯æŒå¤šç§æ•°æ®æºï¼šLogstash æ”¯æŒä¸°å¯Œçš„æ•°æ®æºï¼Œæ–¹ä¾¿æ‰©å±•å…¶ä»–åŒæ­¥éœ€æ±‚ã€‚
ç¼ºç‚¹ï¼š

çµæ´»æ€§å·®ï¼šéœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¯èƒ½éš¾ä»¥åœ¨é…ç½®ä¸­å®ç°ï¼Œæ— æ³•å¤„ç†ç»†ç²’åº¦çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚
å¼•å…¥é¢å¤–ç»„ä»¶ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼šé€šå¸¸éœ€è¦å¼•å…¥ Kafkaã€Beats ç­‰ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§å’Œè¿ç»´æˆæœ¬ã€‚
åº”ç”¨åœºæ™¯ï¼š

å¤§æ•°æ®åŒæ­¥ï¼šé€‚åˆå¤§è§„æ¨¡ã€åˆ†å¸ƒå¼æ•°æ®åŒæ­¥åœºæ™¯ã€‚
å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼šé€‚åˆæ•°æ®æµå¤„ç†æˆ–å»¶è¿Ÿå®¹å¿è¾ƒå¤§çš„ç³»ç»Ÿã€‚
ç³»ç»Ÿå·²æœ‰ Kafka æˆ–ç±»ä¼¼çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„ï¼šå¦‚æœç³»ç»Ÿä¸­å·²ç»ä½¿ç”¨äº† Kafka ç­‰ä¸­é—´ä»¶ï¼Œä½¿ç”¨ Logstash ç®¡é“ä¼šå˜å¾—å¾ˆæ–¹ä¾¿ã€‚
4ï¼‰ç›‘å¬ MySQL Binlog

æœ‰ä»»ä½•æ•°æ®å˜æ›´æ—¶éƒ½èƒ½å¤Ÿå®æ—¶ç›‘å¬åˆ°ï¼Œå¹¶ä¸”åŒæ­¥åˆ° Elasticsearchã€‚ä¸€èˆ¬ä¸éœ€è¦è‡ªå·±ç›‘å¬ï¼Œå¯ä»¥ä½¿ç”¨ç°æˆçš„æŠ€æœ¯ï¼Œæ¯”å¦‚ Canal ã€‚

img
ğŸ’¡ Canal çš„æ ¸å¿ƒåŸç†ï¼šæ•°æ®åº“æ¯æ¬¡ä¿®æ”¹æ—¶ï¼Œä¼šä¿®æ”¹ binlog æ–‡ä»¶ï¼Œåªè¦ç›‘å¬è¯¥æ–‡ä»¶çš„ä¿®æ”¹ï¼Œå°±èƒ½ç¬¬ä¸€æ—¶é—´å¾—åˆ°æ¶ˆæ¯å¹¶å¤„ç†

ä¼˜ç‚¹ï¼š

å®æ—¶æ€§å¼ºï¼šèƒ½å¤Ÿåœ¨ MySQL æ•°æ®å‘ç”Ÿå˜æ›´çš„ç¬¬ä¸€æ—¶é—´åŒæ­¥åˆ° ESï¼Œåšåˆ°çœŸæ­£çš„å®æ—¶åŒæ­¥ã€‚
è½»é‡çº§ï¼šBinlog æ˜¯æ•°æ®åº“è‡ªå¸¦çš„æ—¥å¿—åŠŸèƒ½ï¼Œä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä¸šåŠ¡ä»£ç ï¼Œåªéœ€è¦æ–°å¢ç›‘å¬é€»è¾‘ã€‚
ç¼ºç‚¹ï¼š

å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼šéœ€è¦å¼•å…¥åƒ Canal è¿™æ ·çš„ä¸­é—´ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§å’Œç»´æŠ¤æˆæœ¬ã€‚
è¿ç»´éš¾åº¦å¢åŠ ï¼šéœ€è¦ç¡®ä¿ Canal æˆ–è€…å…¶ä»– Binlog ç›‘å¬å™¨çš„ç¨³å®šè¿è¡Œï¼Œå¹¶ä¸”å¯¹ MySQL çš„ Binlog é…ç½®è¦æ±‚è¾ƒé«˜ã€‚
ä¸€è‡´æ€§é—®é¢˜ï¼šå¦‚æœ Canal æœåŠ¡å‡ºç°é—®é¢˜æˆ–æš‚åœï¼Œæ•°æ®å¯èƒ½ä¼šæ»åæˆ–ä¸¢å¤±ï¼Œå¿…é¡»è®¾è®¡è¡¥å¿æœºåˆ¶ã€‚
åº”ç”¨åœºæ™¯ï¼š

å®æ—¶åŒæ­¥è¦æ±‚é«˜ï¼šé€‚åˆéœ€è¦å®æ—¶æ•°æ®åŒæ­¥çš„åœºæ™¯ï¼Œé€šå¸¸ç”¨äºé«˜å¹¶å‘ã€é«˜æ•°æ®ä¸€è‡´æ€§è¦æ±‚çš„ç³»ç»Ÿã€‚
æ•°æ®é¢‘ç¹å˜åŒ–ï¼šé€‚åˆæ•°æ®å˜æ›´é¢‘ç¹ä¸”éœ€è¦é«˜æ•ˆå¢é‡åŒæ­¥çš„åœºæ™¯ã€‚
æœ€ç»ˆæ–¹æ¡ˆï¼šå¯¹äºæœ¬é¡¹ç›®ï¼Œç”±äºæ•°æ®é‡ä¸å¤§ï¼Œé¢˜ç›®æ›´æ–°ä¹Ÿä¸é¢‘ç¹ï¼Œå®¹å¿ä¸¢å¤±å’Œä¸ä¸€è‡´ï¼Œæ‰€ä»¥é€‰ç”¨æ–¹æ¡ˆä¸€ï¼Œå®ç°æˆæœ¬æœ€ä½ã€‚ç¡®ä¿æ•°æ®å®Œå…¨åŒæ­¥ï¼Œå®¹æ˜“å‡ºç°é”™è¿‡æ›´æ–°çš„æƒ…å†µã€‚
å¯¹å¤§æ•°æ®é‡çš„æ›´æ–°å¤„ç†ä¸å¤Ÿé«˜æ•ˆï¼Œå¯èƒ½ä¼šå¼•å…¥é‡å¤æ›´æ–°é€»è¾‘ã€‚
åº”ç”¨åœºæ™¯ï¼š

æ•°æ®å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼šé€‚åˆæ•°æ®çŸ­æ—¶é—´å†…ä¸åŒæ­¥ä¸ä¼šå¸¦æ¥é‡å¤§å½±å“çš„åœºæ™¯ã€‚
æ•°æ®åŸºæœ¬ä¸å‘ç”Ÿä¿®æ”¹ï¼šé€‚åˆæ•°æ®å‡ ä¹ä¸ä¿®æ”¹ã€ä¿®æ”¹ä¸é¢‘ç¹çš„åœºæ™¯ã€‚
æ•°æ®å®¹å¿ä¸¢å¤±
2ï¼‰åŒå†™

å†™æ•°æ®çš„æ—¶å€™ï¼Œå¿…é¡»ä¹Ÿå»å†™ ESï¼›æ›´æ–°åˆ é™¤æ•°æ®åº“åŒç†ã€‚

å¯ä»¥é€šè¿‡äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½¿ç”¨äº‹åŠ¡æ—¶ï¼Œè¦å…ˆä¿è¯ MySQL å†™æˆåŠŸï¼Œå› ä¸ºå¦‚æœ ES å†™å…¥å¤±è´¥äº†ï¼Œä¸ä¼šè§¦å‘å›æ»šï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å®šæ—¶ä»»åŠ¡ + æ—¥å¿— + å‘Šè­¦è¿›è¡Œæ£€æµ‹å’Œä¿®å¤ï¼ˆè¡¥å¿ï¼‰ã€‚

ä¼˜ç‚¹ï¼š

æ–¹æ¡ˆç®€å•æ˜“æ‡‚ï¼Œä¸šåŠ¡é€»è¾‘ç›´æ¥æ§åˆ¶æ•°æ®åŒæ­¥ã€‚
å¯ä»¥åˆ©ç”¨äº‹åŠ¡éƒ¨åˆ†ä¿è¯ MySQL å’Œ ES çš„æ•°æ®ä¸€è‡´æ€§ã€‚
åŒæ­¥çš„æ—¶å»¶è¾ƒçŸ­ï¼Œç†è®ºä¸Šå¯ä»¥æ¥è¿‘å®æ—¶æ›´æ–° ESã€‚
ç¼ºç‚¹ï¼š

å½±å“æ€§èƒ½ï¼šæ¯æ¬¡å†™ MySQL æ—¶ï¼Œéœ€è¦åŒæ—¶æ“ä½œ ESï¼Œå¢åŠ äº†ä¸šåŠ¡å†™å…¥å»¶è¿Ÿï¼Œå½±å“æ€§èƒ½ã€‚
ä¸€è‡´æ€§é—®é¢˜ï¼šå¦‚æœ ES å†™å…¥å¤±è´¥ï¼ŒMySQL äº‹åŠ¡æäº¤æˆåŠŸåï¼ŒES å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ï¼›æˆ–è€… ES å†™å…¥æˆåŠŸï¼ŒMySQL äº‹åŠ¡æäº¤å¤±è´¥ï¼ŒES æ— æ³•å›æ»šã€‚å› æ­¤å¿…é¡»é¢å¤–è®¾è®¡ç›‘æ§ã€è¡¥å¿æœºåˆ¶æ¥æ£€æµ‹åŒæ­¥å¤±è´¥çš„æƒ…å†µï¼ˆå¦‚é€šè¿‡å®šæ—¶ä»»åŠ¡ã€æ—¥å¿—å’Œå‘Šè­¦ä¿®å¤ï¼‰ã€‚
ä»£ç å¤æ‚åº¦å¢åŠ ï¼Œéœ€è¦å¯¹æ¯ä¸ªå†™æ“ä½œéƒ½è¿›è¡ŒåŒå†™å¤„ç†ã€‚
åº”ç”¨åœºæ™¯ï¼š

å®æ—¶æ€§è¦æ±‚è¾ƒé«˜
ä¸šåŠ¡å†™å…¥é¢‘ç‡è¾ƒä½ï¼šé€‚åˆå†™æ“ä½œä¸é¢‘ç¹çš„åœºæ™¯ï¼Œè¿™æ ·å¯¹æ€§èƒ½çš„å½±å“è¾ƒå°ã€‚
3ï¼‰ç”¨ Logstash æ•°æ®åŒæ­¥ç®¡é“

ä¸€èˆ¬è¦é…åˆ kafka æ¶ˆæ¯é˜Ÿåˆ— + beats é‡‡é›†å™¨ï¼š

img
ä¼˜ç‚¹ï¼š

é…ç½®é©±åŠ¨ï¼šåŸºäºé…ç½®æ–‡ä»¶ï¼Œå‡å°‘äº†æ‰‹åŠ¨ç¼–ç ï¼Œæ•°æ®åŒæ­¥é€»è¾‘å’Œä¸šåŠ¡ä»£ç è§£è€¦ã€‚
æ‰©å±•æ€§å¥½ï¼šå¯ä»¥çµæ´»å¼•å…¥ Kafka ç­‰æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥æ•°æ®åŒæ­¥ï¼Œå¹¶å¯å¤„ç†é«˜ååé‡æ•°æ®ã€‚
æ”¯æŒå¤šç§æ•°æ®æºï¼šLogstash æ”¯æŒä¸°å¯Œçš„æ•°æ®æºï¼Œæ–¹ä¾¿æ‰©å±•å…¶ä»–åŒæ­¥éœ€æ±‚ã€‚
ç¼ºç‚¹ï¼š

çµæ´»æ€§å·®ï¼šéœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¯èƒ½éš¾ä»¥åœ¨é…ç½®ä¸­å®ç°ï¼Œæ— æ³•å¤„ç†ç»†ç²’åº¦çš„å®šåˆ¶åŒ–éœ€æ±‚ã€‚
å¼•å…¥é¢å¤–ç»„ä»¶ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼šé€šå¸¸éœ€è¦å¼•å…¥ Kafkaã€Beats ç­‰ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§å’Œè¿ç»´æˆæœ¬ã€‚
åº”ç”¨åœºæ™¯ï¼š

å¤§æ•°æ®åŒæ­¥ï¼šé€‚åˆå¤§è§„æ¨¡ã€åˆ†å¸ƒå¼æ•°æ®åŒæ­¥åœºæ™¯ã€‚
å¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼šé€‚åˆæ•°æ®æµå¤„ç†æˆ–å»¶è¿Ÿå®¹å¿è¾ƒå¤§çš„ç³»ç»Ÿã€‚
ç³»ç»Ÿå·²æœ‰ Kafka æˆ–ç±»ä¼¼çš„æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„ï¼šå¦‚æœç³»ç»Ÿä¸­å·²ç»ä½¿ç”¨äº† Kafka ç­‰ä¸­é—´ä»¶ï¼Œä½¿ç”¨ Logstash ç®¡é“ä¼šå˜å¾—å¾ˆæ–¹ä¾¿ã€‚
4ï¼‰ç›‘å¬ MySQL Binlog

æœ‰ä»»ä½•æ•°æ®å˜æ›´æ—¶éƒ½èƒ½å¤Ÿå®æ—¶ç›‘å¬åˆ°ï¼Œå¹¶ä¸”åŒæ­¥åˆ° Elasticsearchã€‚ä¸€èˆ¬ä¸éœ€è¦è‡ªå·±ç›‘å¬ï¼Œå¯ä»¥ä½¿ç”¨ç°æˆçš„æŠ€æœ¯ï¼Œæ¯”å¦‚ Canal ã€‚

img
ğŸ’¡ Canal çš„æ ¸å¿ƒåŸç†ï¼šæ•°æ®åº“æ¯æ¬¡ä¿®æ”¹æ—¶ï¼Œä¼šä¿®æ”¹ binlog æ–‡ä»¶ï¼Œåªè¦ç›‘å¬è¯¥æ–‡ä»¶çš„ä¿®æ”¹ï¼Œå°±èƒ½ç¬¬ä¸€æ—¶é—´å¾—åˆ°æ¶ˆæ¯å¹¶å¤„ç†

ä¼˜ç‚¹ï¼š

å®æ—¶æ€§å¼ºï¼šèƒ½å¤Ÿåœ¨ MySQL æ•°æ®å‘ç”Ÿå˜æ›´çš„ç¬¬ä¸€æ—¶é—´åŒæ­¥åˆ° ESï¼Œåšåˆ°çœŸæ­£çš„å®æ—¶åŒæ­¥ã€‚
è½»é‡çº§ï¼šBinlog æ˜¯æ•°æ®åº“è‡ªå¸¦çš„æ—¥å¿—åŠŸèƒ½ï¼Œä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä¸šåŠ¡ä»£ç ï¼Œåªéœ€è¦æ–°å¢ç›‘å¬é€»è¾‘ã€‚
ç¼ºç‚¹ï¼š

å¼•å…¥å¤–éƒ¨ä¾èµ–ï¼šéœ€è¦å¼•å…¥åƒ Canal è¿™æ ·çš„ä¸­é—´ä»¶ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§å’Œç»´æŠ¤æˆæœ¬ã€‚
è¿ç»´éš¾åº¦å¢åŠ ï¼šéœ€è¦ç¡®ä¿ Canal æˆ–è€…å…¶ä»– Binlog ç›‘å¬å™¨çš„ç¨³å®šè¿è¡Œï¼Œå¹¶ä¸”å¯¹ MySQL çš„ Binlog é…ç½®è¦æ±‚è¾ƒé«˜ã€‚
ä¸€è‡´æ€§é—®é¢˜ï¼šå¦‚æœ Canal æœåŠ¡å‡ºç°é—®é¢˜æˆ–æš‚åœï¼Œæ•°æ®å¯èƒ½ä¼šæ»åæˆ–ä¸¢å¤±ï¼Œå¿…é¡»è®¾è®¡è¡¥å¿æœºåˆ¶ã€‚
åº”ç”¨åœºæ™¯ï¼š

å®æ—¶åŒæ­¥è¦æ±‚é«˜ï¼šé€‚åˆéœ€è¦å®æ—¶æ•°æ®åŒæ­¥çš„åœºæ™¯ï¼Œé€šå¸¸ç”¨äºé«˜å¹¶å‘ã€é«˜æ•°æ®ä¸€è‡´æ€§è¦æ±‚çš„ç³»ç»Ÿã€‚
æ•°æ®é¢‘ç¹å˜åŒ–ï¼šé€‚åˆæ•°æ®å˜æ›´é¢‘ç¹ä¸”éœ€è¦é«˜æ•ˆå¢é‡åŒæ­¥çš„åœºæ™¯ã€‚
æœ€ç»ˆæ–¹æ¡ˆï¼šå¯¹äºæœ¬é¡¹ç›®ï¼Œç”±äºæ•°æ®é‡ä¸å¤§ï¼Œé¢˜ç›®æ›´æ–°ä¹Ÿä¸é¢‘ç¹ï¼Œå®¹å¿ä¸¢å¤±å’Œä¸ä¸€è‡´ï¼Œæ‰€ä»¥é€‰ç”¨æ–¹æ¡ˆä¸€ï¼Œå®ç°æˆæœ¬æœ€ä½ã€‚
    <groupId>com.alibaba.boot</groupId>
    <artifactId>nacos-config-spring-boot-starter</artifactId>
    <version>0.2.12</version>
</dependency>

<!-- Guava: https://github.com/google/guava?tab=readme-ov-file  -->
<dependency>
    <!-- ç±»ä¼¼ Hutoll çš„å·¥å…·åŒ…, è¿™ä¸ªä¾èµ–æˆ‘ä»¬åé¢ç”¨å¾—åˆ° -->
    <groupId>com.google.guava</groupId>
    <artifactId>guava</artifactId>
    <version>31.1-jre</version>
</dependency>

```

```yaml
# é…ç½® nacos
nacos:
  config:
    username: nacos
    password: Qwe54188_
    server-addr: 127.0.0.1:8848 # nacos åœ°å€
    bootstrap:
      enable: true  # é¢„åŠ è½½
    data-id: workusercentre # æ§åˆ¶å°å¡«å†™çš„ Data ID
    group: DEFAULT_GROUP # æ§åˆ¶å°å¡«å†™çš„ group
    type: yaml  # é€‰æ‹©çš„æ–‡ä»¶æ ¼å¼
    auto-refresh: true # å¼€å¯è‡ªåŠ¨åˆ·æ–°

```

å› ä¸º `Nacos` é…ç½®æ–‡ä»¶çš„ç›‘å¬çš„ç²’åº¦æ¯”è¾ƒç²—ï¼Œåªèƒ½çŸ¥æ™“é…ç½®æœ‰å˜æ›´ï¼Œæ— æ³•çŸ¥æ™“æ˜¯æ–°å¢ã€åˆ é™¤è¿˜æ˜¯ä¿®æ”¹ï¼Œå› æ­¤ä¸è®ºæ˜¯é€‰æ‹©å¸ƒéš†è¿‡æ»¤å™¨è¿˜æ˜¯ `HashSet` æœ€æ–¹ä¾¿çš„å¤„ç†é€»è¾‘å°±æ˜¯é‡å»ºã€‚æˆ‘ä»¬éœ€è¦ç»™å‡ºä¸€ä¸ªå·¥å…·ç±»ç”¨æ¥é‡å»ºé…ç½®ä»¥è¯»å–é»‘åå•ï¼Œå¦å¤–ä¸€ä¸ªå·¥å…·ç±»éœ€è¦è¯»å–è¯·æ±‚çš„å…·ä½“ `IP`ã€‚

> [!IMPORTANT]
>
> è¡¥å……ï¼š`Nacos` ä» `2.4.0` ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒç›‘å¬æœåŠ¡å˜åŒ–çš„å·®å€¼ï¼Œå³å’Œä¹‹å‰ç›¸æ¯”ï¼Œæœ‰å“ªäº›å®ä¾‹è¢«æ–°å¢ç­‰ï¼Œ[å…·ä½“å¯ä»¥æŸ¥é˜…æ–‡æ¡£](https://nacos.io/docs/latest/manual/user/java-sdk/usage/?spm=5238cd80.2ef5001f.0.0.3f613b7cCiTdHo#46-%E7%9B%91%E5%90%AC%E6%9C%8D%E5%8A%A1)ã€‚

```java
package cn.com.edtechhub.workusercentre.utils;

import com.google.common.hash.BloomFilter;
import com.google.common.hash.Funnels;
import lombok.extern.slf4j.Slf4j;
import org.yaml.snakeyaml.Yaml;

import java.nio.charset.Charset;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicReference;

/**
 * é»‘åå•å·¥å…·ç±»
 *
 * @author <a href="https://github.com/limou3434">limou3434</a>
 */
@Slf4j
public class BlackIpUtils {

    /**
     * é¢„æœŸæ’å…¥æ•°é‡
     */
    private static final int EXPECTED_INSERTIONS = 10000;

    /**
     * è¯¯åˆ¤ç‡(0.1%)
     */
    private static final double FALSE_POSITIVE_PROBABILITY = 0.001;

    /**
     * å¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹
     */
    private static final AtomicReference<BloomFilter<String>> bloomFilterRef = new AtomicReference<>(createNewBloomFilter()); // ä½¿ç”¨ Guava BloomFilter å®ç°, ä½¿ç”¨åŸå­æ€§å¼•ç”¨å®¹å™¨èƒ½è®©ä½ åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹, ä»¥æ— é”çš„æ–¹å¼å®‰å…¨åœ°è¯»å–å’Œæ›¿æ¢ä¸€ä¸ªå¯¹è±¡å¼•ç”¨

    /**
     * åˆ›å»ºæ–°çš„å¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹
     */
    private static BloomFilter<String> createNewBloomFilter() {
        return BloomFilter.create(
                Funnels.stringFunnel(Charset.defaultCharset()),
                EXPECTED_INSERTIONS,
                FALSE_POSITIVE_PROBABILITY
        );
    }

    /**
     * é‡æ–°æ„å»ºé»‘åå•å¸ƒéš†è¿‡æ»¤å™¨
     */
    public static void rebuildBlackIp(String configInfo) {
        log.debug("é‡æ–°æ„å»ºé»‘åå•å¸ƒéš†è¿‡æ»¤å™¨æ—¶ä¼ å…¥çš„é…ç½®ä¿¡æ¯: {}", configInfo);
        if (configInfo == null || configInfo.trim().isEmpty()) {
            configInfo = "blackIpList: []";  // é»˜è®¤ç©ºåˆ—è¡¨
        }

        // è§£æ yaml é…ç½®
        Yaml yaml = new Yaml();
        Map<String, Object> map = yaml.load(configInfo);

        // å®‰å…¨è·å–é»‘åå•åˆ—è¡¨
        List<String> blackIpList = Optional.ofNullable(map)
                .map(m -> (List<String>) m.get("blackIpList"))
                .orElse(Collections.emptyList());

        // åˆ›å»ºæ–°çš„å¸ƒéš†è¿‡æ»¤å™¨
        BloomFilter<String> newBloomFilter = createNewBloomFilter();

        // æ·»åŠ  IP åˆ°æ–°è¿‡æ»¤å™¨
        if (blackIpList != null && !blackIpList.isEmpty()) {
            for (String ip : blackIpList) {
                if (ip != null && !ip.trim().isEmpty()) {
                    newBloomFilter.put(ip.trim());
                }
            }
        }

        // åŸå­æ€§æ›´æ–°å¼•ç”¨
        bloomFilterRef.set(newBloomFilter);
        log.debug("å¸ƒéš†è¿‡æ»¤å™¨å·²æ›´æ–°, å½“å‰é»‘åå•æ•°é‡: {}", blackIpList.size());
    }

    /**
     * åˆ¤æ–­ IP æ˜¯å¦åœ¨é»‘åå•å†…
     */
    public static boolean isBlackIp(String ip) {
        if (ip == null || ip.trim().isEmpty()) {
            return false;
        }

        boolean mightContain = bloomFilterRef.get().mightContain(ip.trim());
        log.debug("æ£€æµ‹å®¢æˆ·ç«¯ IP åœ°å€ {} æ­¤æ—¶æ˜¯å¦åœ¨é»‘åå•å†…: {}", ip, mightContain);
        return mightContain;
    }
}

```

```java
package cn.com.edtechhub.workusercentre.utils;

import lombok.extern.slf4j.Slf4j;

import javax.servlet.http.HttpServletRequest;
import java.net.InetAddress;

/**
 * åœ°å€å·¥å…·ç±»
 *
 * @author <a href="https://github.com/limou3434">limou3434</a>
 */
@Slf4j
public class IpUtils {

    /**
     * è·å–å®¢æˆ·ç«¯ IP åœ°å€æ–¹æ³•
     * åªåšäº†ç®€å•çš„åˆ¤æ–­, å¦‚æœéœ€è¦æ›´åŠ å¤æ‚çš„é€»è¾‘å°±éœ€è¦è‡ªå·±å®šåˆ¶åŒ–
     */
    public static String getIpAddress(HttpServletRequest request) {
        String ip = request.getHeader("x-forwarded-for");

        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
            if (ip.equals("127.0.0.1")) {
                // æ ¹æ®ç½‘å¡å–æœ¬æœºé…ç½®çš„ IP
                InetAddress inet = null;
                try {
                    inet = InetAddress.getLocalHost();
                } catch (Exception e) {
                    log.error("è·å–æœ¬æœº IP å¤±è´¥", e);
                }
                if (inet != null) {
                    ip = inet.getHostAddress();
                }
            }
        }
        // å¤šä¸ªä»£ç†çš„æƒ…å†µï¼Œç¬¬ä¸€ä¸ª IP ä¸ºå®¢æˆ·ç«¯çœŸå® IP, å¤šä¸ª IP æŒ‰ç…§ ',' åˆ†å‰²
        if (ip != null && ip.length() > 15) {
            if (ip.indexOf(",") > 0) {
                ip = ip.substring(0, ip.indexOf(","));
            }
        }
        if (ip == null) {
            return "127.0.0.1";
        }

        log.debug("æ£€æµ‹ä¸€æ¬¡å®¢æˆ·ç«¯çš„ IP åœ°å€: {}", ip);
        return ip;
    }

}

```

ç„¶åæˆ‘ä»¬å›åˆ°æ§åˆ¶å°ï¼Œå…¶å®æˆ‘ä»¬åˆ›å»ºå¥½é…ç½®å `Nacos` æœ‰ç»™æˆ‘ä»¬å¯¹åº”çš„ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬ç¨å¾®æ”¹é€ ä»¥ä¸‹å°±å¯ä»¥å¾—åˆ°ç›‘å¬å™¨ä»£ç ã€‚

```java
@Slf4j
@Component
public class NacosListener implements InitializingBean {

    @NacosInjected
    private ConfigService configService;

    @Value("${nacos.config.data-id}")
    private String dataId;

    @Value("${nacos.config.group}")
    private String group;

    @Override
    public void afterPropertiesSet() throws Exception {
        log.info("nacos ç›‘å¬å™¨å¯åŠ¨");

        String config = configService.getConfigAndSignListener(dataId, group, 3000L, new Listener() {
            final ThreadFactory threadFactory = new ThreadFactory() {
                private final AtomicInteger poolNumber = new AtomicInteger(1);
                @Override
                public Thread newThread(@NotNull Runnable r) {
                    Thread thread = new Thread(r);
                    thread.setName("refresh-ThreadPool" + poolNumber.getAndIncrement());
                    return thread;
                }
            };
            final ExecutorService executorService = Executors.newFixedThreadPool(1, threadFactory);

            // é€šè¿‡çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†é»‘åå•å˜åŒ–çš„é€»è¾‘
            @Override
            public Executor getExecutor() {
                return executorService;
            }

            // ç›‘å¬åç»­é»‘åå•å˜åŒ–
            @Override
            public void receiveConfigInfo(String configInfo) {
                log.info("ç›‘å¬åˆ°é…ç½®ä¿¡æ¯å˜åŒ–ï¼š{}", configInfo);
                BlackIpUtils.rebuildBlackIp(configInfo);
            }
        });
        // åˆå§‹åŒ–é»‘åå•
        BlackIpUtils.rebuildBlackIp(config);
    }
}

```

ç„¶åè¿˜éœ€è¦é»‘åå•å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆï¼Œè¿™é‡Œçš„è¯·æ±‚ä¸æ­¢æ˜¯é’ˆå¯¹ `Controller` çš„æ¥å£ï¼Œæ‰€ä»¥åº”è¯¥åŸºäº `WebFilter` å®ç°è€Œä¸æ˜¯ `AOP` åˆ‡é¢ã€‚`WebFilter` çš„ä¼˜å…ˆçº§é«˜äº `@Aspect` åˆ‡é¢ï¼Œå› ä¸ºå®ƒåœ¨æ•´ä¸ª `Web` è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­æ›´æ—©è¿›è¡Œå¤„ç†ã€‚è¯·æ±‚è¿›å…¥æ—¶çš„é¡ºåºï¼š

- **WebFilter**ï¼š`WebFilter` æ˜¯ `Spring WebFlux` ä¸­çš„è¿‡æ»¤å™¨ï¼Œæ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼ˆåŒ…æ‹¬é™æ€èµ„æºè¯·æ±‚å’Œå…¶ä»– `HTTP` è¯·æ±‚ï¼‰ï¼Œå¹¶ä¸”åœ¨è¯·æ±‚åˆ°è¾¾ä»»ä½•å¤„ç†å™¨ä¹‹å‰å°±èƒ½è¿›è¡Œæ‹¦æˆªï¼Œé€‚ç”¨äºå¯¹è¯·æ±‚çš„å…¨å±€å¤„ç†ã€‚é¦–å…ˆï¼Œ`WebFilter` æ‹¦æˆª `HTTP` è¯·æ±‚ï¼Œå¹¶å¯ä»¥æ ¹æ®é€»è¾‘å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œè¯·æ±‚ã€‚
- **Spring AOP åˆ‡é¢ï¼ˆ@Aspectï¼‰**ï¼šè€Œ `AOP`ï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ é€šå¸¸ç”¨äºæ–¹æ³•çº§åˆ«çš„åˆ‡é¢ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹ `Controller` å±‚æ–¹æ³•ï¼Œä½†æ˜¯å®ƒå¹¶ä¸ä¼šæ‹¦æˆªæ‰€æœ‰çš„ `HTTP` è¯·æ±‚ï¼Œç‰¹åˆ«æ˜¯é™æ€èµ„æºæˆ–è€…ä¸€äº›ä¸ç»è¿‡ `Controller` å¤„ç†çš„è¯·æ±‚ï¼Œå› æ­¤ä¸èƒ½æ»¡è¶³å¯¹æ‰€æœ‰è¯·æ±‚ï¼ˆåŒ…æ‹¬é™æ€èµ„æºå’Œ `API` æ¥å£ï¼‰çš„è¿‡æ»¤éœ€æ±‚ã€‚å¦‚æœè¯·æ±‚ç»è¿‡è¿‡æ»¤å™¨å¹¶è¿›å…¥ `Spring` ç®¡ç†çš„ `Bean`ï¼ˆä¾‹å¦‚ `Controller` å±‚ï¼‰ï¼Œæ­¤æ—¶åˆ‡é¢ç”Ÿæ•ˆï¼Œå¯¹åŒ¹é…çš„ `Bean` æ–¹æ³•è¿›è¡Œæ‹¦æˆªã€‚
- **Controller å±‚**ï¼šå¦‚æœ `@Aspect` æ²¡æœ‰é˜»æ­¢æ‰§è¡Œï¼Œæœ€ç»ˆè¯·æ±‚åˆ°è¾¾ `@Controller` æˆ– `@RestController` çš„æ–¹æ³•ã€‚

```java
@WebFilter(urlPatterns = "/*", filterName = "blackIpFilter")
public class BlackIpFilter implements Filter {

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {

        String ipAddress = NetUtils.getIpAddress((HttpServletRequest) servletRequest);
        if (BlackIpUtils.isBlackIp(ipAddress)) {
            servletResponse.setContentType("text/json;charset=UTF-8");
            servletResponse.getWriter().write("{\"errorCode\":\"-1\",\"errorMsg\":\"é»‘åå•IPï¼Œç¦æ­¢è®¿é—®\"}");
            return;
        }
        filterChain.doFilter(servletRequest, servletResponse);
    }

}
@WebFilter(urlPatterns = "/*", filterName = "blackIpFilter")
public class BlackIpFilter implements Filter {

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {

        String ipAddress = NetUtils.getIpAddress((HttpServletRequest) servletRequest);
        if (BlackIpUtils.isBlackIp(ipAddress)) {
            servletResponse.setContentType("text/json;charset=UTF-8");
            servletResponse.getWriter().write("{\"errorCode\":\"-1\",\"errorMsg\":\"é»‘åå•IPï¼Œç¦æ­¢è®¿é—®\"}");
            return;
        }
        filterChain.doFilter(servletRequest, servletResponse);
    }

}

```

å¾…è¡¥å……...





